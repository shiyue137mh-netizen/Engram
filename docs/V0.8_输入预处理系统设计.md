# Engram V0.8 å¼€å‘æ–‡æ¡£ - è¾“å…¥é¢„å¤„ç†ç³»ç»Ÿ

> **æœ€åæ›´æ–°**: 2026-01-10

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 æ ¸å¿ƒç†å¿µ
**è¾“å…¥é¢„å¤„ç† = ç‰¹åŒ–çš„ Regex å¤„ç†å™¨ + åŠ¨æ€æç¤ºè¯æ¨¡æ¿åˆ‡æ¢**

ä¸åŒåŠŸèƒ½æ¨¡å¼åªæ˜¯åˆ‡æ¢ä¸åŒçš„æç¤ºè¯æ¨¡æ¿ï¼Œè¾“å‡ºç»Ÿä¸€ç”¨ `<output>` æ ‡ç­¾åŒ…è£¹ï¼Œç³»ç»Ÿç»Ÿä¸€æ•è·å¤„ç†ã€‚

### 1.2 æ”¯æŒçš„åŠŸèƒ½

| æ¨¡å¼ | æç¤ºè¯æ¨¡æ¿ | è¾“å‡ºæ ‡ç­¾ | ç”¨é€” |
|------|-----------|---------|------|
| Query å¢å¼º | `query_enhance` | `<query>` | RAG æ£€ç´¢ä¼˜åŒ– |
| å‰§æƒ…æ„æ€ | `plot_director` | `<output>` | ç”Ÿæˆå¯¼æ¼”æŒ‡ä»¤ (å¦‚ `<plot>`) |
| æå†™å¢å¼º | `description` | `<output>` | è¡¥å……ç»†èŠ‚æå†™ |
| è‡ªå®šä¹‰ | ç”¨æˆ·é…ç½® | `<output>` | ä»»æ„åŠŸèƒ½ |

---

## 2. æ ¸å¿ƒæµç¨‹

```
ç”¨æˆ·è¾“å…¥
    â†“
æ‹¦æˆª (GENERATE_BEFORE_COMBINE_PROMPTS)
    â†“
é€‰æ‹©æç¤ºè¯æ¨¡æ¿ (åŠ¨æ€è¯»å–)
    â†“
LLM è°ƒç”¨
    â†“
è¾“å‡ºå¤„ç† (ç»Ÿä¸€ Regex æ•è·)
â”œâ”€â”€ åˆ é™¤ <think>...</think>
â”œâ”€â”€ æ•è· <output>...</output> â†’ æ³¨å…¥ç”¨æˆ·æ¶ˆæ¯
â””â”€â”€ [Queryæ¨¡å¼] æ•è· <query>...</query> â†’ RAG å¬å›
    â†“
ä¿®æ”¹ data.mesSendString
    â†“
ç»§ç»­æ­£å¸¸ç”Ÿæˆ
```

---

## 3. ç»Ÿä¸€è¾“å‡ºæ ¼å¼è§„èŒƒ

### 3.1 æ ‡å‡†è¾“å‡ºæ¨¡æ¿

æ— è®ºä»€ä¹ˆæ¨¡å¼çš„æç¤ºè¯ï¼Œè¾“å‡ºæ ¼å¼ç»Ÿä¸€ï¼š

```xml
<think>
... æ€è€ƒè¿‡ç¨‹ï¼ˆä¼šè¢«åˆ é™¤ï¼‰...
</think>

<output>
... å®é™…è¾“å‡ºå†…å®¹ï¼ˆä¼šè¢«æ•è·å¹¶æ³¨å…¥ç”¨æˆ·æ¶ˆæ¯ï¼‰...
</output>
```

### 3.2 Query å¢å¼ºç‰¹åŒ–

Query å¢å¼ºæ¨¡å¼éœ€è¦é¢å¤–æå–æŸ¥è¯¢å…³é”®è¯ç”¨äº RAGï¼š

```xml
<think>
... åˆ†æç”¨æˆ·æ„å›¾ ...
</think>

<query>
å…³é”®è¯1, å…³é”®è¯2, ç›¸å…³æ¦‚å¿µ
</query>

<output>
[ç”¨æˆ·æ„å›¾æ€»ç»“å’Œä¸Šä¸‹æ–‡è¡¥å……]
</output>
```

- `<query>` å†…å®¹ â†’ å‘é€ç»™ `Retriever` è¿›è¡Œå‘é‡æ£€ç´¢
- `<output>` å†…å®¹ â†’ æ³¨å…¥ç”¨æˆ·æ¶ˆæ¯

---

## 4. ç³»ç»Ÿæ¶æ„

### 4.1 æ ¸å¿ƒç»„ä»¶ï¼ˆç²¾ç®€ç‰ˆï¼‰

```
src/services/preprocessing/
â”œâ”€â”€ Preprocessor.ts       # æ ¸å¿ƒé¢„å¤„ç†å™¨ (å”¯ä¸€é€»è¾‘ç±»)
â”œâ”€â”€ OutputParser.ts       # ç»Ÿä¸€è¾“å‡ºè§£æ (Regex æ•è·)
â””â”€â”€ types.ts              # ç±»å‹å®šä¹‰
```

### 4.2 æ•°æ®ç»“æ„

```typescript
// é¢„å¤„ç†é…ç½®
interface PreprocessingConfig {
    enabled: boolean;
    templateId: string;      // å½“å‰ä½¿ç”¨çš„æç¤ºè¯æ¨¡æ¿ ID
    autoTrigger: boolean;    // æ˜¯å¦è‡ªåŠ¨è§¦å‘
}

// è¾“å‡ºè§£æç»“æœ
interface ParsedOutput {
    output: string | null;   // <output> å†…å®¹
    query: string | null;    // <query> å†…å®¹ (ä»… Query å¢å¼ºæ¨¡å¼)
    raw: string;             // åŸå§‹è¾“å‡º (å·²æ¸…ç† <think>)
}
```

### 4.3 OutputParser å®ç°

```typescript
// services/preprocessing/OutputParser.ts
export class OutputParser {
    /**
     * ç»Ÿä¸€è¾“å‡ºè§£æ
     * 1. åˆ é™¤ <think>...</think>
     * 2. æ•è· <output>...</output>
     * 3. æ•è· <query>...</query> (å¯é€‰)
     */
    static parse(rawOutput: string): ParsedOutput {
        // åˆ é™¤ think æ ‡ç­¾
        let cleaned = rawOutput.replace(/<think>[\s\S]*?<\/think>/gi, '');
        
        // æ•è· output
        const outputMatch = cleaned.match(/<output>([\s\S]*?)<\/output>/i);
        const output = outputMatch?.[1]?.trim() || null;
        
        // æ•è· query (Query å¢å¼ºæ¨¡å¼ä¸“ç”¨)
        const queryMatch = cleaned.match(/<query>([\s\S]*?)<\/query>/i);
        const query = queryMatch?.[1]?.trim() || null;
        
        return { output, query, raw: cleaned.trim() };
    }
}
```

---

## 5. UI è®¾è®¡

### 5.1 å¿«æ·é¢æ¿æ¶æ„

#### è®¾è®¡åŸåˆ™
1. **ç‹¬ç«‹äºä¸»é¢æ¿**ï¼šæ‚¬æµ®é¢æ¿å¯æ‹–æ‹½
2. **ä½¿ç”¨é€šç”¨ Modal**ï¼šé€šè¿‡ `components/ui/Modal.tsx` æ§åˆ¶
3. **æ³¨å…¥ QR æ **ï¼šåœ¨é…’é¦†è¾“å…¥æ¡†ä¸Šæ–¹æ³¨å…¥å¼€å¯æŒ‰é’®

#### ç»„ä»¶å±‚çº§
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QuickPanel (æ‚¬æµ®é¢æ¿)                â”‚
â”‚  â”œâ”€â”€ å¯æ‹–æ‹½å¤´éƒ¨                      â”‚
â”‚  â”œâ”€â”€ æ¨¡å¼åˆ‡æ¢                        â”‚
â”‚  â””â”€â”€ å¿«æ·é…ç½®                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘ é€šè¿‡ Modal.tsx æ¸²æŸ“
         
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QR æ æŒ‰é’® (æ³¨å…¥åˆ° #send_form)        â”‚
â”‚  â””â”€â”€ ç‚¹å‡»æ‰“å¼€ QuickPanel             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 QR æ æŒ‰é’®æ³¨å…¥

é…’é¦†çš„è¾“å…¥æ ç»“æ„ï¼š
```html
<div id="send_form">
  <!-- QR æ‰©å±•åœ¨è¿™é‡Œæ³¨å…¥æŒ‰é’® -->
  <div id="nonQRFormItems">
    <textarea id="send_textarea">...</textarea>
  </div>
</div>
```

**æ³¨å…¥æ–¹å¼** (å‚è€ƒ `quick-reply/ButtonUi.js`)ï¼š
```typescript
// tavern/QuickPanelButton.ts
export function injectQuickPanelButton() {
    const sendForm = document.querySelector('#send_form');
    if (!sendForm) return;
    
    // åˆ›å»º Engram å¿«æ·æŒ‰é’®
    const button = document.createElement('div');
    button.id = 'engram-quick-panel-trigger';
    button.className = 'menu_button fa-solid fa-brain';
    button.title = 'Engram å¿«æ·é¢æ¿';
    button.addEventListener('click', () => {
        // æ‰“å¼€ QuickPanel Modal
        openQuickPanel();
    });
    
    // æ’å…¥åˆ° #send_form çš„é¦–ä¸ªå­å…ƒç´ å‰
    if (sendForm.children.length > 0) {
        sendForm.children[0].insertAdjacentElement('beforebegin', button);
    } else {
        sendForm.append(button);
    }
}
```

### 5.3 æ‚¬æµ®é¢æ¿è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â‰¡ Engram å¿«æ·é¢æ¿                    [Ã—] â”‚ â† å¯æ‹–æ‹½
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚ ğŸ”§ è¾“å…¥é¢„å¤„ç†                      [ON]  â”‚
â”‚                                          â”‚
â”‚ å½“å‰æ¨¡å¼ï¼š                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ ğŸ” Query   â”‚ â”‚ ğŸ“– å‰§æƒ…    â”‚           â”‚
â”‚ â”‚   å¢å¼º     â”‚ â”‚   æ„æ€     â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ âœï¸ æå†™    â”‚ â”‚ âš™ï¸ è‡ªå®šä¹‰  â”‚           â”‚
â”‚ â”‚   å¢å¼º     â”‚ â”‚            â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                          â”‚
â”‚ [ç¼–è¾‘æ¨¡æ¿]                               â”‚
â”‚                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’¾ RAG çŠ¶æ€                              â”‚
â”‚ æ´»è·ƒäº‹ä»¶: 5 | å½’æ¡£: 23                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.4 åŠ¨æ€æ¨¡æ¿è¯»å–

UI ä» `PromptTemplateList` è¯»å– `category: 'preprocessing'` çš„æ¨¡æ¿ï¼š

```typescript
const preprocessingTemplates = templates.filter(t => t.category === 'preprocessing');
```

### 5.5 æ‰©å±•æ€§

å¿«æ·é¢æ¿ä¸ä»…ç”¨äºé¢„å¤„ç†ï¼Œå¯æ‰©å±•ï¼š
- RAG çŠ¶æ€ç›‘æ§
- å¿«æ·æ€»ç»“è§¦å‘
- dashboardç›‘æ§
- å…¶ä»– Engram åŠŸèƒ½å¿«æ·å…¥å£

---

## 6. ä¸ RAG çš„é›†æˆ

### 6.1 Query å¢å¼º â†’ RAG å¬å›æµç¨‹

```
ç”¨æˆ·è¾“å…¥ "æˆ‘ä»¬ä¹‹å‰çº¦å®šçš„é‚£ä»¶äº‹"
    â†“
Preprocessor è°ƒç”¨ LLM (query_enhance æ¨¡æ¿)
    â†“
è¾“å‡º:
<query>çº¦å®š, æ‰¿è¯º, ä¹‹å‰çš„å¯¹è¯</query>
<output>ç”¨æˆ·æåŠä¹‹å‰çš„çº¦å®šï¼Œéœ€è¦å›é¡¾ç›¸å…³è®°å¿†</output>
    â†“
OutputParser.parse()
â”œâ”€â”€ query: "çº¦å®š, æ‰¿è¯º, ä¹‹å‰çš„å¯¹è¯"
â””â”€â”€ output: "ç”¨æˆ·æåŠä¹‹å‰çš„çº¦å®šï¼Œéœ€è¦å›é¡¾ç›¸å…³è®°å¿†"
    â†“
Retriever.vectorSearch(query) â†’ recalledIds[]
    â†“
MacroService.refreshCache(recalledIds)
    â†“
data.mesSendString += <engram_context>...</engram_context>
```

### 6.2 é Query æ¨¡å¼

ç›´æ¥å°† `<output>` å†…å®¹è¿½åŠ åˆ°ç”¨æˆ·æ¶ˆæ¯ï¼š

```
ç”¨æˆ·è¾“å…¥ â†’ LLM (plot_director) â†’ <output>å¯¼æ¼”æŒ‡ä»¤</output>
    â†“
data.mesSendString += <engram_context>å¯¼æ¼”æŒ‡ä»¤</engram_context>
```

---

## 7. å®ç°è®¡åˆ’

### Phase 1: æ ¸å¿ƒé¢„å¤„ç†å™¨
- [ ] åˆ›å»º `Preprocessor.ts`
- [ ] åˆ›å»º `OutputParser.ts` (ç»Ÿä¸€ Regex æ•è·)
- [ ] ä¿®æ”¹ `Injector.ts` é›†æˆé¢„å¤„ç†

### Phase 2: æç¤ºè¯æ¨¡æ¿
- [ ] åœ¨ `PromptTemplateList` æ·»åŠ  `category: 'preprocessing'`
- [ ] åˆ›å»ºå†…ç½®æ¨¡æ¿ï¼š`query_enhance`, `plot_director`

### Phase 3: UI - QR æ æŒ‰é’®
- [ ] åˆ›å»º `tavern/QuickPanelButton.ts`
- [ ] åœ¨ `#send_form` æ³¨å…¥å¼€å¯æŒ‰é’®
- [ ] åœ¨ `main.tsx` åˆå§‹åŒ–æ—¶è°ƒç”¨

### Phase 4: UI - æ‚¬æµ®é¢æ¿
- [ ] åˆ›å»º `views/QuickPanel/QuickPanel.tsx`
- [ ] ä½¿ç”¨ `Modal.tsx` æ¸²æŸ“
- [ ] å®ç°æ‹–æ‹½åŠŸèƒ½
- [ ] åŠ¨æ€è¯»å–é¢„å¤„ç†æ¨¡æ¿

### Phase 5: RAG é›†æˆ
- [ ] å®ç° `<query>` æ•è· â†’ å‘é‡æ£€ç´¢
- [ ] `recalledIds` ä¼ é€’ç»™ `MacroService.refreshCache()`

---

## 8. å‚è€ƒèµ„æ–™

- [é…’é¦† QR æŒ‰é’®å®ç°](SillyTavern/scripts/extensions/quick-reply/src/ui/ButtonUi.js)
- [å‰§æƒ…æ„æ€æ¨¡æ¿ç¤ºä¾‹](test/SIllytavernæç¤ºè¯_Structured.xml)
- [ç°æœ‰ RegexProcessor](src/services/pipeline/RegexProcessor.ts)
- [Modal ç»„ä»¶](src/components/ui/Modal.tsx)


