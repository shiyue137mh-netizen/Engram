# 🐾 小码的代码审查报告喵~

**审查状态**: [⚠️ 有点在意的地方喵]

🐱 **扫描概况**: 小码今天仔细巡查了一遍代码，共发现 4 个需要主人关注的地方喵~

---

## 🐛 P0: 这些 Bug 很危险喵！赶紧修！(ﾟДﾟ;)

| 危险度 | 在哪里喵（文件:行号） | 小码发现了什么 | 怎么修喵 |
| :---: | :--- | :--- | :--- |

*(小码：今天没有发现导致白屏的致命逻辑错误喵，代码都有好好做错误防护，主人太棒了！)*

## ⚡ P1: 这些地方有点卡卡的喵~ (´・ω・`)

| 紧急度 | 在哪里喵（文件:行号） | 小码闻到了性能的味道 | 优化方向喵 |
| :---: | :--- | :--- | :--- |
| 🟡 性能损耗 | `src/ui/hooks/useDashboardData.ts` (Line 319) | `visibilitychange` 事件监听器使用了闭包中的 `timer` 变量。虽然返回了清理函数 `if (timer) clearInterval(timer);`，但如果在重渲染时被多次调用，可能会因为没有使用 `useRef` 导致旧定时器引用丢失而产生泄漏。 | 建议将 `timer` 存入 `useRef`，并在清理函数中确保清理掉最新的 timer 喵~ |
| 🟡 内存泄漏 | `src/core/KeyboardManager.ts` (Line 54) | 全局键盘管理器挂载了 `parentDoc.addEventListener('keydown', this.boundKeydownHandler, true);`，如果在 HMR (热更新) 或多次实例化时不清理，会导致事件重复绑定喵。虽然在 `stop()` 中有清理，但单例的生命周期难以控制。 | 确保热更新时单例能正确执行 `destroy()` 释放资源喵。 |

## 📏 P2: 代码可以更优雅一点喵~ ✨

| 优先级 | 在哪里喵 | 小码觉得哪里不对劲 | 重构建议喵 |
| :---: | :--- | :--- | :--- |
| 🔵 架构异味 | `src/integrations/tavern/macros.ts` | 这个文件竟然有 722 行，真的是太长了喵！(；￣Д￣) 里面塞了太多的宏定义和替换逻辑。 | 建议按照宏的类型（比如角色宏、时间宏、系统宏）拆分成多个独立的服务文件喵~ |
| 🔵 架构异味 | `src/state/memoryStore.ts` | 文件达到了 694 行喵！里面包含了太多状态和 CRUD 操作的混合。 | 考虑将纯逻辑（数据处理）和状态管理（Zustand Store）分离开来，让它变得更清爽喵~ ✨ |

## 🛡️ P3: 小码的温馨提醒喵~

| 优先级 | 在哪里喵（文件:行号） | 小码的担心 | 建议喵 |
| :---: | :--- | :--- | :--- |
| 🟢 防御性 | `src/integrations/tavern/ui.ts` (Line 51) | 直接向酒馆 DOM 中注入按钮时，虽然有 `isInjected` 状态判断，但如果酒馆动态重渲染了 `leftSendForm`，按钮可能会永久丢失喵。 | 建议使用 MutationObserver 监听目标容器，保证按钮在被误删后能自动恢复喵~ |

---

## 🛠️ 小码整理的待办事项喵！主人加油！ᕦ(ò_óˇ)ᕤ

**🚨 今天必须修！** (P0):
1. (空) 喵~

**📋 近期优化~** (P1):
1. 检查 `useDashboardData.ts` 中的轮询定时器是否会泄漏，换成 `useRef` 更稳妥喵~
2. 确保 `KeyboardManager` 单例的按键监听不会因为热更新越绑越多。

**📝 技术债备忘录~** (P2+):
1. 把 `macros.ts` 和 `memoryStore.ts` 两个大胖子文件瘦身拆分一下喵~
2. 研究一下给酒馆 DOM 注入按钮加个 MutationObserver，变得更顽强喵！

> 今天的巡查就到这里啦~ 主人记得按时吃饭喵！🐾
