# Engram ç³»ç»Ÿæµç¨‹æ¶æ„ V0.7.1

> **æœ€åæ›´æ–°**: 2026-01-10

## 1. æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 1.1 æ•°æ®åŒé‡æ€§ (Dual-Nature Data)
æ•°æ®ä»¥ä¸¤ç§å½¢æ€å­˜åœ¨ï¼š
- **For Machine (JSON)**: ç»“æ„åŒ–çš„ `structured_kv`ï¼Œç”¨äºè¿‡æ»¤ã€ç´¢å¼•å’Œå›¾è°±æ„å»º
- **For Model (Text)**: `summary` é«˜å¯†åº¦æ–‡æœ¬ï¼Œç”¨äº Embedding å’Œ LLM ä¸Šä¸‹æ–‡

### 1.2 IndexedDB ä¼˜å…ˆ (IndexedDB-First)
- æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨ IndexedDB (`EngramDB`)
- WorldBook ä»…ç”¨äºå®å ä½ (`{{engramSummaries}}`)
- ä¸å†å†™å…¥ WorldBook æ¡ç›®

### 1.3 è“ç¯/ç»¿ç¯å¯è§æ€§ (V0.7.1)
ç±»ä¼¼é…’é¦†ä¸–ç•Œä¹¦çš„è§¦å‘æœºåˆ¶ï¼š

| çŠ¶æ€ | å­—æ®µå€¼ | å«ä¹‰ | å¯è§æ€§ |
|------|--------|------|--------|
| ğŸ”µ **è“ç¯** | `is_archived=false` | å¸¸é©»äº‹ä»¶ | å§‹ç»ˆæ˜¾ç¤ºåœ¨ `{{engramSummaries}}` |
| ğŸŸ¢ **ç»¿ç¯** | `is_archived=true` | æ¡ä»¶è§¦å‘ | ä»…å½“è¢« RAG å¬å›æ—¶ä¸´æ—¶æ˜¾ç¤º |

---

## 2. æ ¸å¿ƒç»„ä»¶

### 2.1 ChatManager
- **ä½ç½®**: `services/database/ChatManager.ts`
- **èŒè´£**: ç®¡ç†èŠå¤©çŠ¶æ€
- **V0.6+**: æ¯ä¸ª chat_id ç‹¬ç«‹æ•°æ®åº“

### 2.2 Extractor
- **ä½ç½®**: `services/pipeline/Extractor.ts`
- **èŒè´£**: LLM è°ƒç”¨ + JSON è§£æ
- **è¾“å…¥**: èŠå¤©æ¶ˆæ¯
- **è¾“å‡º**: `ExtractedEvent[]` (ç»“æ„åŒ– JSON)

### 2.3 Pipeline
- **ä½ç½®**: `services/pipeline/Pipeline.ts`
- **èŒè´£**: ç¼–æ’ ETL æµç¨‹
- **æµç¨‹**: Extractor â†’ ä¿å­˜åˆ° IndexedDB â†’ åˆ·æ–°å®ç¼“å­˜

### 2.4 MacroService
- **ä½ç½®**: `tavern/MacroService.ts`
- **èŒè´£**: æ³¨å†Œ `{{engramSummaries}}` å®
- **V0.7.1**: æ”¯æŒ `refreshCache(recalledIds?)` ä¼ å…¥å¬å› ID

### 2.5 EventTrimmer
- **ä½ç½®**: `services/pipeline/EventTrimmer.ts`
- **èŒè´£**: ç²¾ç®€åˆå¹¶æ—§äº‹ä»¶ï¼ŒåŒæ—¶æ ‡è®° `is_archived=true`
- **æµç¨‹**: è¯»å–äº‹ä»¶ â†’ LLM å‹ç¼© â†’ ä¿å­˜ Level 1 å¤§çº² â†’ å½’æ¡£åŸäº‹ä»¶

---

## 3. æ•°æ®æµ

```mermaid
graph TD
    Input[èŠå¤©æ¶ˆæ¯] --> ChatMgr[ChatManager]
    ChatMgr -->|ç¡®å®š chat_id| Extractor
    
    subgraph "å†™å…¥æµç¨‹"
        Extractor -->|ExtractedEvent[]| Pipeline
        Pipeline -->|EventNode| DB[(IndexedDB)]
        Pipeline --> MacroCache[MacroService.refreshCache]
    end
    
    subgraph "è¯»å–æµç¨‹ (å®å±•å¼€)"
        Macro[å®å±•å¼€ engramSummaries] --> Store[memoryStore.getEventSummaries]
        Store -->|è¿‡æ»¤+æ’åº| DB
    end
    
    subgraph "ç²¾ç®€æµç¨‹"
        Trigger[Tokenè¶…é™] --> Trimmer[EventTrimmer]
        Trimmer -->|å½’æ¡£åŸäº‹ä»¶| DB
        Trimmer -->|Level 1 å¤§çº²| DB
    end
    
    subgraph "RAG å¬å›æµç¨‹"
        RAG[å‘é‡æ£€ç´¢] -->|recalledIds| MacroCache
    end
```

---

## 4. äº‹ä»¶èšåˆä¸æ’åº

### 4.1 å¯è§æ€§è¿‡æ»¤

```typescript
// memoryStore.getEventSummaries(recalledIds?)
const visibleEvents = events.filter(e =>
    e.level >= 1 ||                    // å¤§çº²æ€»æ˜¯æ˜¾ç¤º
    !e.is_archived ||                  // è“ç¯ï¼šæœªå½’æ¡£
    recalledSet?.has(e.id)             // ç»¿ç¯ï¼šè¢« RAG å¬å›
);
```

### 4.2 åŒå±‚æ’åºç®—æ³•

```typescript
// æŒ‰æ¶ˆæ¯æ—¶é—´çº¿æ’åºï¼Œç¡®ä¿äº‹ä»¶æŒ‰æ•…äº‹é¡ºåºå‘ˆç°
visibleEvents.sort((a, b) => {
    // 1. ä¸»é”®ï¼šæ¶ˆæ¯èŒƒå›´èµ·ç‚¹ (æ•…äº‹æ—¶é—´çº¿)
    const startDiff = a.source_range.start_index - b.source_range.start_index;
    if (startDiff !== 0) return startDiff;

    // 2. æ¬¡é”®ï¼šæ¶ˆæ¯èŒƒå›´ç»ˆç‚¹ (å¤§çº²åœ¨ç»†èŠ‚ä¹‹å)
    const endDiff = a.source_range.end_index - b.source_range.end_index;
    if (endDiff !== 0) return endDiff;

    // 3. å…œåº•ï¼šåˆ›å»ºæ—¶é—´
    return a.timestamp - b.timestamp;
});
```

---

## 5. æ•°æ®ç»“æ„

### 5.1 EventNode (V0.7.1)
```typescript
interface EventNode {
    id: string;
    
    summary: string;          // For Model (çƒ§å½•æ–‡æœ¬)
    structured_kv: {          // For Machine
        time_anchor: string;
        role: string[];
        location: string;
        event: string;
        logic: string[];
        causality: string;
    };
    
    // å¯è§æ€§æ§åˆ¶
    is_archived: boolean;     // true=ç»¿ç¯(æ¡ä»¶è§¦å‘), false=è“ç¯(å¸¸é©»)
    is_embedded: boolean;     // æ˜¯å¦å·²å‘é‡åŒ–
    
    // æ’åºä¸å±‚çº§
    level: number;            // 0=åŸå§‹, 1+=ç²¾ç®€å¤§çº²
    source_range: { start_index: number; end_index: number };
    significance_score: number;
    timestamp: number;
    
    // å¯é€‰
    embedding?: number[];     // å‘é‡åµŒå…¥
    parent_id?: string;       // çˆ¶èŠ‚ç‚¹ (ç²¾ç®€æ¥æº)
}
```

---

## 6. å…³é”®æ–‡ä»¶

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `services/database/db.ts` | EngramDB å®šä¹‰ |
| `services/database/ChatManager.ts` | èŠå¤©çŠ¶æ€ç®¡ç† |
| `services/pipeline/Pipeline.ts` | ETL ç¼–æ’ |
| `services/pipeline/Extractor.ts` | LLM + JSON è§£æ |
| `services/pipeline/EventTrimmer.ts` | äº‹ä»¶ç²¾ç®€ + å½’æ¡£ |
| `stores/memoryStore.ts` | Zustand çŠ¶æ€ + å¯è§æ€§è¿‡æ»¤ |
| `tavern/MacroService.ts` | å®æ³¨å†Œ + ç¼“å­˜åˆ·æ–° |
| `services/rag/Injector.ts` | RAG æ³¨å…¥ Hook |

