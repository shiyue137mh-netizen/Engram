# Engram ç³»ç»Ÿæµç¨‹æ¶æ„ V0.9.9

> **æœ€åæ›´æ–°**: 2026-01-18 (Layered Modular Architecture)

## 1. æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 1.1 æ•°æ®åŒé‡æ€§ (Dual-Nature Data)
æ•°æ®ä»¥ä¸¤ç§å½¢æ€å­˜åœ¨ï¼š
- **For Machine (JSON)**: ç»“æ„åŒ–çš„ `structured_kv`ï¼Œç”¨äºè¿‡æ»¤ã€ç´¢å¼•å’Œå›¾è°±æ„å»º
- **For Model (Text)**: `summary` é«˜å¯†åº¦æ–‡æœ¬ï¼Œç”¨äº Embedding å’Œ LLM ä¸Šä¸‹æ–‡

### 1.2 IndexedDB ä¼˜å…ˆ (IndexedDB-First)
- æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨ IndexedDB (`EngramDB`)
- WorldBook ä»…ç”¨äºå®å ä½ (`{{engramSummaries}}`)
- ä¸å†å†™å…¥ WorldBook æ¡ç›®

### 1.3 è“ç¯/ç»¿ç¯å¯è§æ€§ (V0.7.1)
ç±»ä¼¼é…’é¦†ä¸–ç•Œä¹¦çš„è§¦å‘æœºåˆ¶ï¼š

| çŠ¶æ€ | å­—æ®µå€¼ | å«ä¹‰ | å¯è§æ€§ |
|------|--------|------|--------|
| ğŸ”µ **è“ç¯** | `is_archived=false` | å¸¸é©»äº‹ä»¶ | å§‹ç»ˆæ˜¾ç¤ºåœ¨ `{{engramSummaries}}` |
| ğŸŸ¢ **ç»¿ç¯** | `is_archived=true` | æ¡ä»¶è§¦å‘ | ä»…å½“è¢« RAG å¬å›æ—¶ä¸´æ—¶æ˜¾ç¤º |

---

## 2. æ ¸å¿ƒç»„ä»¶ (Decoupled Architecture)

Engram é‡‡ç”¨ **Service Facade -> Workflow Engine -> Steps** çš„è§£è€¦æ¶æ„ã€‚

### 2.1 Service Layer (Services)
- **ä½ç½®**: `src/modules/*/Services` (å¦‚ `Summarizer.ts`, `EventTrimmer.ts`)
- **èŒè´£**: ä¸šåŠ¡å…¥å£ï¼Œè´Ÿè´£è°ƒåº¦å·¥ä½œæµã€‚ä¸åŒ…å«å…·ä½“ä¸šåŠ¡é€»è¾‘ã€‚
- **æ¨¡å¼**: Facade æ¨¡å¼ã€‚æ¥æ”¶ UI/Event è¯·æ±‚ï¼Œç»„è£…å‚æ•°ï¼Œè°ƒç”¨ Workflow Engineã€‚

### 2.2 Workflow Engine (Core)
- **ä½ç½®**: `src/modules/workflow/core/WorkflowEngine.ts`
- **èŒè´£**: å·¥ä½œæµæ‰§è¡Œå¼•æ“ã€‚
- **åŠŸèƒ½**: æ‰§è¡ŒåŸºäºå›¾ (Graph) å®šä¹‰çš„ `GraphWorkflow`ã€‚ç®¡ç† Step ä¾èµ–ã€å¹¶å‘æ‰§è¡Œå’ŒçŠ¶æ€ä¼ é€’ã€‚

### 2.3 Workflow Definitions (Definitions)
- **ä½ç½®**: `src/modules/workflow/definitions/*.ts` (å¦‚ `SummaryWorkflow.ts`, `EntityWorkflow.ts`)
- **èŒè´£**: å®šä¹‰ä¸šåŠ¡æµç¨‹çš„æ‹“æ‰‘ç»“æ„ (Steps & Edges)ã€‚å£°æ˜å¼çš„æµç¨‹å®šä¹‰ã€‚

### 2.4 Workflow Steps (Steps)
- **ä½ç½®**: `src/modules/workflow/steps/*`
- **èŒè´£**: æœ€å°æ‰§è¡Œå•å…ƒã€‚
- **ç±»å‹**:
    - **Context Steps**: è·å–ä¸Šä¸‹æ–‡ (å¦‚ `FetchChatHistory`)
    - **LLM Steps**: è°ƒç”¨ AI (å¦‚ `GenerateSummary`)
    - **Processing Steps**: æ•°æ®å¤„ç† (å¦‚ `CleanRegex`)
    - **Persistence Steps**: æ•°æ®åº“æ“ä½œ (å¦‚ `SaveEvent`)

### 2.5 Prompt System (YAML)
- **ä½ç½®**: `src/integrations/llm/prompts/*.yaml`
- **èŒè´£**: ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æç¤ºè¯ã€‚
- **åŠ è½½**: é€šè¿‡ `PromptLoader` åŠ è½½ï¼Œæ”¯æŒçƒ­æ›´æ–°ã€‚

---

## 3. æ•°æ®æµ (Workflow-Based)

```mermaid
graph TD
    Input[èŠå¤©æ¶ˆæ¯/è§¦å‘å™¨] --> Service[Service Facade]
    Service -->|Input Context| WF_Engine[Workflow Engine]

    subgraph "Workflow Execution"
        WF_Engine -->|Load| Def[Workflow Definition]
        Def -->|Web| Step1[Step: Context Fetching]
        Step1 --> Step2[Step: LLM Generation]
        Step2 --> Step3[Step: Post Processing]
        Step3 --> Step4[Step: Persistence]
    end

    subgraph "Resources"
        Step1 -.-> DB[(IndexedDB)]
        Step2 -.-> Prompts[YAML Prompts]
        Step2 -.-> LLM[LLM Adapter]
    end

    Step4 -->|EventNode| DB
    Step4 -->|Refresh| Macro[Macro Cache]
```

### 3.1 å…¸å‹æµç¨‹ï¼šæ€»ç»“ (Summarization)
1. **Trigger**: `SummarizerService` æ”¶åˆ°æ–°æ¶ˆæ¯ã€‚
2. **Facade**: è°ƒç”¨ `WorkflowEngine.run(summaryWorkflow, input)`ã€‚
3. **Steps**:
   - `FetchChatHistory`: ä» DB è·å–å¯¹è¯ã€‚
   - `GenerateSummary`: åŠ è½½ `summary.yaml`ï¼Œè°ƒç”¨ LLMã€‚
   - `CleanRegex`: ä½¿ç”¨ `RegexProcessor` æ¸…æ´—ã€‚
   - `SaveEvent`: å­˜å…¥ DB (Level 0)ã€‚

### 3.2 å…¸å‹æµç¨‹ï¼šå®ä½“æå– (Entity Extraction)
1. **Trigger**: `EntityExtractor` (Service) è§¦å‘ã€‚
2. **Facade**: è°ƒç”¨ `WorkflowEngine.run(entityWorkflow, input)`ã€‚
3. **Steps**:
   - `FetchValidText`: è·å–ç”¨äºæå–çš„æ–‡æœ¬ã€‚
   - `ExtractEntities`: åŠ è½½ `entity_extraction.yaml`ï¼Œè°ƒç”¨ LLMã€‚
   - `SaveEntity`: å­˜å…¥/æ›´æ–° EntityNodeã€‚

### 3.3 å…¸å‹æµç¨‹ï¼šç²¾ç®€ (Trimming)
1. **Trigger**: `EventTrimmer` æ£€æµ‹åˆ° Token è¶…é™ã€‚
2. **Step**: (ç›®å‰ EventTrimmer ä»ä¿ç•™éƒ¨åˆ†å†…éƒ¨é€»è¾‘ï¼Œæœªæ¥å°†è¿ç§»è‡³ Workflow)
   - åŠ è½½ `trim.yaml`ã€‚
   - è°ƒç”¨ LLM å‹ç¼©ã€‚
   - ä¿å­˜ Level 1 èŠ‚ç‚¹ã€‚
   - å½’æ¡£æ—§èŠ‚ç‚¹ã€‚

---

## 4. äº‹ä»¶èšåˆä¸æ’åº

### 4.1 å¯è§æ€§è¿‡æ»¤

```typescript
// memoryStore.getEventSummaries(recalledIds?)
const visibleEvents = events.filter(e =>
    e.level >= 1 ||                    // å¤§çº²æ€»æ˜¯æ˜¾ç¤º
    !e.is_archived ||                  // è“ç¯ï¼šæœªå½’æ¡£
    recalledSet?.has(e.id)             // ç»¿ç¯ï¼šè¢« RAG å¬å›
);
```

### 4.2 ç»ˆææ—¶åºè£…é…ç®—æ³• (The -1ms Override, V1.5)

```typescript
// å½»åº•æ‘’å¼ƒ Source_Range ä¸åŒå±‚æ’ä½ï¼Œåˆ©ç”¨æ¯«ç§’çº§ Unix ç‰©ç†æ—¶é—´ç‹¬å å ä½
visibleEvents.sort((a, b) => {
    // è·¨å·ã€èåˆå¤šåº“çš„å”¯ä¸€ç‹é“å±æ€§ï¼šç»å¯¹å‘ç”Ÿæ—¶é—´
    // é€»è¾‘ï¼šç”±äºæ–°ç”Ÿæˆçš„å¤§çº² (LV1+) åœ¨å­˜å‚¨æ—¶å°†è¢«å¼ºè¡Œæˆªå–å®ƒæ‰€å±å­èŠ‚ç‚¹ä¸­ã€æœ€æ—©æ—¶åˆ» - 1 æ¯«ç§’ã€‘ï¼Œ
    // å¤§çº²èŠ‚ç‚¹åœ¨æ’åºä¸­æ°¸è¿œä¼šå¦‚ç¥è°•èˆ¬é™ä¸´åœ¨å…¶æ‰€æœ‰å‘ç”Ÿäº‹ä»¶çš„æœ€å‰æ–¹ï¼Œä¸”æ°¸ä¸é‡å è¶Šä½ã€‚
    return a.timestamp - b.timestamp;
});
```

---

## 5. æ•°æ®ç»“æ„

### 5.1 EventNode (V0.7+)

**V0.6+ å¤šæ•°æ®åº“æ¶æ„**: æ¯ä¸ª `chat_id` ç‹¬ç«‹æ•°æ®åº“ï¼Œä¸å†éœ€è¦ `scope_id`ã€‚

```typescript
// å®šä¹‰ä½ç½®: src/core/types/memory.ts (æˆ– modules/memory/types.ts)
interface EventNode {
    id: string;               // UUID

    summary: string;          // For Model (çƒ§å½•æ–‡æœ¬ï¼Œç”¨äº Embedding å’Œ RAG)
    structured_kv: {          // For Machine (ç»“æ„åŒ–æŸ¥è¯¢)
        time_anchor: string;
        role: string[];
        location: string;
        event: string;
        logic: string[];
        causality: string;
    };

    // å‘é‡åŒ–
    embedding?: number[];     // è¯­ä¹‰å‘é‡ (å¯é€‰)
    is_embedded: boolean;     // æ˜¯å¦å·²å‘é‡åŒ–

    // å¯è§æ€§æ§åˆ¶
    is_archived: boolean;     // true=ğŸŸ¢ç»¿ç¯(æ¡ä»¶è§¦å‘), false=ğŸ”µè“ç¯(å¸¸é©»)

    // æ’åºä¸å±‚çº§
    level: number;            // 0=åŸå§‹, 1+=ç²¾ç®€å±‚çº§
    source_range: { start_index: number; end_index: number };
    significance_score: number;
    timestamp: number;

    // å¯é€‰
    parent_id?: string;       // çˆ¶èŠ‚ç‚¹ (ç²¾ç®€æ¥æº)
}
```

### 5.2 EntityNode & ScopeState

```typescript
// EntityNode - å®ä½“èŠ‚ç‚¹
interface EntityNode {
    id: string;
    name: string;
    type: EntityType;         // 'char' | 'loc' | 'item' | 'concept' | 'unknown'
    aliases: string[];        // åˆ«ååˆ—è¡¨ (MultiEntryç´¢å¼•)
    description: string;      // [For Model] YAML çƒ§å½•æ–‡æœ¬
    profile: Record<string, unknown>;  // [For Machine] å¼€æ”¾å¼ KV å®¹å™¨
    last_updated_at: number;
    layout_x?: number;        // å›¾è°±å¸ƒå±€åæ ‡
    layout_y?: number;
}

// ScopeState - èŠå¤©çŠ¶æ€
interface ScopeState {
    last_summarized_floor: number;
    token_usage_accumulated: number;
    last_compressed_at: number;
    active_summary_order: number;
    last_extracted_floor: number;
}
```

---

## 6. å…³é”®æ–‡ä»¶ç´¢å¼•

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `src/data/db.ts` | EngramDB (Dexie) å®šä¹‰ |
| `src/data/ChatManager.ts` | èŠå¤©çŠ¶æ€ç®¡ç† |
| `src/modules/workflow/core/WorkflowEngine.ts` | ä¸šåŠ¡é€»è¾‘ç¼–æ’å¼•æ“ |
| `src/modules/memory/EntityExtractor.ts` | å®ä½“æå–é—¨é¢ |
| `src/modules/rag/retrieval/BrainRecallCache.ts` | ç±»è„‘å¬å›æ±  (Working/ShortTerm Memory) |
| `src/state/memoryStore.ts` | Zustand çŠ¶æ€ + å¯è§æ€§è¿‡æ»¤ |
| `src/integrations/tavern/macros.ts` | å®æ³¨å†Œ + ç¼“å­˜åˆ·æ–° |
| `src/integrations/tavern/worldbook/index.ts` | ä¸–ç•Œä¹¦åŒæ­¥é›†æˆæœåŠ¡ |

