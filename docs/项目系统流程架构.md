# Engram 系统流程架构 V0.5

> **最后更新**: 2026-01-09

## 1. 核心设计理念

### 1.1 数据双重性 (Dual-Nature Data)
数据以两种形态存在：
- **For Machine (JSON)**: 结构化的 `structured_kv`，用于过滤、索引和图谱构建
- **For Model (Text)**: `summary` 高密度文本，用于 Embedding 和 LLM 上下文

### 1.2 IndexedDB 优先 (IndexedDB-First)
- 所有数据存储在 IndexedDB (`EngramDB`)
- WorldBook 仅用于宏占位 (`{{engramSummaries}}`)
- 不再写入 WorldBook 条目

---

## 2. 核心组件

### 2.1 ScopeManager
- **位置**: `services/database/ScopeManager.ts`
- **职责**: 管理 Scope (作用域)
- **V0.5**: 仅使用 `chat_id` 作为主键

### 2.2 Extractor
- **位置**: `services/pipeline/Extractor.ts`
- **职责**: LLM 调用 + JSON 解析
- **输入**: 聊天消息
- **输出**: `ExtractedEvent[]` (结构化 JSON)

### 2.3 Pipeline
- **位置**: `services/pipeline/Pipeline.ts`
- **职责**: 编排 ETL 流程
- **流程**: Extractor → 保存到 IndexedDB → 刷新宏缓存

### 2.4 MacroService
- **位置**: `tavern/MacroService.ts`
- **职责**: 注册 `{{engramSummaries}}` 宏
- **数据源**: 从 `memoryStore` (IndexedDB) 动态读取

### 2.5 EventTrimmer
- **位置**: `services/pipeline/EventTrimmer.ts`
- **职责**: 精简合并旧事件
- **流程**: 读取事件 → LLM 压缩 → 保存新事件 → 删除旧事件

---

## 3. 数据流

```mermaid
graph TD
    Input[聊天消息] --> Scope[ScopeManager]
    Scope -->|确定 scope_id| Extractor
    
    subgraph "写入流程"
        Extractor -->|ExtractedEvent[]| Pipeline
        Pipeline -->|EventNode| DB[(IndexedDB)]
        Pipeline --> MacroCache[MacroService.refreshCache]
    end
    
    subgraph "读取流程"
        Macro[宏展开 engramSummaries] --> Store[memoryStore]
        Store --> DB
    end
    
    subgraph "精简流程"
        Trigger[Token超限] --> Trimmer[EventTrimmer]
        Trimmer --> DB
    end
```

---

## 4. 数据结构

### 4.1 Scope
```typescript
interface Scope {
    id?: number;
    chat_id: string;          // 唯一主键
    character_name: string;   // 仅用于显示
    state: ScopeState;
    created_at: number;
    last_active_at: number;
}
```

### 4.2 EventNode
```typescript
interface EventNode {
    id: string;
    scope_id: number;
    
    summary: string;          // For Model
    structured_kv: {          // For Machine
        time_anchor: string;
        role: string[];
        location: string;
        event: string;
        logic: string[];
        causality: string;
    };
    
    significance_score: number;
    level: number;            // 0=原始, 1=精简后
    source_range: { start_index: number; end_index: number };
    timestamp: number;
}
```

---

## 5. 关键文件

| 文件 | 职责 |
|------|------|
| `services/database/db.ts` | EngramDB 定义 |
| `services/database/ScopeManager.ts` | Scope 管理 |
| `services/pipeline/Pipeline.ts` | ETL 编排 |
| `services/pipeline/Extractor.ts` | LLM + JSON 解析 |
| `services/pipeline/EventTrimmer.ts` | 事件精简 |
| `stores/memoryStore.ts` | Zustand 状态 + IndexedDB 操作 |
| `tavern/MacroService.ts` | 宏注册 |
| `services/WorldBookSlotService.ts` | WB 槽位初始化 |
