# Engram ç³»ç»Ÿæµç¨‹æ¶æ„ V0.9.9

> **æœ€åæ›´æ–°**: 2026-01-18 (Layered Modular Architecture)

## 1. æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 1.1 æ•°æ®åŒé‡æ€§ (Dual-Nature Data)
æ•°æ®ä»¥ä¸¤ç§å½¢æ€å­˜åœ¨ï¼š
- **For Machine (JSON)**: ç»“æ„åŒ–çš„ `structured_kv`ï¼Œç”¨äºè¿‡æ»¤ã€ç´¢å¼•å’Œå›¾è°±æ„å»º
- **For Model (Text)**: `summary` é«˜å¯†åº¦æ–‡æœ¬ï¼Œç”¨äº Embedding å’Œ LLM ä¸Šä¸‹æ–‡

### 1.2 IndexedDB ä¼˜å…ˆ (IndexedDB-First)
- æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨ IndexedDB (`EngramDB`)
- WorldBook ä»…ç”¨äºå®å ä½ (`{{engramSummaries}}`)
- ä¸å†å†™å…¥ WorldBook æ¡ç›®

### 1.3 è“ç¯/ç»¿ç¯å¯è§æ€§ (V0.7.1)
ç±»ä¼¼é…’é¦†ä¸–ç•Œä¹¦çš„è§¦å‘æœºåˆ¶ï¼š

| çŠ¶æ€ | å­—æ®µå€¼ | å«ä¹‰ | å¯è§æ€§ |
|------|--------|------|--------|
| ğŸ”µ **è“ç¯** | `is_archived=false` | å¸¸é©»äº‹ä»¶ | å§‹ç»ˆæ˜¾ç¤ºåœ¨ `{{engramSummaries}}` |
| ğŸŸ¢ **ç»¿ç¯** | `is_archived=true` | æ¡ä»¶è§¦å‘ | ä»…å½“è¢« RAG å¬å›æ—¶ä¸´æ—¶æ˜¾ç¤º |

---

## 2. æ ¸å¿ƒç»„ä»¶ (Layered Locations)

### 2.1 ChatManager (L2 Data)
- **ä½ç½®**: `src/data/ChatManager.ts` (åŸ `services/database/ChatManager.ts`)
- **èŒè´£**: ç®¡ç†èŠå¤©çŠ¶æ€
- **æ¶æ„**: æ¯ä¸ª chat_id ç‹¬ç«‹æ•°æ®åº“

### 2.2 Extractor (L4 Modules)
- **ä½ç½®**: `src/modules/memory/extractors/Extractor.ts`
- **èŒè´£**: LLM è°ƒç”¨ + JSON è§£æ
- **è¾“å…¥**: èŠå¤©æ¶ˆæ¯
- **è¾“å‡º**: `ExtractedEvent[]` (ç»“æ„åŒ– JSON)

### 2.3 Pipeline (L4 Modules)
- **ä½ç½®**: `src/modules/workflow/Pipeline.ts`
- **èŒè´£**: ç¼–æ’ ETL æµç¨‹
- **æµç¨‹**: Extractor â†’ ä¿å­˜åˆ° IndexedDB â†’ åˆ·æ–°å®ç¼“å­˜

### 2.4 MacroService (L3 Integrations)
- **ä½ç½®**: `src/integrations/tavern/macros.ts` (åŸ `MacroService.ts`)
- **èŒè´£**: æ³¨å†Œ `{{engramSummaries}}` å®
- **æœºåˆ¶**: æ”¯æŒ `refreshCache(recalledIds?)` ä¼ å…¥å¬å› ID

### 2.5 EventTrimmer (L4 Modules)
- **ä½ç½®**: `src/modules/memory/EventTrimmer.ts`
- **èŒè´£**: ç²¾ç®€åˆå¹¶æ—§äº‹ä»¶ï¼ŒåŒæ—¶æ ‡è®° `is_archived=true`
- **æµç¨‹**: è¯»å–äº‹ä»¶ â†’ LLM å‹ç¼© â†’ ä¿å­˜ Level 1 å¤§çº² â†’ å½’æ¡£åŸäº‹ä»¶

### 2.6 EntityBuilder (L4 Modules)
- **ä½ç½®**: `src/modules/graph/EntityBuilder.ts` (æˆ– `src/modules/memory/extractors/EntityExtractor.ts`ï¼ŒåŸºäºå®ç°)
- **èŒè´£**: ä»åŸå§‹å¯¹è¯ä¸­æå–å®ä½“ï¼ˆè§’è‰²ã€åœ°ç‚¹ã€ç‰©å“ç­‰ï¼‰
- **è§¦å‘**: ä¸ SummarizerService å¹¶è¡Œï¼Œæ¥¼å±‚è§¦å‘å™¨
- **æµç¨‹**: chatHistory â†’ LLM æå– â†’ æ¶ˆæ­§ â†’ profileToYaml() â†’ ä¿å­˜ EntityNode

---

## 3. æ•°æ®æµ

```mermaid
graph TD
    Input[èŠå¤©æ¶ˆæ¯] --> ChatMgr[ChatManager]
    ChatMgr -->|ç¡®å®š chat_id| Extractor
    
    subgraph "é¢„å¤„ç†æµç¨‹ (V0.8)"
        UserInput[ç”¨æˆ·è¾“å…¥] -->|GENERATION_AFTER_COMMANDS| Preprocessor[src/modules/preprocessing/Preprocessor]
        Preprocessor -->|LLM è°ƒç”¨| LLM_Pre[LLM é¢„å¤„ç†]
        LLM_Pre --> OutputParser[OutputParser]
        OutputParser -->|output| InjectMsg[æ³¨å…¥ç”¨æˆ·æ¶ˆæ¯]
        OutputParser -->|query| RAG[RAG æ£€ç´¢]
    end
    
    subgraph "å†™å…¥æµç¨‹"
        Extractor -->|ExtractedEvent[]| Pipeline
        Pipeline -->|EventNode| DB[(IndexedDB)]
        Pipeline --> MacroCache[MacroService.refreshCache]
    end
    
    subgraph "è¯»å–æµç¨‹ (å®å±•å¼€)"
        Macro[å®å±•å¼€ engramSummaries] --> Store[memoryStore.getEventSummaries]
        Store -->|è¿‡æ»¤+æ’åº| DB
    end
    
    subgraph "ç²¾ç®€æµç¨‹"
        Trigger[Tokenè¶…é™] --> Trimmer[EventTrimmer]
        Trimmer -->|å½’æ¡£åŸäº‹ä»¶| DB
        Trimmer -->|Level 1 å¤§çº²| DB
    end
    
    subgraph "RAG å¬å›æµç¨‹ (V0.9.8 ç»Ÿä¸€æ£€ç´¢)"
        RAG -->|Unified Query| Retriever[src/modules/rag/retrieval/Retriever]
        Retriever -->|EventNode + EntityNode| Embedding[å‘é‡æ£€ç´¢]
        Embedding -->|Merged Results| MacroCache
    end
    
    subgraph "å®ä½“å¤„ç†æµç¨‹ (V0.9.4+)"
        EntityTrigger[æ¥¼å±‚è§¦å‘] -->|checkEntityExtraction| EntityBuilder
        ChatHistory[åŸå§‹å¯¹è¯] --> EntityBuilder
        EntityBuilder -->|profile| ProfileYaml[profileToYaml]
        ProfileYaml -->|EntityNode + Embedding| DB
    end
```

---

## 4. äº‹ä»¶èšåˆä¸æ’åº

### 4.1 å¯è§æ€§è¿‡æ»¤

```typescript
// memoryStore.getEventSummaries(recalledIds?)
const visibleEvents = events.filter(e =>
    e.level >= 1 ||                    // å¤§çº²æ€»æ˜¯æ˜¾ç¤º
    !e.is_archived ||                  // è“ç¯ï¼šæœªå½’æ¡£
    recalledSet?.has(e.id)             // ç»¿ç¯ï¼šè¢« RAG å¬å›
);
```

### 4.2 åŒå±‚æ’åºç®—æ³•

```typescript
// æŒ‰æ¶ˆæ¯æ—¶é—´çº¿æ’åºï¼Œç¡®ä¿äº‹ä»¶æŒ‰æ•…äº‹é¡ºåºå‘ˆç°
visibleEvents.sort((a, b) => {
    // 1. ä¸»é”®ï¼šæ¶ˆæ¯èŒƒå›´èµ·ç‚¹ (æ•…äº‹æ—¶é—´çº¿)
    const startDiff = a.source_range.start_index - b.source_range.start_index;
    if (startDiff !== 0) return startDiff;

    // 2. æ¬¡é”®ï¼šæ¶ˆæ¯èŒƒå›´ç»ˆç‚¹ (å¤§çº²åœ¨ç»†èŠ‚ä¹‹å)
    const endDiff = a.source_range.end_index - b.source_range.end_index;
    if (endDiff !== 0) return endDiff;

    // 3. å…œåº•ï¼šåˆ›å»ºæ—¶é—´
    return a.timestamp - b.timestamp;
});
```

---

## 5. æ•°æ®ç»“æ„

### 5.1 EventNode (V0.7+)

**V0.6+ å¤šæ•°æ®åº“æ¶æ„**: æ¯ä¸ª `chat_id` ç‹¬ç«‹æ•°æ®åº“ï¼Œä¸å†éœ€è¦ `scope_id`ã€‚

```typescript
// å®šä¹‰ä½ç½®: src/core/types/memory.ts (æˆ– modules/memory/types.ts)
interface EventNode {
    id: string;               // UUID
    
    summary: string;          // For Model (çƒ§å½•æ–‡æœ¬ï¼Œç”¨äº Embedding å’Œ RAG)
    structured_kv: {          // For Machine (ç»“æ„åŒ–æŸ¥è¯¢)
        time_anchor: string;
        role: string[];
        location: string;
        event: string;
        logic: string[];
        causality: string;
    };
    
    // å‘é‡åŒ–
    embedding?: number[];     // è¯­ä¹‰å‘é‡ (å¯é€‰)
    is_embedded: boolean;     // æ˜¯å¦å·²å‘é‡åŒ–
    
    // å¯è§æ€§æ§åˆ¶
    is_archived: boolean;     // true=ğŸŸ¢ç»¿ç¯(æ¡ä»¶è§¦å‘), false=ğŸ”µè“ç¯(å¸¸é©»)
    
    // æ’åºä¸å±‚çº§
    level: number;            // 0=åŸå§‹, 1+=ç²¾ç®€å±‚çº§
    source_range: { start_index: number; end_index: number };
    significance_score: number;
    timestamp: number;
    
    // å¯é€‰
    parent_id?: string;       // çˆ¶èŠ‚ç‚¹ (ç²¾ç®€æ¥æº)
}
```

### 5.2 EntityNode & ScopeState

```typescript
// EntityNode - å®ä½“èŠ‚ç‚¹
interface EntityNode {
    id: string;
    name: string;
    type: EntityType;         // 'char' | 'loc' | 'item' | 'concept' | 'unknown'
    aliases: string[];        // åˆ«ååˆ—è¡¨ (MultiEntryç´¢å¼•)
    description: string;      // [For Model] YAML çƒ§å½•æ–‡æœ¬
    profile: Record<string, unknown>;  // [For Machine] å¼€æ”¾å¼ KV å®¹å™¨
    last_updated_at: number;
    layout_x?: number;        // å›¾è°±å¸ƒå±€åæ ‡
    layout_y?: number;
}

// ScopeState - èŠå¤©çŠ¶æ€
interface ScopeState {
    last_summarized_floor: number;
    token_usage_accumulated: number;
    last_compressed_at: number;
    active_summary_order: number;
    last_extracted_floor: number;
}
```

---

## 6. å…³é”®æ–‡ä»¶ç´¢å¼•

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `src/data/db.ts` | EngramDB (Dexie) å®šä¹‰ |
| `src/data/ChatManager.ts` | èŠå¤©çŠ¶æ€ç®¡ç† |
| `src/modules/workflow/Pipeline.ts` | ETL ç¼–æ’å™¨ |
| `src/modules/memory/extractors/Extractor.ts` | LLM + JSON è§£æ |
| `src/modules/memory/EventTrimmer.ts` | äº‹ä»¶ç²¾ç®€ + å½’æ¡£ |
| `src/state/memoryStore.ts` | Zustand çŠ¶æ€ + å¯è§æ€§è¿‡æ»¤ |
| `src/integrations/tavern/macros.ts` | å®æ³¨å†Œ + ç¼“å­˜åˆ·æ–° |
| `src/modules/rag/injection/Injector.ts` | RAG æ³¨å…¥ Hook |

