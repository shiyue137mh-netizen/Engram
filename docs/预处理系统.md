# Engram 输入预处理系统 V0.8

> **创建日期**: 2026-01-11
> **版本**: V0.8.5 (Updated Path)
> **状态**: ✅ 已实现

## 1. 功能概述

输入预处理系统在用户发送消息时自动进行预处理，通过 LLM 增强用户输入，支持多种功能模式。

### 1.1 核心理念

**输入预处理 = 动态提示词模板 + 统一输出解析**

- 所有预处理模板统一使用 `preprocessing` 分类
- 输出统一用 `<output>` 标签包裹
- Query 增强模式额外使用 `<query>` 标签
- 系统统一捕获和处理输出

### 1.2 内置功能模式

| 模式 | 用途 | 输出 |
|------|------|------|
| **Query 增强** | 扩展指代词，优化 RAG 检索 | `<query>` + `<output>` |
| **剧情编排** | 生成导演指令框架 | `<output>` |
| **描写增强** | 补充细节描写和环境氛围 | `<output>` |
| **自定义** | 用户创建的任意预处理 | `<output>` |

---

## 2. 系统架构

### 2.1 核心组件

```
src/modules/preprocessing/
├── Preprocessor.ts       # 预处理核心服务
├── OutputParser.ts       # 统一输出解析器
└── types.ts              # 类型定义

src/modules/rag/injection/
└── Injector.ts           # 事件监听和注入
```

### 2.2 事件驱动流程

```
用户点击发送
    ↓
GENERATION_STARTED
    ↓
处理斜杠命令
    ↓
GENERATION_AFTER_COMMANDS ← 🎯 Engram 预处理入口
    ↓ (await 阻塞)
Preprocessor.process(userInput)
    ↓
LLM 调用 (使用选中的预处理模板)
    ↓
OutputParser.parse()
├── 删除 <think>...</think>
├── 捕获 <output>...</output>
└── 捕获 <query>...</query> (如有)
    ↓
修改 lastMessage.mes = result.output
    ↓
酒馆继续正常生成
```

### 2.3 阻塞机制

关键发现：SillyTavern 的 `eventSource.emit()` 会 `await` 所有事件处理器。

```javascript
// SillyTavern script.js
await eventSource.emit(event_types.GENERATION_AFTER_COMMANDS, type, params, dryRun);
```

因此只需确保 Engram 的事件处理器是 `async` 函数即可实现阻塞。

---

## 3. 数据结构

### 3.1 预处理配置

```typescript
interface PreprocessingConfig {
    enabled: boolean;        // 是否启用预处理
    templateId: string;      // 当前使用的模板 ID
    autoTrigger: boolean;    // 是否自动触发
}
```

### 3.2 预处理结果

```typescript
interface PreprocessingResult {
    success: boolean;
    output?: string;         // <output> 内容
    query?: string;          // <query> 内容 (仅 Query 模式)
    error?: string;
    processingTime?: number;
}
```

### 3.3 解析结果

```typescript
interface ParsedOutput {
    output: string | null;   // <output> 内容
    query: string | null;    // <query> 内容 (如有)
    raw: string;             // 原始输出 (已清理 <think>)
}
```

---

## 4. 统一输出格式

### 4.1 标准模板输出

```xml
<think>
... 思考过程（会被删除）...
</think>

<output>
... 实际输出内容（会被捕获并注入用户消息）...
</output>
```

### 4.2 Query 增强模式

```xml
<think>
... 分析用户意图 ...
</think>

<query>
关键词1, 关键词2, 相关概念
</query>

<output>
[用户意图总结和上下文补充]
</output>
```

- `<query>` 内容 → 发送给 RAG 系统进行向量检索
- `<output>` 内容 → 注入用户消息

---

## 5. 提示词模板

### 5.1 内置模板

| 模板 | 默认状态 |
|------|---------|
| Query 增强 | 启用 |
| 剧情编排 | 禁用 |
| 描写增强 | 禁用 |

### 5.2 支持的宏变量

| 宏 | 说明 |
|------|------|
| `{{worldbookContext}}` | 世界书激活内容 |
| `{{chatHistory}}` | 最近对话历史 |
| `{{userInput}}` | 用户本轮输入 |
| `{{char}}` | 角色名 |
| `{{user}}` | 用户名 |
| `{{context}}` | 完整上下文 |

### 5.3 自定义模板

用户可以在 **API 配置 → 提示词模板** 中：
- 创建新的预处理模板 (选择 `preprocessing` 分类)
- 编辑内置模板的系统提示词和用户提示词
- 导入/导出模板配置

---

## 6. 使用指南

### 6.1 启用预处理

1. 打开 Engram 面板
2. 进入 **API 配置 → 提示词模板**
3. 找到 "Query 增强" 或其他预处理模板
4. 点击电源图标启用模板
5. 在 **处理** 页面开启 "输入预处理" 和 "自动触发"

### 6.2 切换功能模式

在提示词模板列表中，只需启用想要的预处理模板即可。同一时间只有一个 `preprocessing` 分类的模板生效。

### 6.3 自定义提示词

1. 选择一个预处理模板
2. 在右侧编辑区修改系统提示词或用户提示词
3. 使用宏变量 (如 `{{userInput}}`, `{{chatHistory}}`) 注入上下文
4. 确保输出格式包含 `<output>` 标签

---

## 7. 与 RAG 的集成

### 7.1 Query 增强 → RAG 召回

```
用户输入 "我们之前约定的那件事"
    ↓
Preprocessor 调用 LLM (query_enhance 模板)
    ↓
输出:
<query>约定, 承诺, 之前的对话</query>
<output>用户提及之前的约定，需要回顾相关记忆</output>
    ↓
OutputParser.parse()
├── query: "约定, 承诺, 之前的对话"
└── output: "用户提及之前的约定，需要回顾相关记忆"
    ↓
Retriever.vectorSearch(query) → recalledIds[]
    ↓
MacroService.refreshCache(recalledIds)
    ↓
{{engramSummaries}} 包含召回的记忆
```

### 7.2 非 Query 模式

直接将 `<output>` 内容替换原始用户消息：

```
用户输入 → LLM (plot_director) → <output>导演指令</output>
    ↓
lastMessage.mes = "导演指令"
    ↓
酒馆继续生成 (使用增强后的输入)
```

---

## 8. 注意事项

### 8.1 跳过条件

以下情况预处理会自动跳过：
- `dryRun` 模式 (预览/计算 Token)
- `regenerate` 重新生成
- `swipe` 切换回复
- `quiet` 静默生成
- `impersonate` 代入模式
- 预处理未启用或 autoTrigger 未开启

### 8.2 防重入

使用 `isProcessing` 标志防止同一生成周期内重复触发预处理。

### 8.3 错误处理

预处理失败时会记录日志，但不会阻止生成流程继续。

---

## 9. 文件索引

| 文件 | 职责 |
|------|------|
| `src/modules/preprocessing/Preprocessor.ts` | 预处理核心逻辑 |
| `src/modules/preprocessing/OutputParser.ts` | 输出解析 (Regex 捕获) |
| `src/modules/preprocessing/types.ts` | 类型定义 |
| `src/modules/rag/injection/Injector.ts` | 事件监听和注入 |
| `src/integrations/llm/SystemPrompts/*.md` | 内置提示词 |
