# Engram V0.9.0 图系统开发计划 (Graph System Development Plan)

> **Last Modified**: 2026-01-12
> **Goal**: 构建 "Event-Entity" 双层图谱，实现 Graph RAG 和可视化。

## 1. 核心目标 (Objectives)

V0.9.0 将补全 Engram 架构的最后一块拼图——图结构。我们将现有的线性时间轴记忆升级为网状关联记忆，通过实体链接和因果关系增强召回深度。

关键交付物：
1.  **Graph Builder**: 自动从剧情摘要中提取实体和关系。
2.  **Graph Retriever**: 基于图游走的上下文扩展算法。
3.  **Graph View**: 基于 ReactFlow 的交互式图谱可视化。

## 2. 架构设计 (Architecture)

### 2.1 双层图谱模型 (Dual-Layer Graph)

我们采用 **"事件-实体" (Event-Entity)** 混合图结构：

*   **Layer 1: 事件层 (Event Layer)**
    *   **节点**: `EventNode` (现有)
    *   **边**: `NEXT` (时间序), `CAUSED_BY` (因果逻辑)
    *   **来源**: 现有的 `SummarizerService` 和 `structured_kv`

*   **Layer 2: 实体层 (Entity Layer)**
    *   **节点**: `EntityNode` (角色/物品/地点/概念)
    *   **边**: `INVOLVED_IN` (参与事件), `RELATED_TO` (实体间关系)
    *   **来源**: 新增 LLM 实体提取服务

### 2.2 数据结构定义

在 `services/types/graph.ts` 和 `database/db.ts` 中扩展：

```typescript
// 实体节点类型
export enum EntityType {
    Character = 'char',
    Location = 'loc',
    Item = 'item',
    Concept = 'concept'
}

// 实体节点
export interface EntityNode {
    id: string;              // UUID
    name: string;            // 实体名称 (索引键)
    type: EntityType;
    description: string;     // 简短描述
    aliases: string[];       // 别名列表
    
    first_seen_event_id: string; // 初次登场事件
    last_seen_event_id: string;  // 最近登场事件
    significance: number;    // 重要度权重
}

// 图的边
export interface GraphEdge {
    source: string;
    target: string;
    type: 'NEXT' | 'CAUSED_BY' | 'INVOLVED_IN' | 'RELATED_TO';
    weight: number;
    metadata?: any;
}
```

## 3. 开发路线图 (Roadmap)

### 阶段一：数据层与构建服务 (Data & Builder)

**目标**: 让系统具备生成和存储图数据的能力。

1.  **Database Upgrade**:
    -   更新 `EngramDB` schema，添加 `entities` 表和 `edges` 表。
    -   实现 CRUD 服务 `EntityService` 和 `GraphService`。

2.  **Prompt Template**:
    -   创建 `prompts/entity_extraction.md`模板。
    -   输入：一段剧情摘要。
    -   输出：JSON (Entities list, Relations list)。

3.  **GraphBuilder Service**:
    -   位置：`services/graph/GraphBuilder.ts`
    -   逻辑：在 `SummarizerService` 生成摘要后触发。
    -   流程：调用 LLM 提取 -> 实体消歧 (Entity Resolution) -> 写入 DB。
    -   **难点**: 实体对齐（"艾莉丝" == "Alice"）。初期采用简单的名称匹配或 LLM 辅助判断。

### 阶段二：图检索算法 (Graph RAG)

**目标**: 利用图结构增强 RAG 召回效果。

1.  **GraphRetriever Service**:
    -   位置：`services/rag/GraphRetriever.ts`
    -   算法 (1-2 Hop Expansion):
        1.  **Anchor**: 使用 Embedding 找到 Top-K `EventNodes`。
        2.  **Expand**: 
            -   找到这些 Events 涉及的关键 `EntityNodes`。
            -   找到与这些 Entities 强相关的其他 `EventNodes` (非线性跳跃)。
        3.  **Filter**: 过滤掉低权重路径。
    
2.  **集成到 Retriever**:
    -   修改 `Retriever.ts`，在 Hybrid Search 后加入 Graph Expansion 步骤。
    -   更新 `RecallLog` 展示图召回的路径来源。

### 阶段三：可视化界面 (Visualization)

**目标**: 让用户直观看到记忆网络。

1.  **Graph View**:
    -   位置：`views/Graph/GraphView.tsx`
    -   库：`reactflow` (或 `react-force-graph` 如果需要 3D/高性能)。推荐 `reactflow` 因为交互性好。

2.  **交互功能**:
    -   **节点渲染**:不同颜色区分 Event (蓝) 和 Entity (绿/红/黄)。
    -   **点击交互**: 点击节点显示详情侧边栏。
    -   **实时布局**: 使用 `d3-force` 或 `dagre` 进行自动布局。

3.  **调试工具**:
    -   在 DevLog 中提供简单的图构建触发器，用于手动测试旧数据的图构建。

## 4. 技术挑战与方案

| 挑战 | 解决方案 |
| :--- | :--- |
| **实体消歧** (同名异体/异名同体) | 维护 `aliases` 字段；构建时先检索相似实体名；必要时让 LLM 决定是 Merge 还是 Create。 |
| **图数据爆炸** | 限制每个 Event 关联的 Entity 数量 (Top-5)；定期清理孤立节点。 |
| **实时布局性能** | Graph View 仅加载当前 Scope 的数据；支持仅显示最近 N 个事件的子图。 |

## 5. 任务清单 (Task List)

- [ ] **Data Layer**
    - [ ] 定义 `EntityNode`, `GraphEdge` 类型
    - [ ] 升级 `EngramDB` Schema
    - [ ] 实现 `GraphService` (CRUD)

- [ ] **Builder Service**
    - [ ] 编写 `prompts/entity_extraction.md`
    - [ ] 实现 `GraphBuilder.ts`
    - [ ] 集成到 `SummarizerService`

- [ ] **Graph RAG**
    - [ ] 实现 `GraphRetriever` (1-Hop 算法)
    - [ ] 集成到 RAG Pipeline

- [ ] **UI/UX**
    - [ ] 安装 `reactflow`
    - [ ] 开发 `GraphView` 组件
    - [ ] 实现节点自定义样式和交互

