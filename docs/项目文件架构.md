# Engram é¡¹ç›®æ–‡ä»¶æ¶æ„

> åŸºäº **React + Vite + TypeScript** + **Tailwind CSS**ï¼Œé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ã€‚
> **æœ€åæ›´æ–°**: 2026-01-08 (V0.5 Pipeline æ¶æ„ä¼˜åŒ–)

---

## ğŸ“ ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ assets/                # é™æ€èµ„æº
â”‚   â”œâ”€â”€ icons/             # SVG å›¾æ ‡ç»„ä»¶ (EngramIcon, EngramTextLogo)
â”‚   â””â”€â”€ styles/            # å…¨å±€æ ·å¼ç»„ä»¶ (GlobalStyles)
â”‚
â”œâ”€â”€ components/            # çº¯å±•ç¤ºç»„ä»¶
â”‚   â”œâ”€â”€ ui/                # åŸå­ç»„ä»¶ (Button, Switch, Modal, TabPills)
â”‚   â”œâ”€â”€ layout/            # å¸ƒå±€ç»„ä»¶ (MainLayout, Header, Sidebar)
â”‚   â”œâ”€â”€ visual/            # è§†è§‰ç»„ä»¶ (NeuralOrb, WelcomeAnimation)
â”‚   â””â”€â”€ common/            # é€šç”¨ç»„ä»¶ (ItemCard, ItemList, PageTitle)
â”‚
â”œâ”€â”€ lib/                   # æ— ä¸šåŠ¡é€»è¾‘çš„å·¥å…·åº“ (L5 åŸºç¡€å±‚)
â”‚   â”œâ”€â”€ logger/            # æ—¥å¿—ç³»ç»Ÿ (Logger, ModelLogger)
â”‚   â”œâ”€â”€ EventWatcher.ts    # [V0.5] é€šç”¨äº‹ä»¶ç›‘å¬å™¨ (å¯è¢«å¤šæ¨¡å—å…±ç”¨)
â”‚   â””â”€â”€ events.ts          # åº”ç”¨å†…éƒ¨äº‹ä»¶æ€»çº¿
â”‚
â”œâ”€â”€ services/              # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ â­ (è¯¦è§ä¸‹æ–¹)
â”‚
â”œâ”€â”€ stores/                # [V0.5] Zustand çŠ¶æ€åº“ (L3 çŠ¶æ€å±‚)
â”‚   â”œâ”€â”€ memoryStore.ts     # è®°å¿†çŠ¶æ€ç®¡ç† (DB/WB è¯»å†™)
â”‚   â”œâ”€â”€ devLogStore.ts     # å¼€å‘æ—¥å¿—çŠ¶æ€
â”‚   â””â”€â”€ themeStore.ts      # ä¸»é¢˜çŠ¶æ€
â”‚
â”œâ”€â”€ tavern/                # SillyTavern é€‚é…å±‚ â­ (L5 åŸºç¡€å±‚)
â”‚   â”œâ”€â”€ bridge.ts          # å”¯ä¸€çš„ window.SillyTavern å…¥å£
â”‚   â”œâ”€â”€ context.ts         # ST ä¸Šä¸‹æ–‡è·å– (getSTContext)
â”‚   â”œâ”€â”€ TavernEvents.ts    # é…’é¦†äº‹ä»¶å°è£…
â”‚   â”œâ”€â”€ WorldBookState.ts  # @deprecated V0.5 å·²åºŸå¼ƒ
â”‚   â”œâ”€â”€ MacroService.ts    # å…¨å±€å®æ³¨å†Œ ({{engramSummaries}} ç­‰)
â”‚   â””â”€â”€ api/               # é…’é¦† API å°è£…
â”‚       â”œâ”€â”€ Message.ts     # æ¶ˆæ¯æœåŠ¡
â”‚       â”œâ”€â”€ WorldInfo.ts   # ä¸–ç•Œä¹¦æœåŠ¡
â”‚       â””â”€â”€ index.ts       # ç»Ÿä¸€å¯¼å‡º
â”‚
â”œâ”€â”€ types/                 # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ global.d.ts        # Window æ‰©å±•å£°æ˜
â”‚   â””â”€â”€ st-types/          # SillyTavern ç±»å‹ (23ä¸ª .d.ts)
â”‚
â”œâ”€â”€ views/                 # é¡µé¢çº§è§†å›¾
â”‚   â”œâ”€â”€ Dashboard/         # ä»ªè¡¨ç›˜
â”‚   â”œâ”€â”€ Processing/        # å¤„ç† (æ€»ç»“/ç²¾ç®€)
â”‚   â”œâ”€â”€ APIPresets/        # API é…ç½®
â”‚   â”œâ”€â”€ Settings/          # è®¾ç½®
â”‚   â”œâ”€â”€ DevLog/            # å¼€å‘æ—¥å¿—
â”‚   â”œâ”€â”€ Graph/             # å›¾è°±å¯è§†åŒ–
â”‚   â””â”€â”€ MemoryStream/      # è®°å¿†æµ
â”‚
â”œâ”€â”€ hooks/                 # React Hooks
â”œâ”€â”€ contexts/              # React Context (ThemeContext)
â”œâ”€â”€ constants/             # å¸¸é‡é…ç½® (navigation, commands)
â”œâ”€â”€ styles/                # æ ·å¼ (main.css, themes.ts)
â”œâ”€â”€ utils/                 # å·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ App.tsx                # æ ¹ç»„ä»¶ (æ”¯æŒæ‡’åŠ è½½)
â””â”€â”€ index.tsx              # å…¥å£
```

---

## ğŸ› ï¸ Services æ¨¡å—è¯¦è§£

### `services/api/` - LLM API å±‚
**é€šç”¨ LLM è°ƒç”¨å’Œé…ç½®ç®¡ç†**

| æ–‡ä»¶ | å¯¼å‡º | ç”¨é€” |
|------|------|------|
| `LLMAdapter.ts` | `LLMAdapter`, `llmAdapter` | å°è£… TavernHelper LLM è°ƒç”¨ï¼Œæ”¯æŒ `generate` / `generateRaw` |
| `types.ts` | å„ç§ç±»å‹å®šä¹‰ | `LLMPreset`, `PromptTemplate`, `VectorConfig`, `EngramAPISettings` ç­‰ |
| `ModelDiscovery.ts` | `ModelDiscovery` | æ¨¡å‹å‘ç°å’Œåˆ—è¡¨è·å– |
| `prompts/` | å†…ç½®æç¤ºè¯æ¨¡æ¿ | `text_summary.md`, `trim.md`, `query_enhance.md`, `vector_summary.md` |

**å¤ç”¨ç¤ºä¾‹**ï¼š
```typescript
import { llmAdapter, LLMRequest } from '@/services/api';
const response = await llmAdapter.generate({ systemPrompt, userPrompt });
```

---

### `services/pipeline/` - æ•°æ®å¤„ç†ç®¡é“
**é€šç”¨æ–‡æœ¬å¤„ç†ç»„ä»¶ï¼Œå¯è¢«å¤šä¸ªæ¨¡å—å¤ç”¨**

| æ–‡ä»¶ | å¯¼å‡º | ç”¨é€” |
|------|------|------|
| `TextProcessor.ts` | `TextProcessor`, `textProcessor` | LLM è¾“å‡ºæ¸…æ´—ã€æˆªæ–­ã€æ ¼å¼åŒ– |
| `RegexProcessor.ts` | `RegexProcessor`, `regexProcessor`, `RegexRule` | å¯é…ç½®æ­£åˆ™è§„åˆ™å¤„ç†ï¼ˆè¾“å…¥/è¾“å‡ºæ¸…æ´—ï¼‰ |
| `Pipeline.ts` | `Pipeline` | ETL æµæ°´çº¿æ§åˆ¶å™¨ [æ¡†æ¶å ä½] |

**å¤ç”¨ç¤ºä¾‹**ï¼š
```typescript
import { textProcessor, regexProcessor } from '@/services/pipeline';
const cleaned = textProcessor.clean(llmOutput);
const processed = regexProcessor.process(text, 'output');
```

---

### `services/summarizer/` - æ€»ç»“æœåŠ¡
**å‰§æƒ…æ€»ç»“æ ¸å¿ƒä¸šåŠ¡é€»è¾‘**

| æ–‡ä»¶ | å¯¼å‡º | ç”¨é€” |
|------|------|------|
| `SummarizerService.ts` | `SummarizerService`, `summarizerService` | ä¸€å±‚æ€»ç»“ï¼šæ¥¼å±‚ç›‘å¬ã€LLM è°ƒç”¨ã€ä¸–ç•Œä¹¦å†™å…¥ |
| `TrimmerService.ts` | `TrimmerService`, `trimmerService` | äºŒå±‚æ€»ç»“ï¼šåˆå¹¶ç²¾ç®€å¤šæ¡æ‘˜è¦ |
| `types.ts` | é…ç½®å’ŒçŠ¶æ€ç±»å‹ | `SummarizerConfig`, `TriggerMode`, `SummaryResult` ç­‰ |

> **æ³¨**ï¼š`SummarizerService` å’Œ `TrimmerService` å†…éƒ¨ä½¿ç”¨ `api/LLMAdapter` å’Œ `pipeline/*` ç»„ä»¶

---

### `services/settings/` - è®¾ç½®æŒä¹…åŒ–
**ä¸ SillyTavern extensionSettings äº¤äº’**

| æ–‡ä»¶ | å¯¼å‡º | ç”¨é€” |
|------|------|------|
| `Persistence.ts` | `SettingsManager` | æ‰€æœ‰ Engram è®¾ç½®çš„è¯»å†™ã€æŒä¹…åŒ– |

**å¸¸ç”¨æ–¹æ³•**ï¼š
- `SettingsManager.get('apiSettings')` - è·å– API é…ç½®
- `SettingsManager.set(key, value)` - ä¿å­˜è®¾ç½®
- `SettingsManager.getEnabledPromptTemplate('text_summary')` - è·å–å¯ç”¨çš„æç¤ºè¯æ¨¡æ¿

---

### å…¶ä»–æœåŠ¡æ¨¡å—

| ç›®å½• | çŠ¶æ€ | ç”¨é€” |
|------|------|------|
| `services/database/` | âœ… å¯ç”¨ | Dexie IndexedDB æ•°æ®åº“ï¼ŒScopeManager ä½œç”¨åŸŸç®¡ç† |
| `services/rag/` | âœ… **å·²å®ç°** | Retriever (æ£€ç´¢), Injector (åŠ¨æ€æ³¨å…¥) |
| `services/types/` | âœ… å¯ç”¨ | æ•°æ®ç»“æ„ç±»å‹ (EventNode, Scope, EntityNode) |
| `services/memory/` | ğŸ”² å ä½ | æœªæ¥è®°å¿†ç®¡ç† |
| `services/updater/` | âœ… å¯ç”¨ | ç‰ˆæœ¬æ›´æ–°æ£€æŸ¥ |
| `services/NotificationService.ts` | âœ… å¯ç”¨ | Toast é€šçŸ¥æœåŠ¡ |
| `services/ThemeManager.ts` | âœ… å¯ç”¨ | ä¸»é¢˜ç®¡ç† |
| `services/RevisionService.ts` | âœ… å¯ç”¨ | æ€»ç»“ä¿®è®¢æœåŠ¡ |
| `services/CharacterDeleteService.ts` | âœ… å¯ç”¨ | è§’è‰²åˆ é™¤è”åŠ¨æ¸…ç† |

---

## ğŸ—ï¸ åˆ†å±‚æ¶æ„

ç³»ç»Ÿé‡‡ç”¨å•å‘ä¾èµ–æµï¼Œä¸¥ç¦è·¨å±‚å¾ªç¯ä¾èµ–ã€‚

```mermaid
graph TD
    L1_UI[L1: è¡¨ç°å±‚ views/] --> L2_Hook[L2: åº”ç”¨å±‚ hooks/]
    L1_UI --> L3_Store[L3: çŠ¶æ€å±‚ stores/]
    L2_Hook --> L3_Store
    L2_Hook --> L4_Service[L4: ä¸šåŠ¡å±‚ services/]
    L4_Service --> L5_Infra[L5: åŸºç¡€è®¾æ–½å±‚ lib/ & tavern/]
    L4_Service --> L5_DB[database/]
```

| å±‚çº§ | ç›®å½• | èŒè´£ | ä¾èµ–è§„åˆ™ |
|------|------|------|----------|
| **L1 è¡¨ç°å±‚** | `views/`, `components/` | UI æ¸²æŸ“ï¼Œäº¤äº’äº‹ä»¶ | å¯è°ƒç”¨ hooks, stores |
| **L2 åº”ç”¨å±‚** | `hooks/` | å°†ä¸šåŠ¡é€»è¾‘å°è£…ä¸º React API | å¯è°ƒç”¨ stores, services |
| **L3 çŠ¶æ€å±‚** | `stores/` | å…¨å±€çŠ¶æ€ç®¡ç† (Zustand) | å¯è°ƒç”¨ services |
| **L4 ä¸šåŠ¡å±‚** | `services/` | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œçº¯ TS | å¯è°ƒç”¨ lib, tavern |
| **L5 åŸºç¡€å±‚** | `lib/`, `tavern/` | åº•å±‚å·¥å…·ï¼Œå¤–éƒ¨ API é€‚é… | **ä¸å¯ä¾èµ–ä¸Šå±‚** |

---

## ğŸ“ ç¼–ç è§„èŒƒ

### ä¸šåŠ¡é€»è¾‘æå–åˆ° Hooks

```tsx
// âŒ é”™è¯¯ï¼šè§†å›¾åŒ…å«ä¸šåŠ¡é€»è¾‘
const APIPresets = () => {
    const [settings, setSettings] = useState(...);
    const handleAdd = () => { /* å¤æ‚é€»è¾‘ */ };
}

// âœ… æ­£ç¡®ï¼šé€»è¾‘åœ¨ Hook ä¸­
const APIPresets = () => {
    const { settings, addPreset } = useAPIPresets();
}
```

### æ ·å¼è§„èŒƒ

- **ä½¿ç”¨ Tailwind ä¸»é¢˜ç±»**ï¼š`bg-background`, `text-foreground`, `border-border`
- **ç¦æ­¢ç¡¬ç¼–ç é¢œè‰²**ï¼šä¸ä½¿ç”¨ `bg-black`, `text-zinc-*` ç­‰
- **å…±äº«æ ·å¼**ï¼šåœ¨ `main.css` çš„ `@layer components` ä¸­å®šä¹‰

---

## ğŸ”Œ å…³é”®æ¨¡å—è¯´æ˜

### tavern/context.ts
**å”¯ä¸€çš„ SillyTavern ä¸Šä¸‹æ–‡è·å–å…¥å£**ï¼š
- `getSTContext()` - è·å– ST ä¸Šä¸‹æ–‡
- `getCurrentChat()` - è·å–èŠå¤©è®°å½•
- `getCurrentCharacter()` - è·å–å½“å‰è§’è‰²
- `isSTAvailable()` - æ£€æŸ¥å¯ç”¨æ€§

### tavern/MacroService.ts
**å…¨å±€å®æ³¨å†ŒæœåŠ¡** (V0.4 æ–°å¢)ï¼š
- `{{engramSummaries}}` - è·å–å½“å‰è§’è‰²çš„æ‰€æœ‰ Engram æ‘˜è¦å†…å®¹
- `{{engramContext}}` - åŠ¨æ€ä¸Šä¸‹æ–‡ (RAG æ£€ç´¢ç»“æœ)

### Hooks ç›®å½•
| Hook | åŠŸèƒ½ |
|------|------|
| `useAPIPresets` | API é¢„è®¾ CRUDã€æç¤ºè¯æ¨¡æ¿ã€æ­£åˆ™è§„åˆ™ç®¡ç† |
| `useDevLog` | æ—¥å¿—è®¢é˜…ã€è¿‡æ»¤ã€å¯¼å‡º |

---

## ğŸ“Š æ„å»ºäº§ç‰©

```
dist/
â”œâ”€â”€ index.js           # ä¸» JS åŒ…
â”œâ”€â”€ style.css          # æ ·å¼
â””â”€â”€ *.js               # ä»£ç åˆ†å‰²çš„ chunks
```

æ„å»ºå‘½ä»¤ï¼š`npm run build`
