# Engram é¡¹ç›®æ–‡ä»¶æ¶æ„

> åŸºäº **React + Vite + TypeScript** + **Tailwind CSS**
> **Version**: v0.9.9 (Layered Modular Architecture)

---

## 1. é¡¶å±‚æ¶æ„æ¦‚è§ˆ (High-Level Overview)

```
src/
â”œâ”€â”€ core/                  # [L0] æ ¸å¿ƒå±‚ï¼šåŸºç¡€ç±»å‹ã€äº‹ä»¶æ€»çº¿ã€å·¥å…·åº“
â”œâ”€â”€ config/                # [L1] é…ç½®å±‚ï¼šè®¾ç½®ç®¡ç† (SettingsManager)
â”œâ”€â”€ data/                  # [L2] æ•°æ®å±‚ï¼šIndexedDB å®šä¹‰ä¸èŠå¤©ç®¡ç†
â”œâ”€â”€ integrations/          # [L3] é›†æˆå±‚ï¼šå¤–éƒ¨ç³»ç»Ÿé€‚é… (SillyTavern, LLM)
â”‚   â”œâ”€â”€ tavern/            # å®¿ä¸»é€‚é… (å« WorldBook æ·±åº¦é›†æˆ)
â”‚   â””â”€â”€ llm/               # LLM è°ƒç”¨é€‚é…
â”œâ”€â”€ modules/               # [L4] æ¨¡å—å±‚ï¼šæ ¸å¿ƒä¸šåŠ¡é€»è¾‘å•å…ƒ
â”‚   â”œâ”€â”€ batch/             # æ‰¹å¤„ç†ç³»ç»Ÿ
â”‚   â”œâ”€â”€ memory/            # è®°å¿†ç®¡ç† (Summarizer, Extractor)
â”‚   â”œâ”€â”€ preprocessing/     # è¾“å…¥é¢„å¤„ç† (Preprocessing)
â”‚   â”œâ”€â”€ rag/               # Graph RAG æ£€ç´¢ (Brain, Embedding)
â”‚   â”œâ”€â”€ search/            # æœç´¢æœåŠ¡ (Vector Search)
â”‚   â””â”€â”€ workflow/          # ä»»åŠ¡æµç¼–æ’å¼•æ“
â”‚       â”œâ”€â”€ core/          # å¼•æ“æ ¸å¿ƒ (Engine, Step)
â”‚       â”œâ”€â”€ definitions/   # é¢„å®šä¹‰å·¥ä½œæµ
â”‚       â””â”€â”€ steps/         # åŸå­æ­¥éª¤åº“
â”œâ”€â”€ state/                 # [L5] çŠ¶æ€å±‚ï¼šZustand Store
â””â”€â”€ ui/                    # [L6] è¡¨ç°å±‚ï¼šReact ç»„ä»¶ä¸è§†å›¾
```

---

## 2. è¯¦ç»†ç›®å½•ç»“æ„ (Detailed Structure)

### 2.1 [L0] Core Layer (`src/core`)
ç³»ç»Ÿæœ€åº•å±‚çš„å¥‘çº¦ï¼Œä¸ä¾èµ–ä»»ä½•å…¶ä»–å±‚çº§ã€‚

```
src/core/
â”œâ”€â”€ events/                # äº‹ä»¶æ€»çº¿å®šä¹‰
â”œâ”€â”€ logger/                # æ—¥å¿—ç³»ç»Ÿ
â”œâ”€â”€ types/                 # å…¨å±€ç±»å‹å®šä¹‰
â”œâ”€â”€ updater/               # æ›´æ–°æ£€æŸ¥å™¨
â”œâ”€â”€ utils/                 # é€šç”¨å·¥å…·å‡½æ•° (JSONParser, UUID)
â””â”€â”€ KeyboardManager.ts     # å…¨å±€å¿«æ·é”®ç®¡ç†
```

### 2.2 [L1] Config Layer (`src/config`)
è´Ÿè´£é…ç½®çš„å®šä¹‰ã€é»˜è®¤å€¼å’Œè¯»å†™ã€‚

```
src/config/
â”œâ”€â”€ settings.ts            # SettingsManager (å¯¹æ¥ extension_settings)
â””â”€â”€ types/                 # é…ç½®æ¥å£å®šä¹‰
    â”œâ”€â”€ defaults.ts        # é»˜è®¤å€¼èšåˆ
    â”œâ”€â”€ rag.ts             # RAG ç›¸å…³é…ç½®
    â”œâ”€â”€ prompt.ts          # æç¤ºè¯æ¨¡æ¿é…ç½®
    â””â”€â”€ ...
```

### 2.3 [L2] Data Layer (`src/data`)
è´Ÿè´£æ•°æ®çš„æœ¬åœ°æŒä¹…åŒ–å­˜å‚¨ã€‚

```
src/data/
â”œâ”€â”€ db.ts                  # Dexie æ•°æ®åº“å®šä¹‰ (EngramDB)
â”œâ”€â”€ ChatManager.ts         # èŠå¤©ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”œâ”€â”€ cleanup/               # æ•°æ®æ¸…ç†æœåŠ¡
â”œâ”€â”€ repositories/          # æ•°æ®ä»“å‚¨å±‚ (Repository Pattern)
â””â”€â”€ sync/                  # æ•°æ®åŒæ­¥æœåŠ¡
```

### 2.4 [L3] Integrations Layer (`src/integrations`)
é˜²è…å±‚ï¼Œéš”ç¦»å¤–éƒ¨ä¾èµ–å˜æ¢ã€‚

```
src/integrations/
â”œâ”€â”€ tavern/                # SillyTavern å®¿ä¸»é€‚é…
â”‚   â”œâ”€â”€ bridge.ts          # Window å¯¹è±¡æ¡¥æ¥ (ST äº¤äº’æ ¸å¿ƒ)
â”‚   â”œâ”€â”€ context.ts         # ä¸Šä¸‹æ–‡è·å– (Chat, Character)
â”‚   â”œâ”€â”€ macros.ts          # å®æ³¨å†ŒæœåŠ¡ (Register Macros)
â”‚   â”œâ”€â”€ events.ts          # é…’é¦†äº‹ä»¶ç›‘å¬
â”‚   â”œâ”€â”€ api/               # å®¿ä¸» API å°è£… (Message, Extension)
â”‚   â””â”€â”€ worldbook/         # ä¸–ç•Œä¹¦æ·±åº¦é›†æˆæ¨¡å—
â”‚       â”œâ”€â”€ adapter.ts     # é€‚é…å™¨
â”‚       â”œâ”€â”€ crud.ts        # å¢åˆ æ”¹æŸ¥é€»è¾‘
â”‚       â”œâ”€â”€ engram.ts      # Engram ä¸“ç”¨ä¸–ç•Œä¹¦é€»è¾‘
â”‚       â”œâ”€â”€ scanner.ts     # æ‰«æå™¨
â”‚       â””â”€â”€ metrics.ts     # æŒ‡æ ‡ç»Ÿè®¡
â””â”€â”€ llm/                   # LLM æœåŠ¡é€‚é…
    â”œâ”€â”€ Adapter.ts         # LLM ç»Ÿä¸€è°ƒç”¨é€‚é…å™¨
    â””â”€â”€ SystemPrompts/     # å†…ç½®æç¤ºè¯æ–‡ä»¶ (.md)
```

### 2.5 [L4] Modules Layer (`src/modules`)
æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ŒæŒ‰åŠŸèƒ½å‚ç›´åˆ‡åˆ†ã€‚

#### Workflow (å·¥ä½œæµå¼•æ“)
è´Ÿè´£ç¼–æ’å’Œæ‰§è¡Œå¤æ‚çš„ä¸šåŠ¡é€»è¾‘é“¾ã€‚
```
src/modules/workflow/
â”œâ”€â”€ Pipeline.ts            # (Old) ç®€å• Pipelineï¼Œä¸»è¦ç”¨äº Summarizer ç»“æœè§£æ
â”œâ”€â”€ core/                  # æ–°ç‰ˆå·¥ä½œæµå¼•æ“
â”‚   â”œâ”€â”€ WorkflowEngine.ts  # æ‰§è¡Œå¼•æ“ (æ”¯æŒè·³è½¬ã€ç»ˆæ­¢)
â”‚   â”œâ”€â”€ JobContext.ts      # ä»»åŠ¡ä¸Šä¸‹æ–‡å®šä¹‰
â”‚   â””â”€â”€ Step.ts            # æ­¥éª¤æ¥å£å®šä¹‰
â”œâ”€â”€ definitions/           # é¢„å®šä¹‰å·¥ä½œæµ
â”‚   â”œâ”€â”€ EntityWorkflow.ts  # å®ä½“æå–æµ
â”‚   â”œâ”€â”€ SummaryWorkflow.ts # æ€»ç»“ç”Ÿæˆæµ
â”‚   â””â”€â”€ ...
â””â”€â”€ steps/                 # åŸå­æ­¥éª¤åº“
    â”œâ”€â”€ context/           # è·å–ä¸Šä¸‹æ–‡ (GetChatHistory)
    â”œâ”€â”€ execution/         # æ‰§è¡Œæ“ä½œ (LLMRequest)
    â”œâ”€â”€ interaction/       # ç”¨æˆ·äº¤äº’ (UserReview)
    â”œâ”€â”€ persistence/       # æŒä¹…åŒ– (SaveEntity)
    â””â”€â”€ processing/        # æ•°æ®å¤„ç† (ParseJSON)
```

#### RAG & Search (æ£€ç´¢ä¸æœç´¢)
```
src/modules/
â”œâ”€â”€ rag/                   # RAG æ ¸å¿ƒ
â”‚   â”œâ”€â”€ retrieval/         # å¬å›ç­–ç•¥ (BrainRecallCache, Hybrid)
â”‚   â”œâ”€â”€ embedding/         # å‘é‡åŒ–æœåŠ¡ (EmbeddingService)
â”‚   â””â”€â”€ injection/         # ä¸Šä¸‹æ–‡æ³¨å…¥ (Injector)
â””â”€â”€ search/                # æœç´¢åŸºç¡€æœåŠ¡
    â”œâ”€â”€ SearchService.ts   # æœç´¢æœåŠ¡å…¥å£
    â””â”€â”€ adapters/          # æœç´¢å¼•æ“é€‚é…
```

#### Memory & Processing (è®°å¿†ä¸å¤„ç†)
```
src/modules/
â”œâ”€â”€ memory/                # è®°å¿†ç®¡ç†
â”‚   â”œâ”€â”€ Summarizer.ts      # å‰§æƒ…æ€»ç»“ç”ŸæˆæœåŠ¡
â”‚   â”œâ”€â”€ EntityExtractor.ts # å®ä½“æå–æœåŠ¡ (Facade)
â”‚   â”œâ”€â”€ Trimmer.ts         # è®°å¿†ç²¾ç®€é€»è¾‘
â”‚   â””â”€â”€ ...
â”œâ”€â”€ preprocessing/         # è¾“å…¥é¢„å¤„ç†
â”‚   â”œâ”€â”€ Preprocessor.ts    # é¢„å¤„ç†ä¸»æ§
â””â”€â”€ batch/                 # æ‰¹å¤„ç†ç³»ç»Ÿ
    â””â”€â”€ BatchProcessor.ts  # ä»»åŠ¡é˜Ÿåˆ—å¤„ç†å™¨
```

### 2.6 [L5] State Layer (`src/state`)
UI çŠ¶æ€ç®¡ç†ï¼Œä½œä¸º MVC ä¸­çš„ Controllerã€‚

```
src/state/
â”œâ”€â”€ memoryStore.ts         # æ ¸å¿ƒè®°å¿†çŠ¶æ€ (CRUD, è¿‡æ»¤, æ’åº)
â”œâ”€â”€ devLogStore.ts         # å¼€å‘æ—¥å¿—çŠ¶æ€
â”œâ”€â”€ themeStore.ts          # ä¸»é¢˜ä¸å¤–è§‚çŠ¶æ€
â””â”€â”€ index.ts               # çŠ¶æ€å¯¼å‡º
```

### 2.7 [L6] UI Layer (`src/ui`)
React è§†å›¾ä¸äº¤äº’ç»„ä»¶ã€‚

```
src/ui/
â”œâ”€â”€ components/            # é€šç”¨ç»„ä»¶åº“
â”‚   â”œâ”€â”€ core/              # æ ¸å¿ƒåŸºç¡€ç»„ä»¶ (Button, Input, SliderField)
â”‚   â”œâ”€â”€ display/           # å±•ç¤ºç±»ç»„ä»¶ (Card, Badge)
â”‚   â”œâ”€â”€ feedback/          # åé¦ˆç±»ç»„ä»¶ (Modal, Toast)
â”‚   â””â”€â”€ layout/            # å¸ƒå±€ç»„ä»¶ (MasterDetail)
â”œâ”€â”€ hooks/                 # ä¸šåŠ¡ Hooks
â”‚   â”œâ”€â”€ useDashboardData.ts # ä»ªè¡¨ç›˜æ•°æ®èšåˆ
â”‚   â””â”€â”€ ...
â””â”€â”€ views/                 # é¡µé¢è§†å›¾
    â”œâ”€â”€ dashboard/         # æ¦‚è§ˆä»ªè¡¨ç›˜
    â”œâ”€â”€ memory-stream/     # è®°å¿†æµå¯è§†åŒ– (æ ¸å¿ƒè§†å›¾)
    â”œâ”€â”€ processing/        # å¤„ç†é¢æ¿ (Review Modal)
    â””â”€â”€ api-presets/       # API ä¸æç¤ºè¯é…ç½®
```

---

### `core/` - æ ¸å¿ƒå±‚
æ•´ä¸ªç³»ç»Ÿçš„åŸºçŸ³ï¼Œå®šä¹‰äº†æ•°æ®æµåŠ¨çš„åŸºæœ¬å¥‘çº¦ã€‚
- **Events**: å®šä¹‰äº†åº”ç”¨å†…é€šä¿¡çš„äº‹ä»¶ç±»å‹ã€‚
- **Types**: åŒ…å«è·¨å±‚çº§ä½¿ç”¨çš„é€šç”¨æ¥å£å®šä¹‰ã€‚

### `config/` - é…ç½®å±‚
è´Ÿè´£åº”ç”¨é…ç½®çš„å®šä¹‰ã€é»˜è®¤å€¼å’ŒæŒä¹…åŒ–è¯»å†™ã€‚
- **SettingsManager**: ç»Ÿä¸€ç®¡ç†æ‰©å±•é…ç½®çš„è¯»å†™ï¼Œå¯¹æ¥ SillyTavern çš„ `extensionSettings`ã€‚

### `data/` - æ•°æ®å±‚
è´Ÿè´£æ•°æ®çš„æœ¬åœ°æŒä¹…åŒ–ã€‚
- **EngramDB**: åŸºäº Dexie.js çš„ IndexedDB å°è£…ã€‚
- **ChatManager**: ç®¡ç†å½“å‰èŠå¤©ä¼šè¯çš„çŠ¶æ€å’Œå…ƒæ•°æ®ã€‚

### `integrations/` - é›†æˆå±‚
å……å½“é˜²è…å±‚ (Anti-Corruption Layer)ï¼Œéš”ç¦»å¤–éƒ¨ç³»ç»Ÿå˜åŒ–å¯¹æ ¸å¿ƒé€»è¾‘çš„å½±å“ã€‚
- **Tavern**: å°è£… SillyTavern çš„å…¨å±€å˜é‡å’Œ API è°ƒç”¨ã€‚
- **LLM**: å°è£…ä¸åŒ LLM åç«¯çš„è°ƒç”¨å·®å¼‚ï¼Œæä¾›ç»Ÿä¸€çš„ `generate` æ¥å£ã€‚

### `modules/` - æ¨¡å—å±‚ (ä¸šåŠ¡æ ¸å¿ƒ)
åŒ…å«ç‹¬ç«‹çš„åŠŸèƒ½æ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—ç”± `index.ts` å¯¼å‡ºå…¬å…± APIã€‚

| æ¨¡å— | èŒè´£ | å…³é”®å¯¼å‡º |
|------|------|----------|
| **rag** | æ£€ç´¢å¢å¼ºç”Ÿæˆ | `Retriever`, `VectorService`, `Reranker` |
| **summarizer** | å‰§æƒ…æ€»ç»“ | `SummarizerService`, `SummaryWorker` |
| **preprocessing** | è¾“å…¥é¢„å¤„ç† | `Preprocessor` |
| **graph** | å®ä½“ä¸å›¾è°± | `EntityBuilder`, `GraphService` |
| **batch** | æ‰¹å¤„ç†ä»»åŠ¡ | `BatchProcessor`, `BatchQueue` |

### `state/` - çŠ¶æ€å±‚
è¿æ¥ä¸šåŠ¡é€»è¾‘ä¸ UIï¼Œä½¿ç”¨ Zustand å®ç°å“åº”å¼çŠ¶æ€ç®¡ç†ã€‚
- **memoryStore**: åº”ç”¨çš„æ ¸å¿ƒçŠ¶æ€ä»“åº“ï¼ŒUI ç»„ä»¶é€šè¿‡ Hooks è®¢é˜…æ­¤å¤„çš„å˜æ›´ã€‚

## ğŸ—ï¸ å…³é”®æ¨¡å—è¯´æ˜

### Workflow Engine
- **å®šä½**: ç³»ç»Ÿçš„é€»è¾‘ä¸­æ¢ï¼Œé€æ­¥æ›¿ä»£æ•£è½çš„ä¸šåŠ¡é€»è¾‘ã€‚
- **ç‰¹ç‚¹**: æ”¯æŒæ­¥éª¤å¤ç”¨ã€å¯è§†åŒ–è¿½è¸ªã€é”™è¯¯å¤„ç†å’Œç”¨æˆ·äº¤äº’æš‚åœã€‚
- **æ ¸å¿ƒæ–‡ä»¶**: `WorkflowEngine.ts`, `Step.ts`

### Tavern Integration (Worldbook)
- **å®šä½**: `src/integrations/tavern/worldbook` ä¸ä»…ä»…æ˜¯ API åŒ…è£…ï¼Œæ›´æ˜¯ Engram ä¸ SillyTavern ä¸–ç•Œä¹¦ç³»ç»Ÿçš„æ·±åº¦åŒæ­¥æ¨¡å—ã€‚
- **åŠŸèƒ½**: ç®¡ç† Engram ç”Ÿæˆçš„è¯æ¡ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰ï¼Œå¹¶åŒæ­¥å› SillyTavernï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚

### BrainRecallCache (RAG)
- **å®šä½**: `src/modules/rag/retrieval/BrainRecallCache.ts`
- **åŠŸèƒ½**: å®ç°äº†ç±»è„‘è®°å¿†æœºåˆ¶ï¼ˆçŸ­æœŸè®°å¿†ã€å·¥ä½œè®°å¿†ã€é—å¿˜æ›²çº¿ï¼‰ï¼Œè´Ÿè´£ç®¡ç† RAG å¬å›çš„ä¸Šä¸‹æ–‡çª—å£ã€‚

---

## ğŸ”Œ æœåŠ¡è¿ç§»æ˜ å°„

| æœåŠ¡åç§° | å½“å‰ä½ç½® | å¤‡æ³¨ |
|----------|----------|------|
| `WorkflowEngine` | `src/modules/workflow/core/WorkflowEngine.ts` | **æ–°å¢æ ¸å¿ƒ** |
| `BrainRecallCache` | `src/modules/rag/retrieval/BrainRecallCache.ts` | **æ–°å¢æ ¸å¿ƒ** |
| `WorldInfoService` | `src/integrations/tavern/worldbook/index.ts` | æ·±åº¦é‡æ„ |
| `Pipeline` | `src/modules/workflow/Pipeline.ts` | é—ç•™/ç‰¹å®šç”¨é€” (Summarizer) |
| `SearchService` | `src/modules/search/SearchService.ts` | ç‹¬ç«‹æ¨¡å— |
