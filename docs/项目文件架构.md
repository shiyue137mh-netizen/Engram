# Engram é¡¹ç›®æ–‡ä»¶æ¶æ„

> åŸºäº **React + Vite + TypeScript** + **Tailwind CSS**
> **Version**: v0.9.9 (Layered Architecture)

---

# Engram é¡¹ç›®æ–‡ä»¶æ¶æ„

> åŸºäº **React + Vite + TypeScript** + **Tailwind CSS**
> **Version**: v0.9.9 (Layered Modular Architecture)

---

## 1. é¡¶å±‚æ¶æ„æ¦‚è§ˆ (High-Level Overview)

```
src/
â”œâ”€â”€ core/                  # [L0] æ ¸å¿ƒå±‚ï¼šåŸºç¡€ç±»å‹ã€äº‹ä»¶æ€»çº¿ã€å·¥å…·åº“
â”œâ”€â”€ config/                # [L1] é…ç½®å±‚ï¼šè®¾ç½®ç®¡ç† (SettingsManager)
â”œâ”€â”€ data/                  # [L2] æ•°æ®å±‚ï¼šIndexedDB å®šä¹‰ä¸èŠå¤©ç®¡ç†
â”œâ”€â”€ integrations/          # [L3] é›†æˆå±‚ï¼šå¤–éƒ¨ç³»ç»Ÿé€‚é… (SillyTavern, LLM)
â”œâ”€â”€ modules/               # [L4] æ¨¡å—å±‚ï¼šæ ¸å¿ƒä¸šåŠ¡é€»è¾‘å•å…ƒ
â”‚   â”œâ”€â”€ batch/             # æ‰¹å¤„ç†
â”‚   â”œâ”€â”€ memory/            # è®°å¿†ç®¡ç† (Extract, Summarize, Trim)
â”‚   â”œâ”€â”€ preprocessing/     # è¾“å…¥é¢„å¤„ç†
â”‚   â”œâ”€â”€ rag/               # Graph RAG æ£€ç´¢
â”‚   â”œâ”€â”€ search/            # æœç´¢æœåŠ¡ (æš‚ç•™)
â”‚    â””â”€â”€ workflow/          # ä»»åŠ¡æµç¼–æ’
        â”œâ”€â”€ core/          # å·¥ä½œæµå¼•æ“æ ¸å¿ƒ (Engine, Step, JobContext)
        â”œâ”€â”€ definitions/   # é¢„å®šä¹‰å·¥ä½œæµ (Entity, Summary, Preprocess)
        â”œâ”€â”€ processors/    # æ–‡æœ¬/æ­£åˆ™å¤„ç†å™¨
        â””â”€â”€ steps/         # åŸå­æ­¥éª¤åº“
            â”œâ”€â”€ context/       # ä¸Šä¸‹æ–‡è·å– (Chat, WorldInfo, Prompt)
            â”œâ”€â”€ execution/     # å¤–éƒ¨æ‰§è¡Œ (LLM Request)
            â”œâ”€â”€ interaction/   # ç”¨æˆ·äº¤äº’ (Review)
            â”œâ”€â”€ persistence/   # æŒä¹…åŒ– (Save Entity/Event)
            â””â”€â”€ processing/    # æ•°æ®å¤„ç† (JSON Parse, Regex)
â”œâ”€â”€ state/                 # [L5] çŠ¶æ€å±‚ï¼šZustand Store
â””â”€â”€ ui/                    # [L6] è¡¨ç°å±‚ï¼šReact ç»„ä»¶ä¸è§†å›¾
```

---

## 2. è¯¦ç»†ç›®å½•ç»“æ„ (Detailed Structure)

### 2.1 [L0] Core Layer (`src/core`)
ç³»ç»Ÿæœ€åº•å±‚çš„å¥‘çº¦ï¼Œä¸ä¾èµ–ä»»ä½•å…¶ä»–å±‚çº§ã€‚

```
src/core/
â”œâ”€â”€ events/                # äº‹ä»¶æ€»çº¿å®šä¹‰
â”œâ”€â”€ logger/                # æ—¥å¿—ç³»ç»Ÿ
â”œâ”€â”€ types/                 # å…¨å±€ç±»å‹å®šä¹‰
â”œâ”€â”€ updater/               # æ›´æ–°æ£€æŸ¥å™¨
â””â”€â”€ utils/                 # é€šç”¨å·¥å…·å‡½æ•°
```

### 2.2 [L1] Config Layer (`src/config`)
è´Ÿè´£é…ç½®çš„å®šä¹‰ã€é»˜è®¤å€¼å’Œè¯»å†™ã€‚

```
src/config/
â”œâ”€â”€ settings.ts            # SettingsManager (å¯¹æ¥ extension_settings)
â””â”€â”€ types/                 # é…ç½®æ¥å£å®šä¹‰
    â”œâ”€â”€ defaults.ts        # é»˜è®¤å€¼èšåˆ
    â”œâ”€â”€ rag.ts             # RAG ç›¸å…³é…ç½®
    â””â”€â”€ prompt.ts          # æç¤ºè¯æ¨¡æ¿é…ç½®
```

### 2.3 [L2] Data Layer (`src/data`)
è´Ÿè´£æ•°æ®çš„æœ¬åœ°æŒä¹…åŒ–å­˜å‚¨ã€‚

```
src/data/
â”œâ”€â”€ db.ts                  # Dexie æ•°æ®åº“å®šä¹‰ (EngramDB)
â”œâ”€â”€ ChatManager.ts         # èŠå¤©ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”œâ”€â”€ cleanup/               # æ•°æ®æ¸…ç†æœåŠ¡
â”œâ”€â”€ repositories/          # æ•°æ®ä»“å‚¨å±‚ (Repository Pattern)
â””â”€â”€ sync/                  # æ•°æ®åŒæ­¥æœåŠ¡
```

### 2.4 [L3] Integrations Layer (`src/integrations`)
é˜²è…å±‚ï¼Œéš”ç¦»å¤–éƒ¨ä¾èµ–å˜æ¢ã€‚

```
src/integrations/
â”œâ”€â”€ tavern/                # SillyTavern å®¿ä¸»é€‚é…
â”‚   â”œâ”€â”€ bridge.ts          # Window å¯¹è±¡æ¡¥æ¥
â”‚   â”œâ”€â”€ context.ts         # ä¸Šä¸‹æ–‡è·å– (Chat, Character)
â”‚   â”œâ”€â”€ macros.ts          # å®æ³¨å†ŒæœåŠ¡
â”‚   â”œâ”€â”€ events.ts          # é…’é¦†äº‹ä»¶ç›‘å¬
â”‚   â””â”€â”€ api/               # å®¿ä¸» API å°è£… (Message, WorldInfo)
â””â”€â”€ llm/                   # LLM æœåŠ¡é€‚é…
    â”œâ”€â”€ Adapter.ts         # LLM ç»Ÿä¸€è°ƒç”¨é€‚é…å™¨
    â””â”€â”€ SystemPrompts/     # å†…ç½®æç¤ºè¯æ–‡ä»¶ (.md)
```

### 2.5 [L4] Modules Layer (`src/modules`)
æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ŒæŒ‰åŠŸèƒ½å‚ç›´åˆ‡åˆ†ã€‚

```
src/modules/
â”œâ”€â”€ batch/                 # æ‰¹å¤„ç†ç³»ç»Ÿ
â”‚   â””â”€â”€ BatchProcessor.ts  # ä»»åŠ¡é˜Ÿåˆ—å¤„ç†å™¨
â”œâ”€â”€ memory/                # è®°å¿†ç®¡ç†
â”‚   â”œâ”€â”€ Summarizer.ts      # å‰§æƒ…æ€»ç»“ç”Ÿæˆ
â”‚   â”œâ”€â”€ Trimmer.ts         # è®°å¿†ç²¾ç®€é€»è¾‘
â”‚   â”œâ”€â”€ EventTrimmer.ts    # ç²¾ç®€æœåŠ¡é—¨é¢
â”‚   â””â”€â”€ extractors/        # ä¿¡æ¯æå–å™¨
â”‚       â”œâ”€â”€ EntityExtractor.ts # å®ä½“æå– (åŸ EntityBuilder)
â”‚       â””â”€â”€ TextProcessor.ts   # æ–‡æœ¬å¤„ç†
â”œâ”€â”€ preprocessing/         # è¾“å…¥é¢„å¤„ç†
â”‚   â”œâ”€â”€ Preprocessor.ts    # é¢„å¤„ç†ä¸»æ§
â”‚   â””â”€â”€ OutputParser.ts    # è¾“å‡ºè§£æ
â””â”€â”€ rag/                   # æ£€ç´¢å¢å¼ºç”Ÿæˆ
    â”œâ”€â”€ retrieval/         # å¬å›ç­–ç•¥ (Retriever, HybridScorer)
    â”œâ”€â”€ embedding/         # å‘é‡åŒ–æœåŠ¡ (EmbeddingService)
    â””â”€â”€ injection/         # ä¸Šä¸‹æ–‡æ³¨å…¥ (Injector)
```

### 2.6 [L5] State Layer (`src/state`)
UI çŠ¶æ€ç®¡ç†ï¼Œä½œä¸º MVC ä¸­çš„ Controllerã€‚

```
src/state/
â”œâ”€â”€ memoryStore.ts         # æ ¸å¿ƒè®°å¿†çŠ¶æ€ (CRUD, è¿‡æ»¤, æ’åº)
â”œâ”€â”€ devLogStore.ts         # å¼€å‘æ—¥å¿—çŠ¶æ€
â”œâ”€â”€ themeStore.ts          # ä¸»é¢˜ä¸å¤–è§‚çŠ¶æ€
â””â”€â”€ index.ts               # çŠ¶æ€å¯¼å‡º
```

### 2.7 [L6] UI Layer (`src/ui`)
React è§†å›¾ä¸äº¤äº’ç»„ä»¶ã€‚

```
src/ui/
â”œâ”€â”€ assets/                # é™æ€èµ„æº (Icons, GlobalStyles)
â”œâ”€â”€ components/            # é€šç”¨ç»„ä»¶åº“
â”‚   â”œâ”€â”€ ui/                # åŸå­ç»„ä»¶
â”‚   â””â”€â”€ layout/            # å¸ƒå±€ç»„ä»¶
â”œâ”€â”€ hooks/                 # ä¸šåŠ¡ Hooks
â”‚   â”œâ”€â”€ useConfig.ts       # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ useWorkflow.ts     # å·¥ä½œæµçŠ¶æ€
â”‚   â”œâ”€â”€ useWorldInfo.ts    # ä¸–ç•Œä¹¦ç®¡ç†
â”‚   â””â”€â”€ useRag.ts          # RAG äº¤äº’
â””â”€â”€ views/                 # é¡µé¢è§†å›¾
    â”œâ”€â”€ dashboard/         # æ¦‚è§ˆä»ªè¡¨ç›˜
    â”œâ”€â”€ processing/        # å¤„ç†é¢æ¿
    â”œâ”€â”€ memory-stream/     # è®°å¿†æµå¯è§†åŒ–
    â””â”€â”€ api-presets/       # API ä¸æç¤ºè¯é…ç½®
        â””â”€â”€ components/    # é…ç½®ç»„ä»¶
            â”œâ”€â”€ WorldbookProfileList.tsx # çŸ¥è¯†åº“æ–¹æ¡ˆåˆ—è¡¨
            â””â”€â”€ WorldbookProfileForm.tsx # çŸ¥è¯†åº“æ–¹æ¡ˆç¼–è¾‘
```

---

## ğŸ› ï¸ æ¨¡å—èŒè´£è¯¦è§£

### `core/` - æ ¸å¿ƒå±‚
æ•´ä¸ªç³»ç»Ÿçš„åŸºçŸ³ï¼Œå®šä¹‰äº†æ•°æ®æµåŠ¨çš„åŸºæœ¬å¥‘çº¦ã€‚
- **Events**: å®šä¹‰äº†åº”ç”¨å†…é€šä¿¡çš„äº‹ä»¶ç±»å‹ã€‚
- **Types**: åŒ…å«è·¨å±‚çº§ä½¿ç”¨çš„é€šç”¨æ¥å£å®šä¹‰ã€‚

### `config/` - é…ç½®å±‚
è´Ÿè´£åº”ç”¨é…ç½®çš„å®šä¹‰ã€é»˜è®¤å€¼å’ŒæŒä¹…åŒ–è¯»å†™ã€‚
- **SettingsManager**: ç»Ÿä¸€ç®¡ç†æ‰©å±•é…ç½®çš„è¯»å†™ï¼Œå¯¹æ¥ SillyTavern çš„ `extensionSettings`ã€‚

### `data/` - æ•°æ®å±‚
è´Ÿè´£æ•°æ®çš„æœ¬åœ°æŒä¹…åŒ–ã€‚
- **EngramDB**: åŸºäº Dexie.js çš„ IndexedDB å°è£…ã€‚
- **ChatManager**: ç®¡ç†å½“å‰èŠå¤©ä¼šè¯çš„çŠ¶æ€å’Œå…ƒæ•°æ®ã€‚

### `integrations/` - é›†æˆå±‚
å……å½“é˜²è…å±‚ (Anti-Corruption Layer)ï¼Œéš”ç¦»å¤–éƒ¨ç³»ç»Ÿå˜åŒ–å¯¹æ ¸å¿ƒé€»è¾‘çš„å½±å“ã€‚
- **Tavern**: å°è£… SillyTavern çš„å…¨å±€å˜é‡å’Œ API è°ƒç”¨ã€‚
- **LLM**: å°è£…ä¸åŒ LLM åç«¯çš„è°ƒç”¨å·®å¼‚ï¼Œæä¾›ç»Ÿä¸€çš„ `generate` æ¥å£ã€‚

### `modules/` - æ¨¡å—å±‚ (ä¸šåŠ¡æ ¸å¿ƒ)
åŒ…å«ç‹¬ç«‹çš„åŠŸèƒ½æ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—ç”± `index.ts` å¯¼å‡ºå…¬å…± APIã€‚

| æ¨¡å— | èŒè´£ | å…³é”®å¯¼å‡º |
|------|------|----------|
| **rag** | æ£€ç´¢å¢å¼ºç”Ÿæˆ | `Retriever`, `VectorService`, `Reranker` |
| **summarizer** | å‰§æƒ…æ€»ç»“ | `SummarizerService`, `SummaryWorker` |
| **preprocessing** | è¾“å…¥é¢„å¤„ç† | `Preprocessor`, `OutputParser` |
| **graph** | å®ä½“ä¸å›¾è°± | `EntityBuilder`, `GraphService` |
| **batch** | æ‰¹å¤„ç†ä»»åŠ¡ | `BatchProcessor`, `BatchQueue` |

### `state/` - çŠ¶æ€å±‚
è¿æ¥ä¸šåŠ¡é€»è¾‘ä¸ UIï¼Œä½¿ç”¨ Zustand å®ç°å“åº”å¼çŠ¶æ€ç®¡ç†ã€‚
- **memoryStore**: åº”ç”¨çš„æ ¸å¿ƒçŠ¶æ€ä»“åº“ï¼ŒUI ç»„ä»¶é€šè¿‡ Hooks è®¢é˜…æ­¤å¤„çš„å˜æ›´ã€‚

### `ui/` - è¡¨ç°å±‚
åŸºäº React çš„ç”¨æˆ·ç•Œé¢ï¼Œé‡‡ç”¨åŸå­åŒ–ç»„ä»¶è®¾è®¡ã€‚
- **hooks**: å°è£… UI äº¤äº’é€»è¾‘ï¼Œå¦‚ `useConfig` (é…ç½®ç®¡ç†), `useWorkflow` (æ‰¹å¤„ç†çŠ¶æ€)ã€‚
- **views**: å¯¹åº”ä¾§è¾¹æ çš„ä¸åŒåŠŸèƒ½é¢æ¿ã€‚

---

## ğŸ—ï¸ åˆ†å±‚ä¾èµ–è§„åˆ™

ç³»ç»Ÿéµå¾ªä¸¥æ ¼çš„å•å‘ä¾èµ–åŸåˆ™ï¼š

1. **ä¸Šå±‚å¯ä¾èµ–ä¸‹å±‚**ï¼š`ui` -> `state` -> `modules` -> `integrations` -> `data` -> `config` -> `core`
2. **åŒå±‚åŸåˆ™ä¸Šäº’ä¸ä¾èµ–**ï¼šæ¨¡å—ä¹‹é—´åº”ä¿æŒç‹¬ç«‹ï¼Œé€šè¿‡ `core/events` è¿›è¡Œé€šä¿¡ã€‚
3. **ä¸‹å±‚ä¸å¯ä¾èµ–ä¸Šå±‚**ï¼šä¾‹å¦‚ `modules` ä¸èƒ½å¯¼å…¥ `ui` æˆ– `state` ä¸­çš„ä»£ç ã€‚
4. **è·¨å±‚ç©¿é€**ï¼š`ui` å±‚å¯ä»¥ç›´æ¥ä½¿ç”¨ `core` å’Œ `config` ä¸­çš„ç±»å‹å’Œå¸¸é‡ã€‚

```mermaid
graph TD
    UI[L6 UI è¡¨ç°å±‚] --> State[L5 State çŠ¶æ€å±‚]
    State --> Modules[L4 Modules æ¨¡å—å±‚]
    Modules --> Integrations[L3 Integrations é›†æˆå±‚]
    Modules --> Data[L2 Data æ•°æ®å±‚]
    Integrations --> Data
    Data --> Config[L1 Config é…ç½®å±‚]
    Config --> Core[L0 Core æ ¸å¿ƒå±‚]
```

---

## ğŸ”Œ å…³é”®æœåŠ¡ç´¢å¼•

| æœåŠ¡åç§° | æ–°ä½ç½® | åŸä½ç½® (v0.8) |
|----------|--------|---------------|
| `SettingsManager` | `src/config/settings.ts` | `services/settings/Persistence.ts` |
| `SummarizerService` | `src/modules/summarizer/SummarizerService.ts` | `services/summarizer/SummarizerService.ts` |
| `LLMAdapter` | `src/integrations/llm/Adapter.ts` | `services/api/LLMAdapter.ts` |
| `ChatManager` | `src/data/ChatManager.ts` | `services/database/ChatManager.ts` |
| `Preprocessor` | `src/modules/preprocessing/Preprocessor.ts` | `services/preprocessing/Preprocessor.ts` |
| `Retriever` | `src/modules/rag/retrieval/Retriever.ts` | `services/rag/Retriever.ts` |
