# Engram å·¥ç¨‹ç›®å½•ç»“æ„æŒ‡å—

> æ­¤ç›®å½•ç»“æ„åŸºäº **React + Vite + TypeScript**ï¼Œé‡‡ç”¨ **DDD (é¢†åŸŸé©±åŠ¨è®¾è®¡)** åˆ†å±‚ï¼Œå°†æ ¸å¿ƒé€»è¾‘ä¸ UI å½»åº•è§£è€¦ã€‚

---

## ğŸ“ ç›®å½•ç»“æ„æ€»è§ˆ

```
/
â”œâ”€â”€ assets/                    # é™æ€èµ„æº
â”‚   â””â”€â”€ logo/                  # Logo æ–‡ä»¶
â”‚       â”œâ”€â”€ Engram_icon.svg    # å›¾æ ‡ (æ‚¬æµ®çƒ)
â”‚       â”œâ”€â”€ Engram_logo.svg    # å®Œæ•´ logo (é¢æ¿å¤´éƒ¨)
â”‚       â””â”€â”€ Engram_textlogo.svg# æ–‡å­— logo
â”‚
â”œâ”€â”€ src/
â”‚   â”‚
â”‚   â”‚   // â•â•â• L4: åŸºç¡€è®¾æ–½å±‚ (Infrastructure) â•â•â•
â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”œâ”€â”€ bus/               # äº‹ä»¶æ€»çº¿ (RxJS)
â”‚   â”‚   â”‚   â””â”€â”€ EventBus.ts    
â”‚   â”‚   â”œâ”€â”€ storage/           # æ•°æ®åº“é€‚é…å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ DexieDB.ts     # IndexedDB å®ä¾‹ (Graph Storage)
â”‚   â”‚   â”‚   â””â”€â”€ VectorDB.ts    # Voy å®ä¾‹ (Vector Storage)
â”‚   â”‚   â””â”€â”€ adapter/           # å¤–éƒ¨ç³»ç»Ÿé€‚é…å™¨
â”‚   â”‚       â”œâ”€â”€ STBridge.ts    # SillyTavern API æ¡¥æ¥ (jQuery Hooks)
â”‚   â”‚       â””â”€â”€ LLMAdapter.ts  # ç»Ÿä¸€ LLM è°ƒç”¨æ¥å£
â”‚   â”‚
â”‚   â”‚   // â•â•â• L3: é¢†åŸŸæ ¸å¿ƒå±‚ (Domain / Core) â•â•â•
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ pipeline/          # æ•°æ®å¤„ç†æµæ°´çº¿
â”‚   â”‚   â”‚   â”œâ”€â”€ Pipeline.ts    # ç®¡é“æ§åˆ¶å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ steps/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Summarizer.ts  # LLM æ€»ç»“ & å®ä½“æå–
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GraphBuilder.ts# æ„å»ºå›¾è°±èŠ‚ç‚¹ä¸è¾¹
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Vectorizer.ts  # è®¡ç®— Embedding
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ rag/               # RAG æ ¸å¿ƒç®—æ³•
â”‚   â”‚   â”‚   â”œâ”€â”€ Retriever.ts   # æ··åˆæ£€ç´¢å™¨ (Graph + Vector)
â”‚   â”‚   â”‚   â””â”€â”€ Reranker.ts    # é‡æ’åºé€»è¾‘
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ manager/           # çŠ¶æ€ç®¡ç†å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ BrainManager.ts # åˆ†è„‘é€»è¾‘ (Context Switching)
â”‚   â”‚   â”‚   â””â”€â”€ ConfigManager.ts# é…ç½®æŒä¹…åŒ–
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ types/             # é¢†åŸŸæ¨¡å‹å®šä¹‰
â”‚   â”‚       â”œâ”€â”€ graph.d.ts     # EntityNode, EventNode å®šä¹‰
â”‚   â”‚       â””â”€â”€ events.d.ts    # ç³»ç»Ÿäº‹ä»¶å®šä¹‰
â”‚   â”‚
â”‚   â”‚   // â•â•â• L2: åº”ç”¨å±‚ (Application / Hooks) â•â•â•
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useGraphData.ts    # è®¢é˜…å›¾è°±æ•°æ® (ç”¨äº React Flow)
â”‚   â”‚   â”œâ”€â”€ useMemoryStream.ts # è®¢é˜…è®°å¿†æµ (ç”¨äºåˆ—è¡¨å±•ç¤º)
â”‚   â”‚   â””â”€â”€ useIngestion.ts    # æ§åˆ¶æ‘„å…¥çŠ¶æ€
â”‚   â”‚
â”‚   â”‚   // â•â•â• L1: è¡¨ç°å±‚ (Presentation / UI) â•â•â•
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ core/              # æ ¸å¿ƒ UI å®¹å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ FloatingOrb.tsx # æ‚¬æµ®çƒå…¥å£ (Logo æ”¾ç½®å¤„)
â”‚   â”‚   â”‚   â””â”€â”€ MainPanel.tsx   # ä¸»é¢æ¿ Frame
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ graph/             # å›¾è°±å¯è§†åŒ–ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ WorldEditor.tsx # React Flow ç”»å¸ƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ CustomNodes.tsx # è‡ªå®šä¹‰èŠ‚ç‚¹æ ·å¼
â”‚   â”‚   â”‚   â””â”€â”€ ControlBar.tsx  # ç”»å¸ƒæ§åˆ¶å™¨
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ memory/            # è®°å¿†åˆ—è¡¨ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ MemoryCard.tsx
â”‚   â”‚   â”‚   â””â”€â”€ SearchBar.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ settings/          # è®¾ç½®é¡µé¢
â”‚   â”‚
â”‚   â”œâ”€â”€ App.tsx                # æ ¹ç»„ä»¶
â”‚   â”œâ”€â”€ main.tsx               # å…¥å£ (Mount Logic)
â”‚   â””â”€â”€ styles/                # CSS (Tailwind + eg- å‰ç¼€)
â”‚       â””â”€â”€ main.css           # ä¸»æ ·å¼å…¥å£
â”‚
â”œâ”€â”€ dist/                      # æ„å»ºè¾“å‡º
â”‚   â”œâ”€â”€ index.js               # æ‰“åŒ…åçš„ JS
â”‚   â””â”€â”€ style.css              # æ‰“åŒ…åçš„ CSS
â”‚
â”œâ”€â”€ manifest.json              # ST æ’ä»¶æ¸…å•
â”œâ”€â”€ vite.config.ts             # Vite é…ç½® (Library Mode)
â”œâ”€â”€ tailwind.config.js         # Tailwind é…ç½® (eg- å‰ç¼€)
â”œâ”€â”€ postcss.config.js          # PostCSS é…ç½®
â”œâ”€â”€ tsconfig.json
â””â”€â”€ package.json
```

---

## ğŸ”‘ å…³é”®æ¨¡å—èŒè´£è¯´æ˜

### 1. `src/core/pipeline/steps/GraphBuilder.ts`

> **è¿™æ˜¯ Engram çš„çµé­‚æ„å»ºè€…ã€‚**

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **è¾“å…¥** | `StoryEvent` (ä» Summarizer å‡ºæ¥çš„ JSON) |
| **èŒè´£** | 1. æ£€æŸ¥ `StoryEvent.meta.characters` é‡Œçš„åå­—ï¼Œå» `EntityTable` æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ã€‚ä¸å­˜åœ¨åˆ™åˆ›å»ºã€‚<br>2. åˆ›å»º `EventNode` å­˜å…¥ `MemoryTable`ã€‚<br>3. åœ¨ `EntityTable` å’Œ `MemoryTable` ä¹‹é—´å»ºç«‹å¼•ç”¨å…³ç³»ï¼ˆè¿™å°±æ˜¯å›¾çš„è¾¹ï¼‰ã€‚ |

---

### 2. `src/core/rag/Retriever.ts`

> **è¿™æ˜¯ Graph RAG çš„æ¶ˆè´¹è€…ã€‚**

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **èŒè´£** | å®ç° "Entity Anchoring" ç®—æ³•ã€‚å…ˆé€šè¿‡æ­£åˆ™/å…³é”®è¯åŒ¹é…æ‰¾åˆ°"æ¡©"(Entity)ï¼Œç„¶åæŠŠè¯¥æ¡©è¿ç€çš„æ‰€æœ‰"è‚‰"(Event) æ‹”å‡ºæ¥ã€‚ |

---

### 3. `src/components/graph/WorldEditor.tsx`

> **è¿™æ˜¯ Engram çš„å¯è§†åŒ–çª—å£ã€‚**

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **èŒè´£** | è¯»å– DexieDB ä¸­çš„ `EntityNodes` å’Œå®ƒä»¬ä¹‹é—´çš„å…³è”é¢‘ç‡ï¼Œæ¸²æŸ“æˆ React Flow å›¾è¡¨ã€‚ |

---

### 4. `src/infrastructure/adapter/STBridge.ts`

> **è¿™æ˜¯å”¯ä¸€çš„"è„ä»£ç "èšé›†åœ°ã€‚**

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **èŒè´£** | å¤„ç†æ‰€æœ‰ `window.SillyTavern`ã€`jQuery`ã€`eventSource` çš„äº¤äº’ã€‚åªè¦ ST çš„ API å˜äº†ï¼Œæˆ‘ä»¬åªæ”¹è¿™ä¸€ä¸ªæ–‡ä»¶ï¼Œå…¶ä»–æ–‡ä»¶å¤¹å®Œå…¨ä¸åŠ¨ã€‚ |

---

## ğŸ¨ UI èµ„æºè¯´æ˜

### Logo èµ„æº

| æ–‡ä»¶ | ç”¨é€” | ä½ç½® |
|------|------|------|
| `Engram_icon.svg` | æ‚¬æµ®çƒå›¾æ ‡ | `assets/logo/` |
| `Engram_logo.svg` | é¢æ¿å¤´éƒ¨å®Œæ•´ logo | `assets/logo/` |
| `Engram_textlogo.svg` | çº¯æ–‡å­— logo | `assets/logo/` |

### å›¾æ ‡åº“ - Lucide React

ä½¿ç”¨ [Lucide](https://lucide.dev/) ä½œä¸º UI å›¾æ ‡åº“ï¼Œæ”¯æŒ Tree-shakingï¼ŒæŒ‰éœ€å¯¼å…¥ã€‚

**ä½¿ç”¨æ–¹å¼**ï¼š
```tsx
import { X, Search, Settings, Brain, Database, Network } from 'lucide-react';

// é…åˆ Tailwind ä½¿ç”¨
<X className="eg-w-5 eg-h-5 eg-text-slate-400" />
```

**å¸¸ç”¨å›¾æ ‡**ï¼š
| å›¾æ ‡ | ç”¨é€” |
|------|------|
| `X` | å…³é—­æŒ‰é’® |
| `Search` | æœç´¢ |
| `Settings` | è®¾ç½® |
| `Plus` / `Trash2` | æ·»åŠ /åˆ é™¤ |
| `Database` | æ•°æ®åº“çŠ¶æ€ |
| `Network` | å›¾è°±è§†å›¾ |
| `Clock` | æ—¶é—´çº¿è§†å›¾ |

---

## ğŸ“Š åˆ†å±‚æ¶æ„å›¾

```mermaid
graph TB
    subgraph L1 [L1: è¡¨ç°å±‚]
        UI[React Components]
    end
    
    subgraph L2 [L2: åº”ç”¨å±‚]
        Hooks[React Hooks]
    end
    
    subgraph L3 [L3: é¢†åŸŸæ ¸å¿ƒå±‚]
        Pipeline[Pipeline]
        RAG[RAG Engine]
        Manager[Managers]
    end
    
    subgraph L4 [L4: åŸºç¡€è®¾æ–½å±‚]
        EventBus[EventBus]
        Storage[Storage]
        Adapter[Adapters]
    end
    
    UI --> Hooks
    Hooks --> Pipeline
    Hooks --> RAG
    Hooks --> Manager
    Pipeline --> Storage
    RAG --> Storage
    Manager --> EventBus
    Adapter --> Storage
```