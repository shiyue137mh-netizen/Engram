# Engram RAG å¬å›ç³»ç»Ÿå®Œå…¨æŒ‡å— (RAG Retrieval System Guide)

> **Version**: V0.9.5
> **Last Modified**: 2026-01-21

## 1. ç³»ç»Ÿæ¦‚è¿° (Overview)

Engram V0.9.5 çš„ RAG (Retrieval-Augmented Generation) å¬å›ç³»ç»Ÿæ—¨åœ¨è§£å†³è§’è‰²æ‰®æ¼”åœºæ™¯ä¸‹å¸¸è§çš„ã€Œæ£€ç´¢é¸¿æ²Ÿã€é—®é¢˜â€”â€”å³ç”¨æˆ·è¾“å…¥çš„çŸ­æ–‡æœ¬ï¼ˆåŠ¨ä½œã€ç®€çŸ­å¯¹è¯ï¼‰ä¸é•¿ç¯‡å‰§æƒ…è®°å¿†ï¼ˆè¯¦ç»†å™äº‹ã€ç¯å¢ƒæå†™ï¼‰ä¹‹é—´åœ¨è¯­ä¹‰å¯†åº¦å’Œè¡¨è¾¾æ–¹å¼ä¸Šçš„å·¨å¤§å·®å¼‚ã€‚

æœ¬ç³»ç»Ÿé‡‡ç”¨å¤šé˜¶æ®µæ··åˆæ£€ç´¢æ¶æ„ï¼Œç»“åˆäº† LLM é¢„å¤„ç†ã€å‘é‡æ£€ç´¢ (Embedding)ã€é‡æ’åº (Rerank) å’Œ**ç±»è„‘å¬å›ç¼“å­˜ (BrainRecallCache)**ï¼Œä»¥æä¾›ç²¾å‡†ä¸”è¿è´¯çš„è®°å¿†å¬å›ä½“éªŒã€‚

## 2. æ ¸å¿ƒæ¶æ„ (Core Architecture)

æ•´ä¸ªå¬å›æµç¨‹æ˜¯ä¸€ä¸ªç²¾å¯†çš„ Pipelineï¼ŒåŒ…å«å››ä¸ªä¸»è¦é˜¶æ®µï¼š

```mermaid
graph TD
    UserInput[ç”¨æˆ·è¾“å…¥] --> Injector
    Injector -->|GENERATION_AFTER_COMMANDS| Preprocessor
    
    subgraph Stage 1: é¢„å¤„ç† [å¯é€‰]
        Preprocessor -->|LLM| UnifiedQuery[Unified Query<br/>ç»Ÿä¸€æ£€ç´¢æŒ‡ä»¤]
    end
    
    subgraph Stage 2: å‘é‡æ£€ç´¢
        UnifiedQuery -->|Embed| QueryVec[æŸ¥è¯¢å‘é‡]
        DB[(Engram DB)] -->|Embed| EventVec[äº‹ä»¶å‘é‡]
        QueryVec -->|Cosine Similarity| Candidates[å€™é€‰é›† Top-K]
        EventVec --> Candidates
    end
    
    subgraph Stage 3: é‡æ’åº [å¯é€‰]
        Candidates --> RerankService
        RerankService -->|Cross-Encoder| Reranked[é‡æ’ååˆ—è¡¨]
    end
    
    subgraph Stage 4: ç±»è„‘å¬å›
        Reranked --> BrainRecallCache[ç±»è„‘å¬å›ç¼“å­˜]
        BrainRecallCache -->|å¼ºåŒ–/è¡°å‡/æ·˜æ±°| WorkingMemory[å·¥ä½œè®°å¿†]
    end
    
    WorkingMemory --> MacroService
    MacroService -->|"{{engramSummaries}}"| Prompt[æœ€ç»ˆ Prompt]
```

### å…³é”®ç»„ä»¶

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|------|----------|------|
| **Injector** | `src/modules/rag/injection/Injector.ts` | ç›‘å¬é…’é¦†äº‹ä»¶ï¼Œé˜»å¡ç”Ÿæˆæµç¨‹ï¼Œåè°ƒé¢„å¤„ç†å’Œå¬å› |
| **Preprocessor** | `src/modules/preprocessing/Preprocessor.ts` | åˆ©ç”¨ LLM åˆ†æç”¨æˆ·æ„å›¾ï¼Œç”Ÿæˆ Unified Query |
| **EmbeddingService** | `src/modules/rag/embedding/EmbeddingService.ts` | å¤„ç†æ–‡æœ¬å‘é‡åŒ–ï¼Œæ”¯æŒå¤šå¹¶å‘å’Œæ‰¹å¤„ç† |
| **RerankService** | `src/modules/rag/retrieval/Reranker.ts` | å¯¹åˆæ­¥å¬å›ç»“æœè¿›è¡Œç²¾ç»†åŒ–è¯­ä¹‰é‡æ’åº |
| **BrainRecallCache** | `src/modules/rag/retrieval/BrainRecallCache.ts` | **V0.9.5 æ ¸å¿ƒ**ï¼šç±»è„‘è®°å¿†ç¼“å­˜ç³»ç»Ÿ |
| **Retriever** | `src/modules/rag/retrieval/Retriever.ts` | ç»Ÿä¸€æ£€ç´¢æœåŠ¡ï¼Œç¼–æ’ä¸Šè¿°æ‰€æœ‰ç»„ä»¶ |

## 3. å¬å›æ¨¡å¼ (Recall Modes)

ç³»ç»Ÿæä¾›å››ç§é¢„è®¾æ¨¡å¼ï¼Œä»¥é€‚åº”ä¸åŒç”¨æˆ·çš„ç¡¬ä»¶æ¡ä»¶å’Œ API é¢„ç®—ï¼š

| æ¨¡å¼ | ç»„ä»¶ç»„åˆ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|:-----|:---------|:-----|:---------|
| **Full (é¡¶é…)** | é¢„å¤„ç† + Embed + Rerank | æ•ˆæœæœ€ä¼˜ï¼Œæˆæœ¬æœ€é«˜ï¼Œå»¶è¿Ÿæœ€é«˜ | è¿½æ±‚æè‡´ä½“éªŒï¼ŒToken å……è¶³ |
| **Standard (æ ‡å‡†)** | Embed + Rerank | æ€§ä»·æ¯”å¹³è¡¡ï¼Œç”± Embed å¹¿æ’’ç½‘ï¼ŒRerank ç²¾é€‰ | å¤§å¤šæ•°ç”¨æˆ·çš„é¦–é€‰ |
| **Light (è½»é‡)** | ä»… Embedding | é€Ÿåº¦æœ€å¿«ï¼Œæˆæœ¬ä½ï¼Œä»…éœ€å‘é‡æ¨¡å‹ | æœ¬åœ°è¿è¡Œæˆ–é¢„ç®—æœ‰é™ |
| **Brute Force (æš´åŠ›)** | æ»šåŠ¨çª—å£ | æ— éœ€å‘é‡æ¨¡å‹ï¼Œè¿”å›æœ€è¿‘ N æ¡äº‹ä»¶ | æ— æ³•éƒ¨ç½²å‘é‡æ¨¡å‹çš„ç¯å¢ƒ |

**Query æ¥æºè¯´æ˜**ï¼š
- **Light/Standard**: ç”±äºæ— é¢„å¤„ç†ï¼Œç³»ç»Ÿä½¿ç”¨**ç”¨æˆ·åŸå§‹è¾“å…¥**ä½œä¸ºæŸ¥è¯¢è¯
- **Full**: ç³»ç»Ÿä¼˜å…ˆä½¿ç”¨é¢„å¤„ç†ç”Ÿæˆçš„ **Unified Query**

## 4. å…³é”®æŠ€æœ¯ç‰¹æ€§ (Key Features)

### 4.1 Unified Query (ç»Ÿä¸€æ£€ç´¢æŒ‡ä»¤)

ä¸ºäº†å¼¥è¡¥ã€Œç”¨æˆ·è¾“å…¥ã€ä¸ã€Œå‰§æƒ…æ–‡æœ¬ã€çš„é¸¿æ²Ÿï¼ŒFull æ¨¡å¼ä¸‹çš„é¢„å¤„ç†å™¨ä¼šå°†ç”¨æˆ·è¾“å…¥è½¬åŒ–ä¸ºå¤šç§ç»´åº¦çš„æ£€ç´¢æŒ‡ä»¤ï¼š

- **å› æœæŒ‡ä»¤**: æŸ¥æ‰¾å¯¼è‡´å½“å‰åŠ¨ä½œçš„å‰å› åæœ
- **è§†è§‰æŒ‡ä»¤**: æŸ¥æ‰¾ç›¸å…³çš„ç¯å¢ƒå’Œå¤–è§‚æå†™
- **å®ä½“æŒ‡ä»¤**: æŸ¥æ‰¾æåŠçš„ç‰©å“æˆ–äººç‰©èƒŒæ™¯
- **æƒ…æ„ŸæŒ‡ä»¤**: æŸ¥æ‰¾ç±»ä¼¼çš„æƒ…æ„Ÿäº¤äº’å†å²

### 4.2 æ··åˆæ‰“åˆ† (Hybrid Scoring)

å½“åŒæ—¶å¯ç”¨ Embedding å’Œ Rerank æ—¶ï¼Œç³»ç»Ÿä½¿ç”¨åŠ æƒå…¬å¼è®¡ç®—æœ€ç»ˆç›¸å…³åº¦ï¼š

```typescript
HybridScore = (1 - Î±) * EmbeddingScore + Î± * RerankScore
```

- **EmbeddingScore**: åŸºäºä½™å¼¦ç›¸ä¼¼åº¦ï¼Œæ“…é•¿æ•æ‰å­—é¢å’Œæµ…å±‚è¯­ä¹‰ç›¸å…³æ€§
- **RerankScore**: åŸºäº Cross-Encoder æ¨¡å‹ï¼Œæ“…é•¿ç†è§£æ·±å±‚é€»è¾‘å…³ç³»
- **Î± (hybridAlpha)**: æ··åˆæƒé‡ï¼Œå¯é…ç½®ã€‚é»˜è®¤ `0.5` è¡¨ç¤ºä¸¤è€…åŒç­‰é‡è¦

### 4.3 ç±»è„‘å¬å›ç³»ç»Ÿ (BrainRecallCache) ğŸ§ 

> **V0.9.5 å®éªŒæ€§ç‰¹æ€§**

è¿™æ˜¯ Engram æœ€æ ¸å¿ƒçš„è®°å¿†ç®¡ç†æœºåˆ¶ï¼Œæ¨¡æ‹Ÿäººè„‘çš„è®°å¿†æ¨¡å‹ï¼š

#### 4.3.1 åŒå±‚è®°å¿†ç»“æ„

| å±‚çº§ | å®¹é‡ | è¯´æ˜ |
|------|------|------|
| **çŸ­æœŸè®°å¿† (Short-Term Memory)** | `shortTermLimit` (é»˜è®¤ 50) | å­˜å‚¨è¿‘å‡ è½®è¢«å¬å›è¿‡çš„è®°å¿†æ§½ä½ |
| **å·¥ä½œè®°å¿† (Working Memory)** | `workingLimit` (é»˜è®¤ 10) | ä»çŸ­æœŸè®°å¿†ä¸­é€‰å–å¼ºåº¦æœ€é«˜çš„ Top-Kï¼Œæ³¨å…¥åˆ° Prompt |

#### 4.3.2 æ ¸å¿ƒæœºåˆ¶

```mermaid
graph LR
    subgraph æœ¬è½®å¬å›
        Candidates[å€™é€‰é›†]
    end
    
    subgraph çŸ­æœŸè®°å¿†
        Reinforce{å†æ¬¡å¬å›?}
        Candidates --> Reinforce
        Reinforce -->|æ˜¯| Strengthen[å¼ºåŒ– strength]
        Reinforce -->|å¦| Decay[è¡°å‡ strength]
        Strengthen --> STM[çŸ­æœŸè®°å¿†æ± ]
        Decay --> STM
        NewItem[æ–°å¢é¡¹] --> STM
        STM --> Evict{strength < é˜ˆå€¼?}
        Evict -->|æ˜¯| Remove[æ·˜æ±°]
        Evict -->|å¦| Keep[ä¿ç•™]
    end
    
    subgraph å·¥ä½œè®°å¿†
        Keep --> TopK[é€‰å– Top-K]
        TopK --> WM[å·¥ä½œè®°å¿†]
    end
    
    WM --> Inject[æ³¨å…¥ Prompt]
```

| æœºåˆ¶ | å…¬å¼/é€»è¾‘ | é…ç½®é¡¹ |
|------|-----------|--------|
| **å¼ºåŒ– (Reinforce)** | `strength = strength + factor * (1 - strength)` (é¥±å’Œå¢é•¿) | `reinforceFactor` |
| **è¡°å‡ (Decay)** | `strength = strength - decayRate` (çº¿æ€§è¡°å‡) | `decayRate` |
| **æ·˜æ±° (Eviction)** | å½“ `strength < evictionThreshold` æ—¶ç§»å‡ºçŸ­æœŸè®°å¿† | `evictionThreshold` |
| **ä¸Šä¸‹æ–‡åˆ‡æ¢æ£€æµ‹** | å½“å¬å›ç»“æœä¸çŸ­æœŸè®°å¿†å‡ ä¹æ— é‡å æ—¶ï¼Œæ‰§è¡Œ `softReset` æ¸…ç©ºçŸ­æœŸè®°å¿† | `contextSwitchThreshold` |

#### 4.3.3 è®¾è®¡ç†å¿µ

- **è®°å¿†æƒ¯æ€§**: è¿ç»­è¢«å¬å›çš„è®°å¿†ä¼šè¶Šæ¥è¶Š"é¡½å›º"ï¼Œéš¾ä»¥è¢«æ›¿æ¢ï¼Œæ¨¡æ‹ŸçœŸå®å¯¹è¯ä¸­çš„è¯é¢˜å»¶ç»­æ€§
- **è‡ªç„¶é—å¿˜**: ä¸å†ç›¸å…³çš„è®°å¿†ä¼šé€æ¸è¡°å‡ç›´è‡³æ·˜æ±°ï¼Œé¿å…é™ˆæ—§ä¿¡æ¯"åˆ·å±"
- **è¯é¢˜æ•æ„Ÿ**: å½“æ£€æµ‹åˆ°è¯é¢˜åˆ‡æ¢æ—¶ï¼Œä¸»åŠ¨æ¸…ç©ºçŸ­æœŸè®°å¿†ï¼Œé¿å…æ—§è¯é¢˜å¹²æ‰°æ–°è¯é¢˜

### 4.4 å¯è§‚æµ‹æ€§ (Recall Logs)

åœ¨å¼€å‘è€…é¢æ¿ (DevLog) ä¸­æ–°å¢äº† **Recall** æ ‡ç­¾é¡µï¼Œæä¾›ï¼š

- æ¯æ¬¡å¬å›çš„å®Œæ•´å¿«ç…§ (Query, Timestamp, Latency)
- Embedding å’Œ Rerank åˆ†æ•°çš„ç›´è§‚å¯¹æ¯”æ¡
- ç±»è„‘å¬å›ç³»ç»Ÿçš„çŠ¶æ€å¯è§†åŒ– (çŸ­æœŸè®°å¿†å¤§å°ã€å¹³å‡å¼ºåº¦ç­‰)

## 5. é…ç½®æŒ‡å— (Configuration)

### 5.1 å¯ç”¨ RAG

å‰å¾€ `API é…ç½®` -> `Engram RAG` é¢æ¿ï¼š

1. **å¯ç”¨å¼€å…³**: æ‰“å¼€ "å¯ç”¨ RAG å¬å›ç³»ç»Ÿ"
2. **é€‰æ‹©æ¨¡å¼**: æ¨èä» "Standard" å¼€å§‹

### 5.2 å‘é‡æ¨¡å‹è®¾ç½®

åœ¨ `API é…ç½®` -> `å‘é‡åŒ–` é¢æ¿ï¼š

| é…ç½®é¡¹ | è¯´æ˜ |
|--------|------|
| **æº** | æ”¯æŒ `Transformers.js` (æœ¬åœ°)ã€OpenAIã€Ollamaã€vLLMã€Cohereã€Jinaã€Voyage ç­‰ |
| **æ¨¡å‹** | æ¨è `text-embedding-3-small` æˆ–æœ¬åœ° `bge-m3` |
| **API URL** | éƒ¨åˆ†æºéœ€è¦å¡«å†™ç«¯ç‚¹åœ°å€ |
| **API Key** | éƒ¨åˆ†æºéœ€è¦å¡«å†™å¯†é’¥ |

### 5.3 Rerank è®¾ç½®

åœ¨ `API é…ç½®` -> `Rerank` é¢æ¿ï¼š

| é…ç½®é¡¹ | è¯´æ˜ |
|--------|------|
| **URL** | Rerank API ç«¯ç‚¹ |
| **Model** | æ¨è BGE-Reranker æˆ– Cohere API |
| **Top-N** | Rerank åä¿ç•™çš„ç²¾é€‰æ¡ç›®æ•°ï¼ˆå»ºè®® 5-10ï¼‰ |
| **hybridAlpha** | æ··åˆæƒé‡ (0-1) |

### 5.4 ç±»è„‘å¬å›é…ç½® (V0.9.5)

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `enabled` | `true` | æ˜¯å¦å¯ç”¨ç±»è„‘å¬å› |
| `workingLimit` | `10` | å·¥ä½œè®°å¿†å®¹é‡ |
| `shortTermLimit` | `50` | çŸ­æœŸè®°å¿†å®¹é‡ |
| `reinforceFactor` | `0.3` | å†æ¬¡å¬å›çš„å¼ºåŒ–ç³»æ•° |
| `decayRate` | `0.05` | æ¯è½®è¡°å‡é€Ÿç‡ |
| `evictionThreshold` | `0.1` | æ·˜æ±°é˜ˆå€¼ |
| `contextSwitchThreshold` | `0.3` | ä¸Šä¸‹æ–‡åˆ‡æ¢æ£€æµ‹é˜ˆå€¼ |

## 6. å¼€å‘æ¥å£ (Developer API)

### æ ¸å¿ƒæœåŠ¡

| æœåŠ¡ | è¯´æ˜ |
|------|------|
| `retriever` | å•ä¾‹å¯¹è±¡ï¼Œé€šè¿‡ `retriever.search()` æ‰§è¡Œå¬å› |
| `brainRecallCache` | ç±»è„‘ç¼“å­˜å•ä¾‹ï¼Œç®¡ç†è®°å¿†å¼ºåŒ–/è¡°å‡/æ·˜æ±° |
| `MacroService` | è´Ÿè´£å°†å¬å›ç»“æœæ³¨å…¥åˆ° `{{engramSummaries}}` |

### å®æ¥å£

å‰§æƒ… AI çš„ Prompt Template ä¸­å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å®æ¥æ”¶å¬å›å†…å®¹ï¼š

- `{{engramSummaries}}`: åŒ…å«å½“å‰è½®æ¬¡å¬å›å¹¶æ ¼å¼åŒ–å¥½çš„è®°å¿†ç‰‡æ®µ

## 7. ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | å˜æ›´ |
|------|------|
| V0.9.5 | æ–°å¢ **BrainRecallCache** ç±»è„‘å¬å›ç³»ç»Ÿï¼Œæ›¿ä»£æ—§ç‰ˆ StickyCache |
| V0.8.5 | å¼•å…¥æ··åˆæ£€ç´¢æ¶æ„ (Embedding + Rerank) |
