# Engram 系统架构白皮书 V0.8

> **核心愿景**: 为 SillyTavern 打造一个本地优先、基于 Graph RAG 的下一代记忆操作系统。
>
> **Slogan**: *Where memories leave their trace.* (记忆留痕之处)
> **Version**: v0.8
> **Last Modified**: 2026-01-11

---

## 1. 宏观架构 (System Overview)

Engram 作为一个 React 应用挂载于 SillyTavern 之上，通过 Adapter 模式与宿主环境交互。系统核心由 **ETL 流水线**、**IndexedDB 存储** 和 **宏注入系统** 组成。

### 1.1 顶层数据流

```mermaid
graph LR
    User[用户输入] --> ST_Host[SillyTavern]
    ST_Host -->|Hook拦截| Engram_Input[Engram 输入网关]
    
    subgraph Engram [Engram 插件系统]
        Engram_Input -->|ETL处理| Pipeline[Pipeline 引擎]
        Pipeline <-->|读写| Local_DB[(IndexedDB)]
        Local_DB -->|MacroService| Engram_Output[宏注入]
    end
    
    Engram_Output -->|engramSummaries| ST_LLM[LLM 请求]
```

---

## 2. 核心技术栈 (Technology Stack)

| 层级 | 技术选型 | 职责 |
|------|----------|------|
| **View** | React 18 + Lucide | 现代化 UI，图标组件库 |
| **Styling** | TailwindCSS + Design Tokens | 组件样式 + 统一设计变量 |
| **Logic** | TypeScript | 强类型业务逻辑 |
| **Store** | Zustand (memoryStore) | UI 状态 + IndexedDB 操作封装 |
| **Data** | Dexie.js (IndexedDB) | 持久化存储：Scope, EventNode, EntityNode |
| **Build** | Vite (Library Mode) | 打包为单文件 JS 注入脚本 |

---

## 3. 核心机制 I: 数据存储 (V0.5 架构)

### 3.1 IndexedDB 优先

| Before (V0.4) | After (V0.5) |
|---------------|--------------|
| WorldBook 存储摘要条目 | IndexedDB 存储 EventNode |
| WorldBookStateService 管理状态 | memoryStore (Zustand) 管理状态 |
| 每次总结写 WB 条目 | 每次总结写 IndexedDB |

### 3.2 数据结构

```typescript
// Scope - 作用域容器
interface Scope {
    id?: number;
    chat_id: string;          // 唯一主键
    character_name: string;   // 显示用
    state: ScopeState;
    created_at: number;
    last_active_at: number;
}

// EventNode - 事件节点
interface EventNode {
    id: string;
    scope_id: number;
    
    summary: string;          // For Model (高密度文本)
    structured_kv: {          // For Machine (结构化)
        time_anchor: string;
        role: string[];
        location: string;
        event: string;
        logic: string[];
        causality: string;
    };
    
    significance_score: number;
    level: number;            // 0=原始, 1+=精简层级
    source_range: { start_index: number; end_index: number };
    timestamp: number;
}
```

---

## 4. 核心机制 II: Pipeline 流水线

### 4.1 写入流程

```
SummarizerService.triggerSummary()
    ↓
Extractor.extract() → LLM → ExtractedEvent[]
    ↓
Pipeline.process() → EventNode
    ↓
memoryStore.saveEvent() → IndexedDB
    ↓
MacroService.refreshCache()
```

### 4.2 精简流程 (EventTrimmer)

```
触发条件: Token 超限 / 事件数量超限
    ↓
EventTrimmer.trim()
    ↓
getEventsToMerge() → 获取待合并事件
    ↓
Extractor.extract() → LLM 压缩
    ↓
saveEvent(level=1) + deleteEvents(原事件)
```

---

## 5. 核心机制 III: 宏注入系统

### 5.1 WorldBook 槽位

- `WorldBookSlotService` 初始化时创建占位条目
- 条目内容包含 `{{engramSummaries}}` 宏
- 宏在 LLM 请求前被展开

### 5.2 MacroService

```typescript
// 注册宏
getContext().registerMacro('engramSummaries', () => {
    return MacroService.cache;  // 从 IndexedDB 缓存读取
});
```

---

## 6. 关键服务文件

### 6.1 数据层
| 文件 | 职责 |
|------|------|
| `services/database/db.ts` | EngramDB (Dexie) 定义 |
| `services/database/ScopeManager.ts` | Scope 解析与状态管理 |
| `stores/memoryStore.ts` | Zustand Store + IndexedDB 操作封装 |

### 6.2 Pipeline 层
| 文件 | 职责 |
|------|------|
| `services/pipeline/Pipeline.ts` | ETL 编排器 |
| `services/pipeline/Extractor.ts` | LLM 调用 + JSON 解析 |
| `services/pipeline/EventTrimmer.ts` | 事件精简服务 |

### 6.3 注入层
| 文件 | 职责 |
|------|------|
| `tavern/MacroService.ts` | 宏注册与缓存管理 |
| `services/WorldBookSlotService.ts` | WB 槽位初始化 |

### 6.4 UI 层
| 文件 | 职责 |
|------|------|
| `views/Processing/SummaryPanel.tsx` | 总结控制面板 |
| `views/MemoryStream/index.tsx` | 记忆流可视化 (开发中) |
| `views/APIPresets/` | API 和提示词配置 |

---

## 7. 提示词模板系统

### 7.1 分类 (PromptCategory)

| 分类 | 用途 | 文件 |
|------|------|------|
| `summary` | 剧情摘要 (JSON) | `prompts/summary_prompt.md` |
| `trim` | 记忆精简 | `prompts/trim.md` |
| `preprocessing` | 输入预处理 (V0.8) | `prompts/query_enhance.md`, `plot_director.md`, `description.md` |

### 7.2 预处理内置模板 (V0.8)

| 模板 | 功能 | 输出标签 |
|------|------|----------|
| Query 增强 | 扩展用户输入的指代词，优化 RAG 检索 | `<query>`, `<output>` |
| 剧情编排 | 生成导演指令框架 | `<output>` |
| 描写增强 | 补充细节描写和环境氛围 | `<output>` |

### 7.3 模板管理
- 通过 `APIPresets` UI 编辑
- 内置模板 + 用户自定义模板
- 每个分类只有一个启用的模板生效

---

## 8. 性能与隐私

| 特性 | 说明 |
|------|------|
| **Zero Server Dependency** | 所有数据存储在用户浏览器 IndexedDB |
| **本地 LLM 支持** | 可配置使用 Ollama 等本地模型 |
| **增量处理** | 仅处理新消息，避免重复计算 |
