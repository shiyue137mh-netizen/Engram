# Engram ç³»ç»Ÿæ¶æ„ç™½çš®ä¹¦ V0.9.4

> **æ ¸å¿ƒæ„¿æ™¯**: ä¸º SillyTavern æ‰“é€ ä¸€ä¸ªæœ¬åœ°ä¼˜å…ˆã€åŸºäº Graph RAG çš„ä¸‹ä¸€ä»£è®°å¿†æ“ä½œç³»ç»Ÿã€‚
>
> **Slogan**: *Where memories leave their trace.* (è®°å¿†ç•™ç—•ä¹‹å¤„)
> **Version**: v0.9.4
> **Last Modified**: 2026-01-16

---

## 1. å®è§‚æ¶æ„ (System Overview)

Engram ä½œä¸ºä¸€ä¸ª React åº”ç”¨æŒ‚è½½äº SillyTavern ä¹‹ä¸Šï¼Œé€šè¿‡ Adapter æ¨¡å¼ä¸å®¿ä¸»ç¯å¢ƒäº¤äº’ã€‚ç³»ç»Ÿæ ¸å¿ƒç”± **ETL æµæ°´çº¿**ã€**IndexedDB å­˜å‚¨** å’Œ **å®æ³¨å…¥ç³»ç»Ÿ** ç»„æˆã€‚

### 1.1 é¡¶å±‚æ•°æ®æµ

```mermaid
graph LR
    User[ç”¨æˆ·è¾“å…¥] --> ST_Host[SillyTavern]
    ST_Host -->|Hookæ‹¦æˆª| Engram_Input[Engram è¾“å…¥ç½‘å…³]
    
    subgraph Engram [Engram æ’ä»¶ç³»ç»Ÿ]
        Engram_Input -->|ETLå¤„ç†| Pipeline[Pipeline å¼•æ“]
        Pipeline <-->|è¯»å†™| Local_DB[(IndexedDB)]
        Local_DB -->|MacroService| Engram_Output[å®æ³¨å…¥]
    end
    
    Engram_Output -->|engramSummaries| ST_LLM[LLM è¯·æ±‚]
```

---

## 2. æ ¸å¿ƒæŠ€æœ¯æ ˆ (Technology Stack)

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | èŒè´£ |
|------|----------|------|
| **View** | React 18 + Lucide | ç°ä»£åŒ– UIï¼Œå›¾æ ‡ç»„ä»¶åº“ |
| **Styling** | TailwindCSS + Design Tokens | ç»„ä»¶æ ·å¼ + ç»Ÿä¸€è®¾è®¡å˜é‡ |
| **Logic** | TypeScript | å¼ºç±»å‹ä¸šåŠ¡é€»è¾‘ |
| **Store** | Zustand (memoryStore) | UI çŠ¶æ€ + IndexedDB æ“ä½œå°è£… |
| **Data** | Dexie.js (IndexedDB) | æŒä¹…åŒ–å­˜å‚¨ï¼šScope, EventNode, EntityNode |
| **Build** | Vite (Library Mode) | æ‰“åŒ…ä¸ºå•æ–‡ä»¶ JS æ³¨å…¥è„šæœ¬ |

---

## 3. æ ¸å¿ƒæœºåˆ¶ I: æ•°æ®å­˜å‚¨ (V0.5 æ¶æ„)

### 3.1 IndexedDB ä¼˜å…ˆ

| Before (V0.4) | After (V0.5) |
|---------------|--------------|
| WorldBook å­˜å‚¨æ‘˜è¦æ¡ç›® | IndexedDB å­˜å‚¨ EventNode |
| WorldBookStateService ç®¡ç†çŠ¶æ€ | memoryStore (Zustand) ç®¡ç†çŠ¶æ€ |
| æ¯æ¬¡æ€»ç»“å†™ WB æ¡ç›® | æ¯æ¬¡æ€»ç»“å†™ IndexedDB |

### 3.2 æ•°æ®ç»“æ„

**V0.6+ å¤šæ•°æ®åº“æ¶æ„**: æ¯ä¸ª `chat_id` æ‹¥æœ‰ç‹¬ç«‹çš„ IndexedDB æ•°æ®åº“ (`Engram_{chatId}`)ï¼Œå› æ­¤ä¸å†éœ€è¦ `scope_id` åˆ†åŒºå­—æ®µã€‚

```typescript
// EventNode - äº‹ä»¶èŠ‚ç‚¹ï¼ˆæ ¸å¿ƒè®°å¿†å•å…ƒï¼‰
interface EventNode {
    id: string;               // UUID
    
    summary: string;          // For Model (é«˜å¯†åº¦æ–‡æœ¬ï¼Œç”¨äº Embedding å’Œ RAG)
    structured_kv: {          // For Machine (ç»“æ„åŒ–ï¼Œç”¨äºå›¾è°±å’Œè¿‡æ»¤)
        time_anchor: string;
        role: string[];
        location: string;
        event: string;
        logic: string[];
        causality: string;
    };
    
    embedding?: number[];     // è¯­ä¹‰å‘é‡ (å¯é€‰)
    is_embedded: boolean;     // æ˜¯å¦å·²å‘é‡åŒ–
    is_archived: boolean;     // æ˜¯å¦å·²å½’æ¡£ (ğŸŸ¢ç»¿ç¯: æ¡ä»¶è§¦å‘)
    
    significance_score: number;
    level: number;            // 0=åŸå§‹, 1+=ç²¾ç®€å±‚çº§
    source_range: { start_index: number; end_index: number };
    timestamp: number;
    parent_id?: string;       // çˆ¶èŠ‚ç‚¹ (ç²¾ç®€æ¥æº)
}

// EntityNode - å®ä½“èŠ‚ç‚¹ï¼ˆV0.9.4 æ— è¾¹è®¾è®¡ + åŒé‡ç»“æ„ï¼‰
interface EntityNode {
    id: string;
    name: string;
    type: EntityType;         // 'char' | 'loc' | 'item' | 'concept' | 'unknown'
    aliases: string[];        // åˆ«ååˆ—è¡¨ (MultiEntryç´¢å¼•)
    description: string;      // [For Model] YAML çƒ§å½•æ–‡æœ¬
    profile: Record<string, unknown>;  // [For Machine] å¼€æ”¾å¼ KV å®¹å™¨
    last_updated_at: number;
    layout_x?: number;        // å›¾è°±å¸ƒå±€åæ ‡
    layout_y?: number;
}

// EntityRelation - å®ä½“å…³ç³» (V0.9.4)
// å­˜æ”¾åœ¨ EntityNode.profile.relations æ•°ç»„ä¸­
interface EntityRelation {
    target: string;           // ç›®æ ‡å®ä½“å
    type: string;             // å…³ç³»ç±»å‹ (friend/enemy/masterç­‰)
    description?: string;     // å…³ç³»ç»†èŠ‚
}

// ScopeState - èŠå¤©çŠ¶æ€ï¼ˆå­˜å‚¨åœ¨ meta è¡¨ä¸­ï¼‰
interface ScopeState {
    last_summarized_floor: number;
    token_usage_accumulated: number;
    last_compressed_at: number;
    active_summary_order: number;
    last_extracted_floor: number;  // V0.9.1: ä¸Šæ¬¡å®ä½“æå–æ¥¼å±‚
}
```

---

## 4. æ ¸å¿ƒæœºåˆ¶ II: Pipeline æµæ°´çº¿

### 4.1 å†™å…¥æµç¨‹

```
SummarizerService.triggerSummary()
    â†“
Extractor.extract() â†’ LLM â†’ ExtractedEvent[]
    â†“
Pipeline.process() â†’ EventNode
    â†“
memoryStore.saveEvent() â†’ IndexedDB
    â†“
MacroService.refreshCache()
```

### 4.2 ç²¾ç®€æµç¨‹ (EventTrimmer)

```
è§¦å‘æ¡ä»¶: Token è¶…é™ / äº‹ä»¶æ•°é‡è¶…é™
    â†“
EventTrimmer.trim()
    â†“
getEventsToMerge() â†’ è·å–å¾…åˆå¹¶äº‹ä»¶
    â†“
Extractor.extract() â†’ LLM å‹ç¼©
    â†“
saveEvent(level=1) + deleteEvents(åŸäº‹ä»¶)
```

### 4.3 å®ä½“æå–æµç¨‹ (V0.9.4)

```
chatHistory â†’ SummarizerService.handleMessageReceived()
    â†“
checkEntityExtraction() â†’ æ¥¼å±‚é—´éš”æ£€æŸ¥
    â†“
EntityBuilder.extractFromChat(chatHistory, floor)
    â†“
LLM æå– â†’ æ¶ˆæ­§ â†’ profileToYaml() â†’ memoryStore.saveEntity()
    â†“
æ›´æ–° ScopeState.last_extracted_floor
```

> **V0.9.4 å˜æ›´**: LLM è¾“å‡ºå¼€æ”¾å¼ `profile` ç»“æ„ï¼Œç”± `profileToYaml()` ç”Ÿæˆ `description` çƒ§å½•æ–‡æœ¬

> **å¹¶è¡Œæ¶æ„**: å®ä½“æå–ä¸ Summary å¹¶è¡Œè§¦å‘ï¼Œå„è‡ªç‹¬ç«‹æ¥¼å±‚é—´éš”

---

## 5. æ ¸å¿ƒæœºåˆ¶ III: å®æ³¨å…¥ç³»ç»Ÿ

### 5.1 WorldBook æ§½ä½

- `WorldBookSlotService` åˆå§‹åŒ–æ—¶åˆ›å»ºå ä½æ¡ç›®
- æ¡ç›®å†…å®¹åŒ…å« `{{engramSummaries}}` å®
- å®åœ¨ LLM è¯·æ±‚å‰è¢«å±•å¼€

### 5.2 MacroService

```typescript
// æ³¨å†Œå®
getContext().registerMacro('engramSummaries', () => {
    return MacroService.cache;  // ä» IndexedDB ç¼“å­˜è¯»å–
});
```

---

## 6. å…³é”®æœåŠ¡æ–‡ä»¶

### 6.1 æ•°æ®å±‚
| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `services/database/db.ts` | EngramDB (Dexie) å®šä¹‰ |
| `services/database/ScopeManager.ts` | Scope è§£æä¸çŠ¶æ€ç®¡ç† |
| `stores/memoryStore.ts` | Zustand Store + IndexedDB æ“ä½œå°è£… |

### 6.2 Pipeline å±‚
| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `services/pipeline/Pipeline.ts` | ETL ç¼–æ’å™¨ |
| `services/pipeline/Extractor.ts` | LLM è°ƒç”¨ + JSON è§£æ |
| `services/pipeline/EventTrimmer.ts` | äº‹ä»¶ç²¾ç®€æœåŠ¡ |

### 6.3 æ³¨å…¥å±‚
| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `tavern/MacroService.ts` | å®æ³¨å†Œä¸ç¼“å­˜ç®¡ç† |
| `services/WorldBookSlotService.ts` | WB æ§½ä½åˆå§‹åŒ– |

### 6.4 UI å±‚
| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `views/Processing/SummaryPanel.tsx` | æ€»ç»“æ§åˆ¶é¢æ¿ |
| `views/Processing/EntityConfigPanel.tsx` | å®ä½“æå–é…ç½® (V0.9.1) |
| `views/MemoryStream/index.tsx` | è®°å¿†æµå¯è§†åŒ– |
| `views/MemoryStream/GraphView.tsx` | å›¾è°±å¯è§†åŒ– (V0.9.1) |
| `views/APIPresets/` | API å’Œæç¤ºè¯é…ç½® |

---

## 7. æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿ

### 7.1 åˆ†ç±» (PromptCategory)

| åˆ†ç±» | ç”¨é€” | æ–‡ä»¶ |
|------|------|------|
| `summary` | å‰§æƒ…æ‘˜è¦ (JSON) | `prompts/summary_prompt.md` |
| `trim` | è®°å¿†ç²¾ç®€ | `prompts/trim.md` |
| `preprocessing` | è¾“å…¥é¢„å¤„ç† (V0.8) | `prompts/query_enhance.md`, `plot_director.md`, `description.md` |
| `entity_extraction` | å®ä½“æå– (V0.9.4) | `prompts/entity_extraction.md` |

### 7.2 é¢„å¤„ç†å†…ç½®æ¨¡æ¿ (V0.8)

| æ¨¡æ¿ | åŠŸèƒ½ | è¾“å‡ºæ ‡ç­¾ |
|------|------|----------|
| Query å¢å¼º | æ‰©å±•ç”¨æˆ·è¾“å…¥çš„æŒ‡ä»£è¯ï¼Œä¼˜åŒ– RAG æ£€ç´¢ | `<query>`, `<output>` |
| å‰§æƒ…ç¼–æ’ | ç”Ÿæˆå¯¼æ¼”æŒ‡ä»¤æ¡†æ¶ | `<output>` |
| æå†™å¢å¼º | è¡¥å……ç»†èŠ‚æå†™å’Œç¯å¢ƒæ°›å›´ | `<output>` |

### 7.3 æ¨¡æ¿ç®¡ç†
- é€šè¿‡ `APIPresets` UI ç¼–è¾‘
- å†…ç½®æ¨¡æ¿ + ç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿
- æ¯ä¸ªåˆ†ç±»åªæœ‰ä¸€ä¸ªå¯ç”¨çš„æ¨¡æ¿ç”Ÿæ•ˆ

---

## 8. æ€§èƒ½ä¸éšç§

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **Zero Server Dependency** | æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨ç”¨æˆ·æµè§ˆå™¨ IndexedDB |
| **æœ¬åœ° LLM æ”¯æŒ** | å¯é…ç½®ä½¿ç”¨ Ollama ç­‰æœ¬åœ°æ¨¡å‹ |
| **å¢é‡å¤„ç†** | ä»…å¤„ç†æ–°æ¶ˆæ¯ï¼Œé¿å…é‡å¤è®¡ç®— |
