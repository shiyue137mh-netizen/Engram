# é€šçŸ¥ä¸æ—¥å¿—ç³»ç»Ÿä¼˜åŒ– - è°ƒç ”æ–‡æ¡£

> ğŸ“… åˆ›å»ºæ—¥æœŸï¼š2026-01-12  
> ğŸ“Œ çŠ¶æ€ï¼šå¾…å®ç°  
> ğŸ¯ ç›®æ ‡ç‰ˆæœ¬ï¼šV0.8.6

## èƒŒæ™¯

å½“å‰é¢„å¤„ç†å’Œå¬å›æ¨¡å—ç¼ºå°‘è¿è¡ŒçŠ¶æ€åé¦ˆï¼Œå¼€å‘è€…éš¾ä»¥è¿½è¸ª RAG å¬å›ç»“æœå’Œè°ƒè¯•é—®é¢˜ã€‚éœ€è¦ä¼˜åŒ–é€šçŸ¥ç³»ç»Ÿå’Œæ—¥å¿—ç³»ç»Ÿï¼Œæä¾›æ›´å¥½çš„å¼€å‘ä½“éªŒã€‚

---

## ä¸€ã€é€šçŸ¥ç³»ç»Ÿä¼˜åŒ–

### 1.1 ç°æœ‰åŸºç¡€è®¾æ–½

**NotificationService.ts** å·²å°è£… toastr é€šçŸ¥ç³»ç»Ÿï¼š

| æ–¹æ³• | è¯´æ˜ |
|-----|-----|
| `success()` | æˆåŠŸé€šçŸ¥ |
| `info()` | ä¿¡æ¯é€šçŸ¥ |
| `warning()` | è­¦å‘Šé€šçŸ¥ |
| `error()` | é”™è¯¯é€šçŸ¥ï¼ˆ8s æ˜¾ç¤ºï¼‰ |
| `running()` | æŒç»­æ˜¾ç¤ºé€šçŸ¥ï¼Œæ”¯æŒ `onCancel` å›è°ƒ |
| `remove()` | ç§»é™¤æŒ‡å®šé€šçŸ¥ |
| `clear()` | æ¸…é™¤æ‰€æœ‰é€šçŸ¥ |

### 1.2 å¾…å®ç°åŠŸèƒ½

#### A. é¢„å¤„ç†æ¨¡å— Toastr é€šçŸ¥

**ç›®æ ‡**ï¼šé¢„å¤„ç†è¿è¡Œæ—¶æ˜¾ç¤ºçŠ¶æ€é€šçŸ¥ï¼Œç±»ä¼¼ Summary æ¨¡å—

**ä½ç½®**ï¼š`src/services/preprocessing/Preprocessor.ts`

```typescript
import { notificationService } from '@/services/NotificationService';

async preprocess(query: string) {
    const toast = notificationService.running(
        'æ­£åœ¨é¢„å¤„ç†è¾“å…¥...',
        'Engram é¢„å¤„ç†',
        () => this.cancel() // å–æ¶ˆå›è°ƒ
    );
    
    try {
        const result = await this.runLLM(query);
        notificationService.remove(toast);
        notificationService.success('é¢„å¤„ç†å®Œæˆ');
        return result;
    } catch (e) {
        notificationService.remove(toast);
        notificationService.error(`é¢„å¤„ç†å¤±è´¥: ${e.message}`);
        throw e;
    }
}
```

#### B. é…’é¦†åœæ­¢ç”Ÿæˆ API é›†æˆ

**é—®é¢˜**ï¼šå½“å‰ Summary å–æ¶ˆæŒ‰é’®åªåœæ­¢ Engram å†…éƒ¨ï¼Œæœªè°ƒç”¨é…’é¦† stopGeneration

**é…’é¦† API**ï¼š

```typescript
// é…’é¦†é€šè¿‡ st-context å¯¼å‡º stopGeneration
import('/scripts/st-context.js').then(module => {
    module.stopGeneration();
});
```

**ä¿®å¤ä½ç½®**ï¼š`SummarizerService.ts` å–æ¶ˆé€»è¾‘

```typescript
async cancel() {
    this.abortController?.abort();
    
    // è°ƒç”¨é…’é¦†åœæ­¢ç”Ÿæˆ
    try {
        const stContext = await import('/scripts/st-context.js');
        stContext.stopGeneration?.();
    } catch (e) {
        Logger.warn('SummarizerService', 'æ— æ³•è°ƒç”¨é…’é¦† stopGeneration');
    }
}
```

---

## äºŒã€æ—¥å¿—ç³»ç»Ÿä¼˜åŒ–

### 2.1 ç°æœ‰ DevLog ç»“æ„

**å½“å‰ Tab**ï¼š
- `runtime` - è¿è¡Œæ—¥å¿—
- `model` - æ¨¡å‹æ—¥å¿—

**æ¨¡å—è¿‡æ»¤**ï¼šLogger, EventBus, Summarizer, CORE/Pipeline, CORE/RAG, CORE/Memory, UI/GraphView, UI/MemoryStream

### 2.2 æ–°å¢ï¼šå¬å›ç»“æœæ—¥å¿— Tab

**ç›®æ ‡**ï¼šå‚è€ƒ `ragtest_v5_standalone.html` å®ç°å¬å›ç»“æœå¯è§†åŒ–

#### A. æ•°æ®ç»“æ„

```typescript
interface RecallLogEntry {
    id: string;
    timestamp: number;
    query: string;                    // æ£€ç´¢æŸ¥è¯¢
    rerankInstruction?: string;       // Rerank æŒ‡ä»¤ï¼ˆå¦‚æœ‰ï¼‰
    mode: 'embedding' | 'hybrid';     // å¬å›æ¨¡å¼
    
    // å¬å›ç»“æœ
    results: Array<{
        eventId: string;
        summary: string;
        embeddingScore: number;       // å‘é‡ç›¸ä¼¼åº¦ [0-1]
        rerankScore?: number;         // Rerank åˆ†æ•° [0-1]
        hybridScore?: number;         // æ··åˆåˆ†æ•°
        isTopK: boolean;              // æ˜¯å¦è¿›å…¥ TopK
        isReranked: boolean;          // æ˜¯å¦é€šè¿‡ Rerank
        category: string;             // äº‹ä»¶ç±»å‹
    }>;
    
    // ç»Ÿè®¡
    stats: {
        totalCandidates: number;
        topKCount: number;
        rerankCount: number;
        latencyMs: number;
    };
}
```

#### B. UI è®¾è®¡

å‚è€ƒ ragtest_v5ï¼š

1. **åˆ†ç»„è¿‡æ»¤**
   - å…¨éƒ¨ / TopK / Reranked

2. **åˆ†æ•°å±•ç¤º**
   - åŒåˆ†æ•°æ¡ï¼šEmbedding (è“) + Rerank (æ©™)
   - æ··åˆåˆ†æ•°å¾½ç« 

3. **æ’åºæ¨¡å¼**
   - Embedding / Rerank / Hybrid

4. **è¯¦æƒ…å±•å¼€**
   - ç‚¹å‡»æŸ¥çœ‹å®Œæ•´ summary
   - æ˜¾ç¤ºäº‹ä»¶å…ƒæ•°æ®

#### C. å®ç°ä½ç½®

| æ–‡ä»¶ | è¯´æ˜ |
|-----|-----|
| `src/views/DevLog/RecallLog.tsx` | æ–°å¢å¬å›æ—¥å¿—ç»„ä»¶ |
| `src/views/DevLog/index.tsx` | æ·»åŠ  `recall` Tab |
| `src/stores/devLogStore.ts` | æ–°å¢ recallLogs çŠ¶æ€ |
| `src/services/rag/Retriever.ts` | è®°å½•å¬å›æ—¥å¿— |

---

## ä¸‰ã€å®ç°æ­¥éª¤

### é˜¶æ®µä¸€ï¼šé€šçŸ¥ç³»ç»Ÿï¼ˆ1-2hï¼‰

1. [ ] é¢„å¤„ç†æ¨¡å—æ·»åŠ  running/cancel é€šçŸ¥
2. [ ] é›†æˆé…’é¦† stopGeneration API
3. [ ] ä¿®å¤ Summary å–æ¶ˆé€»è¾‘

### é˜¶æ®µäºŒï¼šå¬å›æ—¥å¿— Tabï¼ˆ2-3hï¼‰

1. [ ] å®šä¹‰ RecallLogEntry ç±»å‹
2. [ ] åˆ›å»º RecallLog.tsx ç»„ä»¶
3. [ ] æ·»åŠ åˆ° DevLog Tab
4. [ ] Retriever.ts è®°å½•æ—¥å¿—

### é˜¶æ®µä¸‰ï¼šUI æ‰“ç£¨ï¼ˆ1hï¼‰

1. [ ] åˆ†æ•°æ¡åŠ¨ç”»
2. [ ] è¿‡æ»¤å’Œæ’åºäº¤äº’
3. [ ] ç§»åŠ¨ç«¯é€‚é…

---

## å››ã€å‚è€ƒèµ„æ–™

- `test/ragtest_v5_standalone.html` - å¬å›ç»“æœ UI å‚è€ƒ
- `src/services/NotificationService.ts` - ç°æœ‰é€šçŸ¥å°è£…
- `src/views/DevLog/ModelLog.tsx` - æ¨¡å‹æ—¥å¿—å‚è€ƒ
- é…’é¦† `st-context.js` - stopGeneration API
