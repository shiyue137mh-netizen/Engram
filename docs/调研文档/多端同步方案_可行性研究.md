# 多端同步方案 - 可行性研究

> 📅 创建日期：2026-01-12  
> 📌 状态：待实现  
> 🎯 目标版本：V0.9.x

## 背景

当前 Engram 使用浏览器 IndexedDB 存储记忆数据，无法跨设备/浏览器同步。对于使用云部署或局域网访问酒馆的用户，需要一种多端同步方案。

## 目标用户画像

- 有技术能力，能够部署酒馆服务端
- 通过云服务器或局域网访问酒馆
- 需要在多台设备上访问同一角色的记忆数据

---

## 方案选型

### 方案 A：SQLite 文件（复杂但完善）

**原理**：IndexedDB 镜像到服务端 SQLite 文件

```
/data/user/extensions/Engram/engram.db
```

| 优点 | 缺点 |
|-----|-----|
| 单文件易备份 | 需要后端插件 |
| 支持复杂查询 | 维护成本高 |
| 可用向量扩展 | 用户安装复杂 |

---

### 方案 B：酒馆扩展后端插件

**原理**：利用 `server_plugins` 机制注入自定义 API

| 优点 | 缺点 |
|-----|-----|
| 完全后端化 | 需要额外安装 |
| 支持实时同步 | 两套代码维护 |

---

### ⭐ 方案 C：酒馆文件 API（推荐）

**原理**：利用酒馆现有 `/api/files/*` API 读写 JSON 文件

```
/data/user/extensions/Engram/
  ├── memories/{characterId}/{chatId}.json
  └── sync_meta.json
```

| 优点 | 缺点 |
|-----|-----|
| 零后端开发 | JSON 文件可能较大 |
| 立即可用 | 冲突处理需自行实现 |
| 跟随酒馆备份 | 无实时同步 |

---

## 推荐方案：C

### 数据流架构

```
┌──────────────────────────────────────────────┐
│           服务端 (酒馆 Node)                   │
│  /data/user/extensions/Engram/               │
│    ├── memories/{charId}/{chatId}.json       │
│    └── sync_meta.json                        │
└────────────────────┬─────────────────────────┘
                     │
       ┌─────────────┼─────────────┐
       ↓             ↓             ↓
   [设备 A]       [设备 B]       [设备 C]
   IndexedDB      IndexedDB      IndexedDB
```

### 同步策略

| 触发时机 | 行为 |
|---------|------|
| 扩展启动 | 拉取服务端数据，与本地合并 |
| 事件写入 | 写入 IndexedDB + 标记 dirty |
| 定时备份 | 每 N 分钟推送修改 |
| 切换聊天 | 推送当前聊天修改 |
| 手动同步 | 用户触发强制双向同步 |

### 冲突解决

```typescript
interface SyncMeta {
    version: number;        // 递增版本号
    lastModified: number;   // 时间戳
    deviceId: string;       // 设备标识
    checksum: string;       // 数据校验和
}

// 策略：Last-Write-Wins 或让用户选择
```

### 用户配置

```typescript
syncConfig: {
    enabled: boolean;
    autoSyncInterval: number;     // 分钟
    syncOnChatChange: boolean;
    conflictStrategy: 'last-write-wins' | 'ask-user';
}
```

---

## 实现步骤（估算）

1. **阶段一**：研究酒馆 `/api/files/*` API 确认可行性
2. **阶段二**：实现 `SyncService` 基础读写
3. **阶段三**：实现自动同步 + 冲突检测
4. **阶段四**：UI 配置界面 + 同步状态指示

---

## 待验证问题

- [ ] 酒馆 `/api/files/*` API 是否需要认证？
- [ ] 文件大小限制？
- [ ] 并发写入如何处理？

---

## 参考资料

- 酒馆源码：`/src/endpoints/files.js`
- IndexedDB 导出格式设计（待定）
