Engram æž¶æž„é‡æž„æŒ‡å— (Refactoring Guide)

ç›®æ ‡ç‰ˆæœ¬: v0.9
æ ¸å¿ƒåŽŸåˆ™: é¢†åŸŸé©±åŠ¨è®¾è®¡ (DDD)ã€Hooks ä¼˜å…ˆã€ç»Ÿä¸€å‘½åè§„èŒƒ
æœ€åŽæ›´æ–°: 2026-01-13

1. å‘½åè§„èŒƒ (Naming Conventions)

ä¸ºäº†è§£å†³ä»£ç åº“é£Žæ ¼ä¸ç»Ÿä¸€çš„é—®é¢˜ï¼Œæœ¬é¡¹ç›®å¼ºåˆ¶æ‰§è¡Œä»¥ä¸‹è§„èŒƒï¼š

ç±»åž‹

è§„èŒƒ

ç¤ºä¾‹

å¤‡æ³¨

æ–‡ä»¶å¤¹

kebab-case

input-processing/, visual-components/

é¿å…å¤§å°å†™æ•æ„Ÿé—®é¢˜

ç±»/æœåŠ¡

PascalCase

AgentService.ts, GraphManager.ts

å®žä½“ç±»æˆ–å•ä¾‹ç±»

Reactç»„ä»¶

PascalCase

EventCard.tsx, ChatPanel.tsx

å¿…é¡»ä¸º .tsx

Hook

camelCase (useå‰ç¼€)

useAgent.ts, useGraph.ts

å°è£…é€»è¾‘ä¾› UI è°ƒç”¨

å·¥å…·å‡½æ•°

camelCase

dateFormatter.ts, jsonParser.ts

çº¯å‡½æ•°

å¸¸é‡/æžšä¸¾

UPPER_SNAKE_CASE

MAX_TOKEN_LIMIT, TAVERN_EVENTS

-

2. å®Œæ•´ç›®å½•æž¶æž„æ ‘ (Directory Structure)

æ ¹ç›®å½•æ¦‚è§ˆ

src/
â”œâ”€â”€ components/          # çº¯å±•ç¤ºç»„ä»¶ (Presentational Components)
â”œâ”€â”€ views/               # é¡µé¢çº§å®¹å™¨ (Container Components)
â”œâ”€â”€ stores/              # Zustand çŠ¶æ€ (UI State + ç®€å•äº¤äº’)
â”œâ”€â”€ hooks/               # é€»è¾‘èƒ¶æ°´å±‚ (View åº”è¯¥åªè°ƒç”¨ Hookï¼Œä¸ç›´æŽ¥è°ƒ Service)
â”œâ”€â”€ services/            # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (æŒ‰é¢†åŸŸåˆ’åˆ†)
â”œâ”€â”€ tavern/              # å®¿ä¸»é€‚é…å±‚ (Anti-Corruption Layer)
â”œâ”€â”€ types/               # ç±»åž‹å®šä¹‰
â””â”€â”€ utils/               # é€šç”¨å·¥å…·


è¯¦ç»†ç»“æž„å±•å¼€

2.1 ðŸ§  src/services/ (æ ¸å¿ƒä¸šåŠ¡å±‚)

è¿™æ˜¯é‡æž„çš„é‡ç‚¹ï¼Œå°†æ‰å¹³çš„ services æ‹†åˆ†ä¸ºé¢†åŸŸæ¨¡å—ã€‚

src/services/
â”œâ”€â”€ core/                        # [åŸºç¡€æž¶æž„]
â”‚   â”œâ”€â”€ Logger.ts                # åŽŸ lib/Logger
â”‚   â”œâ”€â”€ EventBus.ts              # å†…éƒ¨äº‹ä»¶æ€»çº¿ (è§£è€¦ TavernEvents)
â”‚   â””â”€â”€ Bootstrapper.ts          # åº”ç”¨å¯åŠ¨/åˆå§‹åŒ–é€»è¾‘
â”‚
â”œâ”€â”€ data/                        # [æ•°æ®æŒä¹…åŒ–]
â”‚   â”œâ”€â”€ db.ts                    # Dexie æ•°æ®åº“å®šä¹‰
â”‚   â”œâ”€â”€ DatabaseMigrator.ts      # æ•°æ®åº“è¿ç§»é€»è¾‘
â”‚   â”œâ”€â”€ Persistence.ts           # è®¾ç½®æŒä¹…åŒ– (åŽŸ settings/Persistence)
â”‚   â””â”€â”€ RevisionService.ts       # ç‰ˆæœ¬æŽ§åˆ¶/å›žæ»š
â”‚
â”œâ”€â”€ llm/                         # [æ¨¡åž‹äº¤äº’]
â”‚   â”œâ”€â”€ Adapter.ts               # ç»Ÿä¸€ LLM æŽ¥å£ (åŽŸ LLMAdapter)
â”‚   â”œâ”€â”€ ModelDiscovery.ts        # æ¨¡åž‹å‘çŽ°
â”‚   â””â”€â”€ PromptManager.ts         # æç¤ºè¯æ¨¡æ¿ç®¡ç†
â”‚
â”œâ”€â”€ rag/                         # [æ£€ç´¢å¢žå¼º] (æ ¸å¿ƒèµ„äº§)
â”‚   â”œâ”€â”€ VectorStore.ts           # å‘é‡å­˜å‚¨æ“ä½œ
â”‚   â”œâ”€â”€ EmbeddingService.ts      # å‘é‡åŒ–æœåŠ¡
â”‚   â”œâ”€â”€ Retriever.ts             # å¬å›žå™¨
â”‚   â””â”€â”€ Reranker.ts              # é‡æŽ’æœåŠ¡
â”‚
â”œâ”€â”€ workflow/                    # [ä¸šåŠ¡æµå¼•æ“Ž] (åˆå¹¶åŽŸ pipeline & summarizer)
â”‚   â”œâ”€â”€ Coordinator.ts           # ä»»åŠ¡åè°ƒå™¨ (åŽŸ Pipeline.ts)
â”‚   â”œâ”€â”€ Extractor.ts             # ä¿¡æ¯æŠ½å– (åŽŸ TextProcessor)
â”‚   â”œâ”€â”€ Summarizer.ts            # å‰§æƒ…æ€»ç»“ (åŽŸ SummarizerService) âš ï¸ æ ¸å¿ƒ
â”‚   â””â”€â”€ Trimmer.ts               # è®°å¿†ç²¾ç®€ (åŽŸ TrimmerService)   âš ï¸ æ ¸å¿ƒ
â”‚
â”œâ”€â”€ input-processing/            # [è¾“å…¥é¢„å¤„ç†] (åŽŸ preprocessing, å·²æ”¹å)
â”‚   â”œâ”€â”€ InputEnhancer.ts         # è¾“å…¥å¢žå¼ºå…¥å£ (åŽŸ Preprocessor)
â”‚   â””â”€â”€ OutputParser.ts          # XML/JSON è§£æž
â”‚
â”œâ”€â”€ agent/                       # [Agent æ¨¡å—] (âœ¨ æ–°å¢ž)
â”‚   â”œâ”€â”€ AgentService.ts          # Copilot ä¸»é€»è¾‘
â”‚   â”œâ”€â”€ ContextBuilder.ts        # é’ˆå¯¹ Agent çš„ä¸Šä¸‹æ–‡ç»„è£…
â”‚   â””â”€â”€ tools/                   # Agent å¯ç”¨å·¥å…·é›†
â”‚       â”œâ”€â”€ WorldBookTool.ts
â”‚       â””â”€â”€ MemorySearchTool.ts
â”‚
â”œâ”€â”€ ui/                          # [UI äº¤äº’æœåŠ¡]
â”‚   â”œâ”€â”€ ThemeManager.ts          # æ ·å¼åˆ‡æ¢
â”‚   â””â”€â”€ NotificationService.ts   # é€šçŸ¥å¼¹çª—
â”‚
â””â”€â”€ integration/                 # [å¤–éƒ¨é›†æˆ]
    â””â”€â”€ WorldBookSync.ts         # ä¸–ç•Œä¹¦åŒæ­¥ (åŽŸ WorldBookSlotService)


2.2 ðŸŽ£ src/hooks/ (Hooks å¤æ´»è®¡åˆ’)

View å±‚ç¦æ­¢ç›´æŽ¥ import { Service } from 'services/...'ï¼Œå¿…é¡»é€šè¿‡ Hookã€‚

src/hooks/
â”œâ”€â”€ useEngramEngine.ts           # å¯åŠ¨/æš‚åœæ•´ä¸ª Pipeline
â”œâ”€â”€ useAgent.ts                  # [æ–°] èŠå¤©ã€èŽ·å– Agent å»ºè®®
â”œâ”€â”€ useMemoryStream.ts           # èŽ·å–äº‹ä»¶æµã€æ‰‹åŠ¨è§¦å‘æ€»ç»“/Trim
â”œâ”€â”€ useGraphRAG.ts               # æ‰§è¡Œæœç´¢ã€èŽ·å–å›¾è°±æ•°æ®
â”œâ”€â”€ useSettings.ts               # èŽ·å–/ä¿®æ”¹è®¾ç½® (å°è£… Zustand + Persistence)
â”œâ”€â”€ useTheme.ts                  # åˆ‡æ¢ä¸»é¢˜
â””â”€â”€ useDevLog.ts                 # è°ƒè¯•æ—¥å¿—é’©å­


2.3 ðŸº src/tavern/ (å®¿ä¸»é€‚é…å±‚)

å°†æ‰€æœ‰ä¸Ž window.SillyTavern æ‰“äº¤é“çš„è„ä»£ç éš”ç¦»åœ¨æ­¤ã€‚

src/tavern/
â”œâ”€â”€ bridge.ts                    # jQuery æ¡¥æŽ¥ã€DOM æ“ä½œ
â”œâ”€â”€ events.ts                    # ç›‘å¬é…’é¦†äº‹ä»¶ (TavernEventType)
â”œâ”€â”€ macros.ts                    # å®æ³¨å†Œ ({{engramSummaries}})
â””â”€â”€ api/                         # å°è£…é…’é¦†åŽŸç”Ÿ API
    â”œâ”€â”€ WorldInfo.ts
    â””â”€â”€ ChatContext.ts


3. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å½’å±žè¯´æ˜Ž

ä½ ç‰¹åˆ«å…³å¿ƒçš„ Summary å’Œ Trim é€»è¾‘ï¼ŒçŽ°åœ¨æœ‰äº†æ˜Žç¡®çš„å½’å±žï¼šservices/workflow/ã€‚

ä¸ºä»€ä¹ˆæ”¾åœ¨ workflowï¼Ÿ

å› ä¸ºè¿™ä¸¤ä¸ªåŠŸèƒ½æœ¬è´¨ä¸Šæ˜¯åŽå°çš„è‡ªåŠ¨åŒ–å·¥ä½œæµ (ETL Workflows)ã€‚

Pipeline (Coordinator): æ˜¯æ€»æŒ‡æŒ¥ã€‚

Extractor: è´Ÿè´£ä»ŽåŽŸå§‹æ–‡æœ¬ä¸­æå–ç»“æž„åŒ–æ•°æ®ã€‚

Summarizer: è´Ÿè´£å°†å¤šä¸ªå°äº‹ä»¶èšåˆæˆå¤§æ‘˜è¦ã€‚

Trimmer: è´Ÿè´£ç›‘æŽ§ Token é˜ˆå€¼ï¼Œå¹¶è§¦å‘åŽ‹ç¼©ä»»åŠ¡ã€‚

å®ƒä»¬å…±åŒç»„æˆäº†ä¸€ä¸ªé—­çŽ¯çš„æ•°æ®å¤„ç†å¼•æ“Žï¼Œä¸å†åˆ†æ•£åœ¨ pipeline å’Œ summarizer ä¸¤ä¸ªå¹³çº§ç›®å½•ä¸­ã€‚

4. è¿ç§»è·¯å¾„å»ºè®® (Migration Strategy)

ä¸ºäº†ä¸ç ´åçŽ°æœ‰åŠŸèƒ½ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹æ­¥éª¤è¿›è¡Œï¼š

ç¬¬ä¸€é˜¶æ®µï¼šæ–‡ä»¶å½’ä½ (File Moving)

åˆ›å»ºæ–°çš„ç›®å½•ç»“æž„ (services/workflow, services/ui, services/data ç­‰)ã€‚

å°†æ ¹ç›®å½•ä¸‹çš„æ•£ä¹± Service ç§»åŠ¨åˆ°å¯¹åº”æ–‡ä»¶å¤¹ã€‚

å°† summarizer å’Œ pipeline æ–‡ä»¶å¤¹å†…çš„æ ¸å¿ƒé€»è¾‘æ–‡ä»¶ç§»åŠ¨åˆ° workflowã€‚

é‡è¦ï¼šä½¿ç”¨ IDE (VSCode) çš„é‡æž„åŠŸèƒ½è¿›è¡Œç§»åŠ¨ï¼Œä»¥è‡ªåŠ¨æ›´æ–° import è·¯å¾„ã€‚

ç¬¬äºŒé˜¶æ®µï¼šAgent æ¨¡å—å¼€å‘ (New Feature)

ç›´æŽ¥åœ¨ services/agent/ ä¸‹å¼€å‘æ–°åŠŸèƒ½ã€‚

åœ¨ hooks/useAgent.ts ä¸­å°è£…é€»è¾‘ã€‚

ç¡®ä¿æ–°ä»£ç éµå¾ªæ–°çš„å‘½åè§„èŒƒï¼ˆç±»å PascalCaseï¼Œæ–‡ä»¶å kebab-caseï¼‰ã€‚

ç¬¬ä¸‰é˜¶æ®µï¼šHook å±‚å°è£… (Refactoring)

æŒ‘é€‰ä¸€ä¸ªç®€å•çš„ View (ä¾‹å¦‚ ThemeSelector.tsx)ã€‚

æ£€æŸ¥å®ƒæ˜¯å¦ç›´æŽ¥è°ƒç”¨äº† ThemeManagerã€‚

æ”¹ä¸ºè°ƒç”¨ useTheme Hookã€‚

é€æ­¥æŽ¨å¹¿åˆ° MemoryStream å’Œ Dashboardã€‚

5. æ–°å¢ž Agent æ¨¡å—é¢„è§ˆ

åŸºäºŽæ–°æž¶æž„ï¼ŒAgent æ¨¡å—çš„æ–‡ä»¶å°†éžå¸¸æ¸…æ™°ï¼š

Logic: src/services/agent/AgentService.ts

è´Ÿè´£è°ƒç”¨ LLMï¼Œç»´æŠ¤ Agent çš„å¯¹è¯åŽ†å²ï¼Œåˆ†å‘å·¥å…·è°ƒç”¨ã€‚

Tools: src/services/agent/tools/

å®šä¹‰ Agent å¯ä»¥ä½¿ç”¨çš„èƒ½åŠ›ï¼ˆå¦‚ï¼šread_worldbook, search_graphï¼‰ã€‚

Hook: src/hooks/useAgent.ts

const { chatMessages, isLoading, sendMessage } = useAgent();

UI: src/views/AgentPanel/index.tsx

åªè´Ÿè´£æ¸²æŸ“èŠå¤©æ°”æ³¡å’Œè¾“å…¥æ¡†ã€‚



å¯ä»¥è€ƒè™‘ä½¿ç”¨ts-morph

import { Project, QuoteKind } from "ts-morph";
import * as path from "path";
import * as fs from "fs";

/**
 * Engram V0.9 æž¶æž„é‡æž„è„šæœ¬
 * * ç›®æ ‡ï¼šå°†æ‰å¹³ã€æ··ä¹±çš„æœåŠ¡å±‚é‡æž„ä¸ºé¢†åŸŸé©±åŠ¨ (DDD) çš„åˆ†å±‚æž¶æž„
 * å·¥å…·ï¼šts-morph (è‡ªåŠ¨å¤„ç† AST å’Œå¼•ç”¨æ›´æ–°)
 */

// åˆå§‹åŒ– Project
console.log("â³ Initializing project from tsconfig.json...");
const project = new Project({
    tsConfigFilePath: "tsconfig.json",
    manipulationSettings: {
        quoteKind: QuoteKind.Single, // ä¿æŒå•å¼•å·
    }
});

console.log("ðŸš€ Starting Engram V0.9 Refactoring...");

// å®šä¹‰ç§»åŠ¨æ˜ å°„è¡¨ (Source Path -> Target Path)
// æ³¨æ„ï¼šSource æ˜¯ç›¸å¯¹äºŽæ ¹ç›®å½•çš„ç›¸å¯¹è·¯å¾„
const moves = [
    // =================================================================
    // 1. UI Services (ç•Œé¢äº¤äº’æœåŠ¡)
    // =================================================================
    {
        from: "src/services/ThemeManager.ts",
        to: "src/services/ui/ThemeManager.ts"
    },
    {
        from: "src/services/NotificationService.ts",
        to: "src/services/ui/NotificationService.ts"
    },

    // =================================================================
    // 2. Data Services (æ•°æ®æŒä¹…åŒ–ä¸Žç®¡ç†)
    // =================================================================
    {
        from: "src/services/CharacterDeleteService.ts",
        to: "src/services/data/CharacterService.ts" // Rename: æ›´é€šç”¨
    },
    {
        from: "src/services/RevisionService.ts",
        to: "src/services/data/RevisionService.ts"
    },
    {
        from: "src/services/settings/Persistence.ts",
        to: "src/services/data/Persistence.ts"
    },
    // Database ç›®å½•åˆå¹¶å…¥ Data
    {
        from: "src/services/database/ChatManager.ts",
        to: "src/services/data/ChatManager.ts"
    },
    {
        from: "src/services/database/db.ts",
        to: "src/services/data/db.ts"
    },

    // =================================================================
    // 3. Integration (å¤–éƒ¨é›†æˆ)
    // =================================================================
    {
        from: "src/services/WorldBookSlotService.ts",
        to: "src/services/integration/WorldBookSync.ts" // Rename: æ˜Žç¡®åŠŸèƒ½
    },

    // =================================================================
    // 4. Core Services (åŸºç¡€æž¶æž„)
    // =================================================================
    // å°† Updater ç§»å…¥ core
    {
        from: "src/services/updater/index.ts",
        to: "src/services/core/Updater.ts"
    },
    // è¿ç§» Logger (ä»Ž lib ç§»å…¥ services/coreï¼Œæå‡åœ°ä½)
    {
        from: "src/lib/logger/Logger.ts",
        to: "src/services/core/Logger.ts"
    },
    {
        from: "src/lib/logger/ModelLogger.ts",
        to: "src/services/core/logger/ModelLogger.ts" // ä¿æŒå­æ¨¡å—
    },
    {
        from: "src/lib/logger/types.ts",
        to: "src/services/core/logger/types.ts"
    },
    {
        from: "src/lib/logger/index.ts",
        to: "src/services/core/logger/index.ts"
    },

    // =================================================================
    // 5. LLM Layer (æ¨¡åž‹äº¤äº’å±‚ - åŽŸ src/services/api)
    // =================================================================
    {
        from: "src/services/api/LLMAdapter.ts",
        to: "src/services/llm/Adapter.ts" // Rename: ç®€åŒ–åç§°
    },
    {
        from: "src/services/api/ModelDiscovery.ts",
        to: "src/services/llm/ModelDiscovery.ts"
    },
    {
        from: "src/services/api/types.ts",
        to: "src/services/llm/types.ts"
    },
    // æç¤ºè¯æ–‡ä»¶ (Prompts)
    // æ³¨æ„ï¼šts-morph ä¸»è¦å¤„ç† TS æ–‡ä»¶ï¼Œå¯¹äºŽ .md æ–‡ä»¶æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å¤„ç†æˆ–ä½¿ç”¨ fs
    // è¿™é‡Œæˆ‘ä»¬å…ˆç§»åŠ¨ index.tsï¼Œéž TS æ–‡ä»¶åœ¨æœ€åŽç»Ÿä¸€ç”¨ fs ç§»åŠ¨

    // =================================================================
    // 6. Input Processing (åŽŸ Preprocessing)
    // =================================================================
    {
        from: "src/services/preprocessing/Preprocessor.ts",
        to: "src/services/input-processing/InputEnhancer.ts" // Rename: å¢žå¼ºå™¨
    },
    {
        from: "src/services/preprocessing/index.ts",
        to: "src/services/input-processing/index.ts"
    },
    {
        from: "src/services/preprocessing/types.ts",
        to: "src/services/input-processing/types.ts"
    },
    // OutputParser å¦‚æžœåœ¨åŽŸç›®å½•æœ‰æ—§ç‰ˆï¼Œä¼šè¢«ç§»åŠ¨ï¼›å¦‚æžœæ˜¯æ–°ç”Ÿæˆçš„ï¼Œå»ºè®®æ‰‹åŠ¨æ£€æŸ¥

    // =================================================================
    // 7. Workflow Engine (åˆå¹¶ Pipeline & Summarizer)
    // =================================================================
    // Pipeline éƒ¨åˆ†
    {
        from: "src/services/pipeline/Pipeline.ts",
        to: "src/services/workflow/Coordinator.ts" // Rename: åè°ƒå™¨
    },
    {
        from: "src/services/pipeline/TextProcessor.ts",
        to: "src/services/workflow/Extractor.ts" // Rename: æŠ½å–å™¨
    },
    {
        from: "src/services/pipeline/RegexProcessor.ts",
        to: "src/services/workflow/RegexProcessor.ts"
    },
    {
        from: "src/services/pipeline/EventTrimmer.ts",
        to: "src/services/workflow/EventTrimmer.ts"
    },
    // Summarizer éƒ¨åˆ†
    {
        from: "src/services/summarizer/SummarizerService.ts",
        to: "src/services/workflow/Summarizer.ts"
    },
    {
        from: "src/services/summarizer/TrimmerService.ts",
        to: "src/services/workflow/LegacyTrimmer.ts" // æ ‡è®°ä¸ºæ—§ç‰ˆï¼ŒåŽç»­åˆå¹¶
    },
    {
        from: "src/services/summarizer/types.ts",
        to: "src/services/workflow/types.ts"
    },
    // å¦‚æžœæœ‰ index.ts éœ€è¦å¤„ç†å†²çªï¼Œè¿™é‡Œæš‚ä¸ç§»åŠ¨ index.tsï¼Œå»ºè®®é‡æ–°ç”Ÿæˆ
];

// éž TS èµ„æºçš„ç§»åŠ¨ (Markdown Prompts ç­‰)
const assetMoves = [
    { fromDir: "src/services/api/prompts", toDir: "src/services/llm/prompts" }
];

async function run() {
    let successCount = 0;
    let failCount = 0;

    // 1. æ‰§è¡Œ TS æ–‡ä»¶ç§»åŠ¨
    for (const move of moves) {
        const sourceFile = project.getSourceFile(move.from);

        if (sourceFile) {
            try {
                // ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨ï¼ˆè™½ç„¶ move ä¼šå¤„ç†ï¼Œä½†ä¸ºäº†å®‰å…¨ï¼‰
                const targetDir = path.dirname(move.to);
                
                console.log(`[Move] ${path.basename(move.from)} -> ${move.to}`);
                
                // æ‰§è¡Œç§»åŠ¨ï¼Œè¿™ä¼šè‡ªåŠ¨æ›´æ–°æ‰€æœ‰ import è·¯å¾„
                await sourceFile.move(move.to);
                successCount++;
            } catch (err) {
                console.error(`âŒ Error moving ${move.from}:`, err);
                failCount++;
            }
        } else {
            console.warn(`âš ï¸  Source file not found (skipped): ${move.from}`);
        }
    }

    // 2. æ‰§è¡Œèµ„æºæ–‡ä»¶ç§»åŠ¨ (ä½¿ç”¨ fs)
    for (const asset of assetMoves) {
        if (fs.existsSync(asset.fromDir)) {
            console.log(`[Asset] Moving directory ${asset.fromDir} -> ${asset.toDir}`);
            try {
                // ç®€å•çš„é€’å½’å¤åˆ¶+åˆ é™¤æ¨¡æ‹Ÿç§»åŠ¨
                if (!fs.existsSync(asset.toDir)) {
                    fs.mkdirSync(asset.toDir, { recursive: true });
                }
                const files = fs.readdirSync(asset.fromDir);
                for (const file of files) {
                    const srcPath = path.join(asset.fromDir, file);
                    const destPath = path.join(asset.toDir, file);
                    fs.renameSync(srcPath, destPath);
                }
                // ç§»é™¤åŽŸç›®å½•
                fs.rmdirSync(asset.fromDir);
            } catch (e) {
                console.error(`âŒ Error moving assets:`, e);
            }
        }
    }

    // 3. ä¿å­˜æ›´æ”¹åˆ°ç£ç›˜
    console.log("ðŸ’¾ Saving changes to file system...");
    await project.save();

    console.log("------------------------------------------------");
    console.log(`âœ… Refactoring Complete!`);
    console.log(`   Success: ${successCount}`);
    console.log(`   Skipped/Failed: ${failCount}`);
    console.log("------------------------------------------------");
    console.log("ðŸ‘‰ Next Steps:");
    console.log("1. Manually delete empty folders in src/services/");
    console.log("2. Check 'src/services/workflow/types.ts' for merge conflicts if any.");
    console.log("3. Run 'npm run dev' to verify build.");
}

run().catch(err => {
    console.error("Fatal Error:", err);
});
