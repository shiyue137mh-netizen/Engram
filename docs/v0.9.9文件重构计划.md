# Engram V0.9.9 æ¶æ„é‡æ„è®¡åˆ’ (V4 Final)

> ç‰ˆæœ¬: V4.0 (å®Œæ•´æ–‡ä»¶è¿ç§»æ¸…å•)
> æ›´æ–°æ—¥æœŸ: 2026-01-18
> è®¾è®¡åŸåˆ™: åˆ†å±‚æ¨¡å—åŒ–ã€å•å‘ä¾èµ–ã€é˜²è…å±‚éš”ç¦»

---

## ä¸€ã€æ¶æ„åˆ†å±‚ä¸ä¾èµ–æ–¹å‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         UI Layer                            â”‚
â”‚   (ui/views, ui/components, ui/hooks)                       â”‚
â”‚                           â†“ ä¾èµ–                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        State Layer                          â”‚
â”‚   (state/ - Zustand stores)                                 â”‚
â”‚                           â†“ è®¢é˜…                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Module Layer (ä¸šåŠ¡æ ¸å¿ƒ)                     â”‚
â”‚   (modules/memory, modules/rag, modules/workflow...)        â”‚
â”‚                           â†“ è°ƒç”¨                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Integration Layer                        â”‚
â”‚   (integrations/tavern, integrations/llm)                   â”‚
â”‚                           â†“ è°ƒç”¨                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        Data Layer                           â”‚
â”‚   (data/db, data/repositories)                              â”‚
â”‚                           â†“ è°ƒç”¨                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        Core Layer                           â”‚
â”‚   (core/logger, core/utils, core/events)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®çº¦æŸ**ï¼š
- âŒ Module ä¸å¾— import `ui/` æˆ– `state/`
- âŒ Integration ä¸å¾—åŒ…å«ä¸šåŠ¡é€»è¾‘
- âœ… Module é€šè¿‡äº‹ä»¶/Observable é€šçŸ¥çŠ¶æ€å˜åŒ–

---

## äºŒã€ç›®æ ‡ç›®å½•ç»“æ„ (V5 ä¿®è®¢)

```
src/
â”œâ”€â”€ core/                               # ğŸ”§ åŸºç¡€è®¾æ–½å±‚ (æ— ä¸šåŠ¡)
â”‚   â”œâ”€â”€ logger/
â”‚   â”‚   â”œâ”€â”€ Logger.ts
â”‚   â”‚   â”œâ”€â”€ ModelLogger.ts
â”‚   â”‚   â”œâ”€â”€ RecallLogger.ts             # åŸ rag/RecallLogService
â”‚   â”‚   â””â”€â”€ types.ts
â”‚   â”œâ”€â”€ events/
â”‚   â”‚   â”œâ”€â”€ EventBus.ts                 # ğŸ†• å†…éƒ¨äº‹ä»¶æ€»çº¿
â”‚   â”‚   â”œâ”€â”€ EventWatcher.ts
â”‚   â”‚   â”œâ”€â”€ RevisionBridge.ts           # ğŸ†• åŸ RevisionService
â”‚   â”‚   â””â”€â”€ types.ts
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ JsonParser.ts
â”‚   â”‚   â””â”€â”€ cn.ts
â”‚   â”œâ”€â”€ updater/
â”‚   â”‚   â””â”€â”€ Updater.ts
â”‚   â””â”€â”€ KeyboardManager.ts
â”‚
â”œâ”€â”€ data/                               # ğŸ’¾ æ•°æ®å±‚ (çº¯å­˜å‚¨+æ•°æ®æ“ä½œ)
â”‚   â”œâ”€â”€ db.ts
â”‚   â”œâ”€â”€ ChatManager.ts
â”‚   â”œâ”€â”€ repositories/                   # ğŸ†• æ•°æ®ä»“å‚¨
â”‚   â”‚   â”œâ”€â”€ EventRepository.ts          # ä» memoryStore æå–
â”‚   â”‚   â””â”€â”€ EntityRepository.ts         # ä» memoryStore æå–
â”‚   â”œâ”€â”€ cleanup/                        # ğŸ†• æ•°æ®æ¸…ç†
â”‚   â”‚   â””â”€â”€ CharacterCleanup.ts         # åŸ CharacterDeleteService
â”‚   â”œâ”€â”€ sync/                           # æ•°æ®åŒæ­¥
â”‚   â”‚   â””â”€â”€ SyncService.ts              # åŸ services/SyncService
â”‚   â””â”€â”€ types/
â”‚       â”œâ”€â”€ graph.ts
â”‚       â””â”€â”€ events.ts
â”‚
â”œâ”€â”€ config/                             # âš™ï¸ é…ç½®å±‚
â”‚   â”œâ”€â”€ settings.ts
â”‚   â””â”€â”€ types/
â”‚       â”œâ”€â”€ llm.ts
â”‚       â”œâ”€â”€ rag.ts
â”‚       â”œâ”€â”€ memory.ts
â”‚       â”œâ”€â”€ prompt.ts
â”‚       â””â”€â”€ defaults.ts
â”‚
â”œâ”€â”€ integrations/                       # ğŸ”Œ å¤–éƒ¨é›†æˆå±‚ (é˜²è…)
â”‚   â”œâ”€â”€ tavern/
â”‚   â”‚   â”œâ”€â”€ api/                        # æ•°æ®äº¤äº’
â”‚   â”‚   â”‚   â”œâ”€â”€ WorldInfo.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ Message.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ bridge.ts                   # jQuery æ¡¥æ¥
â”‚   â”‚   â”œâ”€â”€ context.ts                  # ä¸Šä¸‹æ–‡è·å–
â”‚   â”‚   â”œâ”€â”€ events.ts                   # äº‹ä»¶ç›‘å¬
â”‚   â”‚   â”œâ”€â”€ macros.ts                   # å®æ³¨å†Œ
â”‚   â”‚   â”œâ”€â”€ ui.ts                       # DOM æ“ä½œ
â”‚   â”‚   â”œâ”€â”€ WorldBookSlot.ts            # ğŸ”„ åŸ WorldBookSlotService
â”‚   â”‚   â””â”€â”€ WorldBookState.ts
â”‚   â”‚
â”‚   â””â”€â”€ llm/
â”‚       â”œâ”€â”€ Adapter.ts
â”‚       â”œâ”€â”€ ModelDiscovery.ts
â”‚       â””â”€â”€ index.ts
â”‚
â”œâ”€â”€ modules/                            # ğŸ“¦ ä¸šåŠ¡æ¨¡å—å±‚ (æ ¸å¿ƒ)
â”‚   â”‚
â”‚   â”œâ”€â”€ memory/                         # è®°å¿†å¤„ç†
â”‚   â”‚   â”œâ”€â”€ Summarizer.ts
â”‚   â”‚   â”œâ”€â”€ Trimmer.ts
â”‚   â”‚   â”œâ”€â”€ EventTrimmer.ts
â”‚   â”‚   â”œâ”€â”€ extractors/
â”‚   â”‚   â”‚   â”œâ”€â”€ TextProcessor.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ RegexProcessor.ts
â”‚   â”‚   â”‚   â””â”€â”€ EntityExtractor.ts
â”‚   â”‚   â”œâ”€â”€ prompts/ (å·²è¿ç§»è‡³ integrations/llm/prompts)
â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ rag/                            # æ£€ç´¢å¢å¼º
â”‚   â”‚   â”œâ”€â”€ embedding/
â”‚   â”‚   â”‚   â””â”€â”€ EmbeddingService.ts
â”‚   â”‚   â”œâ”€â”€ retrieval/
â”‚   â”‚   â”‚   â”œâ”€â”€ Retriever.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ HybridScorer.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ Reranker.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ BrainRecallCache.ts
â”‚   â”‚   â”‚   â””â”€â”€ StickyCache.ts
â”‚   â”‚   â”œâ”€â”€ injection/
â”‚   â”‚   â”‚   â””â”€â”€ Injector.ts
â”‚   â”‚   â”‚   â””â”€â”€ query_enhance.md
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ search/                         # ç»Ÿä¸€æœç´¢
â”‚   â”‚   â”œâ”€â”€ SearchService.ts
â”‚   â”‚   â””â”€â”€ adapters/
â”‚   â”‚       â”œâ”€â”€ CommandAdapter.ts
â”‚   â”‚       â”œâ”€â”€ LogAdapter.ts
â”‚   â”‚       â”œâ”€â”€ MemoryAdapter.ts
â”‚   â”‚       â”œâ”€â”€ PresetAdapter.ts
â”‚   â”‚       â””â”€â”€ SettingAdapter.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ preprocessing/                  # è¾“å…¥é¢„å¤„ç†
â”‚   â”‚   â”œâ”€â”€ Preprocessor.ts
â”‚   â”‚   â”‚   â””â”€â”€ description.md
â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ batch/                          # æ‰¹å¤„ç†
â”‚   â”‚   â”œâ”€â”€ BatchProcessor.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â””â”€â”€ workflow/                       # ç¼–æ’å±‚
â”‚       â”œâ”€â”€ Pipeline.ts
â”‚       â”œâ”€â”€ RecallWorkflow.ts
â”‚       â””â”€â”€ BatchWorkflow.ts
â”‚
â”œâ”€â”€ state/                              # ğŸ—ƒï¸ çŠ¶æ€å±‚ (çº¯å¿«ç…§ï¼Œæ—  DB æ“ä½œ)
â”‚   â”œâ”€â”€ memoryStore.ts                  # âš ï¸ éœ€é‡æ„ï¼šç§»é™¤ DB æ“ä½œ
â”‚   â”œâ”€â”€ themeStore.ts
â”‚   â”œâ”€â”€ devLogStore.ts
â”‚   â”œâ”€â”€ commandStore.ts
â”‚   â””â”€â”€ index.ts
â”‚
â”œâ”€â”€ ui/                                 # ğŸ¨ UI å±‚
â”‚   â”œâ”€â”€ services/                       # UI ä¸“å±æœåŠ¡ (ä»…æ“ä½œ DOM)
â”‚   â”‚   â”œâ”€â”€ ThemeManager.ts             # æ“ä½œ CSS å˜é‡
â”‚   â”‚   â””â”€â”€ NotificationService.ts      # æ“ä½œ Toastr
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useWorkflow.ts
â”‚   â”‚   â”œâ”€â”€ useRag.ts
â”‚   â”‚   â”œâ”€â”€ useSettings.ts
â”‚   â”‚   â”œâ”€â”€ useApiPresets.ts
â”‚   â”‚   â”œâ”€â”€ useDashboardData.ts
â”‚   â”‚   â”œâ”€â”€ useDevLog.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â”œâ”€â”€ api-presets/
â”‚   â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ memory-stream/
â”‚   â”‚   â”œâ”€â”€ processing/
â”‚   â”‚   â”œâ”€â”€ dev-log/
â”‚   â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â””â”€â”€ quick-panel/
â”‚   â”‚
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”œâ”€â”€ layout/
â”‚   â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â””â”€â”€ visual/
â”‚   â”‚
â”‚   â”œâ”€â”€ styles/
â”‚   â””â”€â”€ assets/
â”‚
â”œâ”€â”€ @types/                             # ğŸ“ ç±»å‹å£°æ˜
â”‚   â”œâ”€â”€ global.d.ts
â”‚   â””â”€â”€ st-types/
â”‚
â”œâ”€â”€ constants/
â”œâ”€â”€ App.tsx
â””â”€â”€ index.tsx
```

---

## ä¸‰ã€å®Œæ•´æ–‡ä»¶è¿ç§»æ¸…å• (V5 ä¿®è®¢)

### 3.1 Core Layer (åŸºç¡€è®¾æ–½)

| åŸè·¯å¾„ | æ–°è·¯å¾„ | è¯´æ˜ |
|--------|--------|------|
| `lib/logger/Logger.ts` | `core/logger/Logger.ts` | æ—¥å¿— |
| `lib/logger/ModelLogger.ts` | `core/logger/ModelLogger.ts` | æ¨¡å‹è°ƒç”¨æ—¥å¿— |
| `lib/logger/types.ts` | `core/logger/types.ts` | |
| `lib/logger/index.ts` | `core/logger/index.ts` | |
| `services/rag/RecallLogService.ts` | `core/logger/RecallLogger.ts` | å¬å›æ—¥å¿— |
| `lib/EventWatcher.ts` | `core/events/EventWatcher.ts` | äº‹ä»¶ç›‘å¬ |
| `lib/events.ts` | `core/events/types.ts` | äº‹ä»¶ç±»å‹ |
| `services/RevisionService.ts` | `core/events/RevisionBridge.ts` | ğŸ†• ä¿®è®¢äº‹ä»¶æ¡¥æ¥ (åŸ UI Service) |
| (æ–°å»º) | `core/events/EventBus.ts` | ğŸ†• å†…éƒ¨äº‹ä»¶æ€»çº¿ (Pub/Sub) |
| `lib/KeyboardManager.ts` | `core/KeyboardManager.ts` | é”®ç›˜å¿«æ·é”® |
| `services/updater/index.ts` | `core/updater/Updater.ts` | ç‰ˆæœ¬æ›´æ–° |
| `utils/JsonParser.ts` | `core/utils/JsonParser.ts` | JSON è§£æ |
| `utils/cn.ts` | `core/utils/cn.ts` | ç±»åæ‹¼æ¥ |
| `utils/index.ts` | `core/utils/index.ts` | |

### 3.2 Data Layer (æ•°æ®å­˜å‚¨)

| åŸè·¯å¾„ | æ–°è·¯å¾„ | è¯´æ˜ |
|--------|--------|------|
| `services/database/db.ts` | `data/db.ts` | Dexie å®šä¹‰ |
| `services/database/ChatManager.ts` | `data/ChatManager.ts` | èŠå¤©ä½œç”¨åŸŸ |
| `services/types/graph.ts` | `data/types/graph.ts` | å›¾è°±å®ä½“ç±»å‹ |
| `services/types/events.ts` | `data/types/events.ts` | äº‹ä»¶ç±»å‹ |
| `services/SyncService.ts` | `data/sync/SyncService.ts` | ğŸ”„ æ•°æ®åŒæ­¥ (åŸ Core Service) |
| `services/CharacterDeleteService.ts` | `data/cleanup/CharacterCleanup.ts` | ğŸ”„ è§’è‰²æ•°æ®æ¸…ç† (åŸ UI Service) |
| (ä» memoryStore æå–) | `data/repositories/EventRepository.ts` | ğŸ†• äº‹ä»¶ CRUD (è§£è€¦ State) |
| (ä» memoryStore æå–) | `data/repositories/EntityRepository.ts` | ğŸ†• å®ä½“ CRUD (è§£è€¦ State) |

### 3.3 Integration Layer (å¤–éƒ¨é›†æˆ)

#### 3.3.1 Tavern é€‚é… (ç»†åˆ†)

| åŸè·¯å¾„ | æ–°è·¯å¾„ | è¯´æ˜ |
|--------|--------|------|
| `tavern/api/WorldInfo.ts` | `integrations/tavern/api/WorldInfo.ts` | ä¸–ç•Œä¹¦ API |
| `tavern/api/Message.ts` | `integrations/tavern/api/Message.ts` | æ¶ˆæ¯ API |
| `tavern/api/index.ts` | `integrations/tavern/api/index.ts` | |
| `tavern/bridge.ts` | `integrations/tavern/bridge.ts` | jQuery æ¡¥æ¥ |
| `tavern/context.ts` | `integrations/tavern/context.ts` | ä¸Šä¸‹æ–‡è·å– |
| `tavern/TavernEvents.ts` | `integrations/tavern/events.ts` | äº‹ä»¶ç›‘å¬ |
| `tavern/MacroService.ts` | `integrations/tavern/macros.ts` | å®æ³¨å†Œ (éœ€è§£è€¦ Store) |
| `tavern/QuickPanelButton.ts` | `integrations/tavern/ui.ts` | UI æ“ä½œ |
| `tavern/WorldBookState.ts` | `integrations/tavern/WorldBookState.ts` | |
| `services/WorldBookSlotService.ts` | `integrations/tavern/WorldBookSlot.ts` | ğŸ”„ ä¸–ç•Œä¹¦æ§½ä½åŠæ‘˜è¦åŒæ­¥ |

#### 3.3.2 LLM é€‚é…

| åŸè·¯å¾„ | æ–°è·¯å¾„ | è¯´æ˜ |
|--------|--------|------|
| `services/api/LLMAdapter.ts` | `integrations/llm/Adapter.ts` | LLM è°ƒç”¨ |
| `services/api/ModelDiscovery.ts` | `integrations/llm/ModelDiscovery.ts` | æ¨¡å‹å‘ç° |
| `services/api/index.ts` | `integrations/llm/index.ts` | |

### 3.4 Config Layer (é…ç½®)

| åŸè·¯å¾„ | æ–°è·¯å¾„ | è¯´æ˜ |
|--------|--------|------|
| `services/settings/Persistence.ts` | `config/settings.ts` | é…ç½®æŒä¹…åŒ– |
| `services/api/types.ts` â†’ æ‹†åˆ† | `config/types/` | - [x] `src/services/api/types.ts`
  - æ‹†åˆ†åˆ°: `src/config/types/*.ts`
  - åŒ…å«:
    - [x] `llm.ts`: `LLMPreset`, `ContextSettings`
    - [x] `rag.ts`: `VectorConfig`, `RecallConfig`
    - [x] `memory.ts`: `TrimConfig`, `EntityExtractConfig`
    - [x] `prompt.ts`: `PromptTemplate`, `PromptCategory`
    - [x] `defaults.ts`: `DEFAULT_X_CONFIG`

### 2.5 Module Layer (ä¸šåŠ¡æ¨¡å—)

#### 2.5.1 Memory æ¨¡å— (è®°å¿†å¤„ç†)

| åŸè·¯å¾„ | æ–°è·¯å¾„ | è¯´æ˜ |
|--------|--------|------|
| `services/summarizer/SummarizerService.ts` | `modules/memory/Summarizer.ts` | å‰§æƒ…æ€»ç»“ |
| `services/summarizer/TrimmerService.ts` | `modules/memory/Trimmer.ts` | Token ç²¾ç®€ |
| `services/summarizer/types.ts` | `modules/memory/types.ts` | |
| `services/summarizer/index.ts` | `modules/memory/index.ts` | |
| `services/pipeline/EventTrimmer.ts` | `modules/memory/EventTrimmer.ts` | äº‹ä»¶ç²¾ç®€ |
| `services/pipeline/TextProcessor.ts` | `modules/memory/extractors/TextProcessor.ts` | æ–‡æœ¬æ¸…æ´— |
| `services/pipeline/RegexProcessor.ts` | `modules/memory/extractors/RegexProcessor.ts` | æ­£åˆ™å¤„ç† |
| `services/graph/EntityBuilder.ts` | `modules/memory/extractors/EntityExtractor.ts` | å®ä½“æå– |
| `services/api/prompts/summary_prompt.md` | `modules/memory/prompts/summary.md` | ğŸ“ [é‡å‘½å] æ€»ç»“æç¤ºè¯ |
| `services/api/prompts/trim.md` | `modules/memory/prompts/trim.md` | ç²¾ç®€æç¤ºè¯ |
| `services/api/prompts/entity_extraction.md` | `modules/memory/prompts/entity.md` | ğŸ“ [é‡å‘½å] å®ä½“æå–æç¤ºè¯ |

#### 2.5.2 RAG æ¨¡å— (æ£€ç´¢å¢å¼º)

| åŸè·¯å¾„ | æ–°è·¯å¾„ | è¯´æ˜ |
|--------|--------|------|
| `services/rag/EmbeddingService.ts` | `modules/rag/embedding/EmbeddingService.ts` | å‘é‡åŒ– |
| `services/rag/Retriever.ts` | `modules/rag/retrieval/Retriever.ts` | æ£€ç´¢ |
| `services/rag/HybridScorer.ts` | `modules/rag/retrieval/HybridScorer.ts` | æ··åˆè¯„åˆ† |
| `services/rag/RerankService.ts` | `modules/rag/retrieval/Reranker.ts` | é‡æ’ |
| `services/rag/BrainRecallCache.ts` | `modules/rag/retrieval/BrainRecallCache.ts` | ç±»è„‘å¬å› |
| `services/rag/StickyCache.ts` | `modules/rag/retrieval/StickyCache.ts` | é»æ€§ç¼“å­˜ |
| `services/rag/Injector.ts` | `modules/rag/injection/Injector.ts` | æ³¨å…¥ |
| `services/rag/index.ts` | `modules/rag/index.ts` | |
| `services/api/prompts/query_enhance.md` | `modules/rag/prompts/query_enhance.md` | ğŸ“ [é‡å‘½å] æ£€ç´¢å¢å¼ºæç¤ºè¯ |

#### 2.5.3 Search æ¨¡å— (ç»Ÿä¸€æœç´¢)

| åŸè·¯å¾„ | æ–°è·¯å¾„ | è¯´æ˜ |
|--------|--------|------|
| `services/search/SearchService.ts` | `modules/search/SearchService.ts` | æœç´¢å…¥å£ |
| `services/search/adapters/CommandAdapter.ts` | `modules/search/adapters/CommandAdapter.ts` | å‘½ä»¤é€‚é… |
| `services/search/adapters/LogAdapter.ts` | `modules/search/adapters/LogAdapter.ts` | æ—¥å¿—é€‚é… |
| `services/search/adapters/MemoryAdapter.ts` | `modules/search/adapters/MemoryAdapter.ts` | è®°å¿†é€‚é… |
| `services/search/adapters/PresetAdapter.ts` | `modules/search/adapters/PresetAdapter.ts` | é¢„è®¾é€‚é… |
| `services/search/adapters/SettingAdapter.ts` | `modules/search/adapters/SettingAdapter.ts` | è®¾ç½®é€‚é… |

#### 2.5.4 Preprocessing æ¨¡å— (è¾“å…¥é¢„å¤„ç†)

| åŸè·¯å¾„ | æ–°è·¯å¾„ | è¯´æ˜ |
|--------|--------|------|
| `services/preprocessing/Preprocessor.ts` | `modules/preprocessing/Preprocessor.ts` | é¢„å¤„ç†å™¨ |
| `services/preprocessing/types.ts` | `modules/preprocessing/types.ts` | |
| `services/preprocessing/index.ts` | `modules/preprocessing/index.ts` | |
| `services/api/prompts/description.md` | `modules/preprocessing/prompts/description.md` | ğŸ“ [é‡å‘½å] å‰§æƒ…æè¿°æç¤ºè¯ |
| `services/api/prompts/plot_director.md` | `modules/preprocessing/prompts/plot_director.md` | ğŸ“ [é‡å‘½å] å‰§æƒ…å¯¼æ¼”æç¤ºè¯ |

#### 2.5.5 Batch æ¨¡å— (æ‰¹å¤„ç†)

| åŸè·¯å¾„ | æ–°è·¯å¾„ | è¯´æ˜ |
|--------|--------|------|
| `services/batch/BatchProcessor.ts` | `modules/batch/BatchProcessor.ts` | æ‰¹å¤„ç†å™¨ |
| `services/batch/index.ts` | `modules/batch/index.ts` | |

#### 2.5.6 Workflow æ¨¡å— (ç¼–æ’å±‚ - æ–°å»º)

| æ–°è·¯å¾„ | è¯´æ˜ |
|--------|------|
| `modules/workflow/Pipeline.ts` | æ€»ç»“ Pipeline (åŸ services/pipeline/Pipeline.ts) |
| `modules/workflow/RecallWorkflow.ts` | å¬å›å·¥ä½œæµ (æ–°å»º) |
| `modules/workflow/BatchWorkflow.ts` | æ‰¹å¤„ç†å·¥ä½œæµ (æ–°å»º) |

### 2.6 State Layer (çŠ¶æ€ç®¡ç†)

| åŸè·¯å¾„ | æ–°è·¯å¾„ | è¯´æ˜ |
|--------|--------|------|
| `stores/memoryStore.ts` | `state/memoryStore.ts` | è®°å¿†çŠ¶æ€ |
| `stores/themeStore.ts` | `state/themeStore.ts` | ä¸»é¢˜çŠ¶æ€ |
| `stores/devLogStore.ts` | `state/devLogStore.ts` | æ—¥å¿—çŠ¶æ€ |
| `stores/commandStore.ts` | `state/commandStore.ts` | å‘½ä»¤çŠ¶æ€ |
| `stores/index.ts` | `state/index.ts` | |

### 3.7 UI Layer (ç•Œé¢)

#### 3.7.1 UI Services (ä»…æ“ä½œ DOM)

| åŸè·¯å¾„ | æ–°è·¯å¾„ | è¯´æ˜ |
|--------|--------|------|
| `services/ThemeManager.ts` | `ui/services/ThemeManager.ts` | CSS å˜é‡æ“ä½œ |
| `services/NotificationService.ts` | `ui/services/NotificationService.ts` | Toastr å°è£… |

#### 2.7.2 Hooks

| åŸè·¯å¾„ | æ–°è·¯å¾„ |
|--------|--------|
| `hooks/useAPIPresets.ts` | `ui/hooks/useApiPresets.ts` |
| `hooks/useDashboardData.ts` | `ui/hooks/useDashboardData.ts` |
| `hooks/useDevLog.ts` | `ui/hooks/useDevLog.ts` |
| `hooks/index.ts` | `ui/hooks/index.ts` |
| (æ–°å»º) | `ui/hooks/useWorkflow.ts` |
| (æ–°å»º) | `ui/hooks/useRag.ts` |
| (æ–°å»º) | `ui/hooks/useSettings.ts` |

#### 2.7.3 Views (é‡å‘½åä¸º kebab-case)

| åŸè·¯å¾„ | æ–°è·¯å¾„ |
|--------|--------|
| `views/APIPresets/` | `ui/views/api-presets/` |
| `views/Dashboard/` | `ui/views/dashboard/` |
| `views/MemoryStream/` | `ui/views/memory-stream/` |
| `views/Processing/` | `ui/views/processing/` |
| `views/DevLog/` | `ui/views/dev-log/` |
| `views/Settings/` | `ui/views/settings/` |
| `views/QuickPanel/` | `ui/views/quick-panel/` |

#### 2.7.4 Components

| åŸè·¯å¾„ | æ–°è·¯å¾„ |
|--------|--------|
| `components/` | `ui/components/` |

### 2.8 Types Layer (ç±»å‹å£°æ˜)

| åŸè·¯å¾„ | æ–°è·¯å¾„ |
|--------|--------|
| `types/global.d.ts` | `@types/global.d.ts` |
| `types/st-types/` | `@types/st-types/` |

### 2.9 Other

| åŸè·¯å¾„ | æ–°è·¯å¾„ |
|--------|--------|
| `App.tsx` | `App.tsx` (ä¿æŒ) |
| `index.tsx` | `index.tsx` (ä¿æŒ) |
| `constants/` | `constants/` (ä¿æŒ) |
| `styles/` | `ui/styles/` |
| `assets/` | `ui/assets/` |

---

## ä¸‰ã€è¿ç§»é¡ºåº

1. **Phase 1**: æ‹†åˆ† `api/types.ts` â†’ `config/types/`
2. **Phase 2**: åˆ›å»ºç›®å½•ç»“æ„
3. **Phase 3**: ç§»åŠ¨ Core Layer
4. **Phase 4**: ç§»åŠ¨ Data Layer
5. **Phase 5**: ç§»åŠ¨ Integration Layer
6. **Phase 6**: ç§»åŠ¨ Config Layer
7. **Phase 7**: ç§»åŠ¨ Module Layer
8. **Phase 8**: ç§»åŠ¨ State Layer
9. **Phase 9**: ç§»åŠ¨ UI Layer
10. **Phase 10**: æ¸…ç†ç©ºç›®å½• + éªŒè¯

---

## å››ã€éªŒæ”¶æ ‡å‡†

- [ ] æ‰€æœ‰ Module ä¸ import `ui/` æˆ– `state/`
- [ ] æ‰€æœ‰ Prompt åœ¨ `modules/*/prompts/` ä¸‹
- [ ] `workflow/` è´Ÿè´£è·¨æ¨¡å—ç¼–æ’
- [ ] `integrations/tavern/` æŒ‰èŒè´£ç»†åˆ†
- [ ] æ— å¾ªç¯ä¾èµ–
- [ ] `npm run build` é€šè¿‡

---

## äº”ã€æ·±åº¦ä»£ç å®¡æŸ¥å‘ç° (å·²åˆå¹¶è‡³ V5 æ¸…å•)
 
> âœ… ä»¥ä¸‹å‘ç°å‡å·²æ•´åˆè¿› "ä¸‰ã€å®Œæ•´æ–‡ä»¶è¿ç§»æ¸…å• (V5 ä¿®è®¢)"ï¼Œæœ¬ç« èŠ‚ä»…ä½œå½’æ¡£è®°å½•ã€‚

### 5.1 é”™è¯¯å½’å±ä¿®æ­£

| æ–‡ä»¶ | åŸè®¡åˆ’å½’å± | ä¿®æ­£å½’å± | ç†ç”± |
|------|-----------|---------|------|
| `CharacterDeleteService.ts` | `ui/services/` | `data/cleanup/CharacterCleanup.ts` | ç›‘å¬äº‹ä»¶+åˆ é™¤ IndexedDB+åˆ é™¤ä¸–ç•Œä¹¦ï¼Œæ˜¯**æ•°æ®æ“ä½œ** |
| `RevisionService.ts` | `ui/services/` | `core/events/RevisionBridge.ts` | åªå‘é€äº‹ä»¶é€šçŸ¥ UIï¼Œä¸æ“ä½œ DOMï¼Œæ˜¯**äº‹ä»¶æ¡¥æ¥** |
| `SyncService.ts` | `core/sync/` | `data/sync/SyncService.ts` | æ“ä½œ IndexedDB å’Œ Vector Storeï¼Œæ˜¯**æ•°æ®åŒæ­¥** |
| `WorldBookSlotService.ts` | `integrations/worldbook/` | `integrations/tavern/WorldBookSlot.ts` | è°ƒç”¨ WorldInfoService åˆå§‹åŒ–æ§½ä½ï¼Œå±äº**tavern é›†æˆ** |

### 5.2 memoryStore æ··åˆèŒè´£é—®é¢˜ âš ï¸ 

**å‘ç°**ï¼š`stores/memoryStore.ts` ç›´æ¥æ“ä½œæ•°æ®åº“ï¼š
```typescript
// âŒ Store ä¸åº”è¯¥ç›´æ¥å†™ DB
async saveEvent(eventData) {
    const db = getCurrentDb();
    await db.events.add(eventNode);  // ç›´æ¥å†™ DB
}
```

**é—®é¢˜**ï¼šè¿å"Store åªåšå¿«ç…§"åŸåˆ™ï¼Œå¯¼è‡´åŒé‡æ•°æ®æº

**ä¿®æ­£æ–¹æ¡ˆ**ï¼š
1. æå– `data/repositories/EventRepository.ts`
2. memoryStore åªä¿ç•™çŠ¶æ€å­—æ®µï¼Œåˆ é™¤ DB æ“ä½œæ–¹æ³•
3. Workflow è°ƒç”¨ Repository æ›´æ–° DB åï¼Œé€šè¿‡äº‹ä»¶/è®¢é˜…æ›´æ–° Store

### 5.3 MacroService åå‘ä¾èµ–é—®é¢˜ âš ï¸

**å‘ç°**ï¼š`tavern/MacroService.ts` ä¾èµ– `stores/memoryStore.ts`
```typescript
import { useMemoryStore } from '@/stores/memoryStore';
```

**é—®é¢˜**ï¼šIntegration å±‚ä¾èµ– State å±‚ï¼Œè¿åå•å‘ä¾èµ–

**å½±å“**ï¼šå¦‚æœæƒ³æŠŠ MacroService ç”¨äºé React ç¯å¢ƒï¼Œä¼šå› ä¸ºä¾èµ– Zustand è€Œå¤±è´¥

**ä¿®æ­£æ–¹æ¡ˆ**ï¼š
1. MacroService ä¸ç›´æ¥ä¾èµ– memoryStore
2. æ”¹ä¸ºä¾èµ– `data/repositories/EventRepository` æˆ–é€šè¿‡äº‹ä»¶è·å–æ•°æ®

### 5.4 æ›´æ–°åçš„è¿ç§»æ¸…å•ä¿®æ­£

| åŸè·¯å¾„ | é”™è¯¯å½’å± | æ­£ç¡®å½’å± |
|--------|---------|---------|
| `services/CharacterDeleteService.ts` | `ui/services/CharacterService.ts` | `data/cleanup/CharacterCleanup.ts` |
| `services/RevisionService.ts` | `ui/services/RevisionService.ts` | `core/events/RevisionBridge.ts` |
| `services/SyncService.ts` | `core/sync/SyncService.ts` | `data/sync/SyncService.ts` |
| `services/WorldBookSlotService.ts` | `integrations/worldbook/WorldBookSync.ts` | `integrations/tavern/WorldBookSlot.ts` |

### 5.5 æ–°å¢éœ€è¦åˆ›å»ºçš„æ–‡ä»¶

| è·¯å¾„ | èŒè´£ |
|------|------|
| `data/repositories/EventRepository.ts` | äº‹ä»¶ CRUD (ä» memoryStore æå–) |
| `data/repositories/EntityRepository.ts` | å®ä½“ CRUD (ä» memoryStore æå–) |
| `core/events/EventBus.ts` | å†…éƒ¨äº‹ä»¶æ€»çº¿ |
| `core/events/RevisionBridge.ts` | ä¿®è®¢è¯·æ±‚æ¡¥æ¥ |

---

## å…­ã€æœ€ç»ˆè¿ç§»é¡ºåº (ä¿®è®¢ç‰ˆ)

1. **Phase 0**: å¤‡ä»½ + å®‰è£… ts-morph
2. **Phase 1**: æ‹†åˆ† `api/types.ts` â†’ `config/types/`
3. **Phase 2**: åˆ›å»ºç›®å½•ç»“æ„
4. **Phase 3**: ç§»åŠ¨ Core Layer (Logger, Utils, Events)
5. **Phase 4**: ç§»åŠ¨ Data Layer + æå– Repositories
6. **Phase 5**: ç§»åŠ¨ Integration Layer (tavern, llm)
7. **Phase 6**: ç§»åŠ¨ Config Layer
8. **Phase 7**: ç§»åŠ¨ Module Layer (memory, rag, workflow)
9. **Phase 8**: é‡æ„ State Layer (å»é™¤ DB æ“ä½œ)
10. **Phase 9**: ç§»åŠ¨ UI Layer
11. **Phase 10**: ä¿®å¤ä¾èµ–æ–¹å‘ (MacroService ç­‰)
12. **Phase 11**: æ¸…ç† + éªŒè¯
