# Engram V0.8.5 å¼€å‘æ–‡æ¡£ - RAG å¬å›ç³»ç»Ÿ

> **åˆ›å»ºæ—¥æœŸ**: 2026-01-11
> **ç‰ˆæœ¬**: V0.8.5
> **çŠ¶æ€**: ğŸ“ è®¾è®¡é˜¶æ®µ

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 æ ¸å¿ƒç›®æ ‡

æ„å»ºä¸€ä¸ª**å¤šæ¨¡å¼æ··åˆå¬å›ç³»ç»Ÿ**ï¼Œè§£å†³ RP åœºæ™¯ä¸‹"æ£€ç´¢é¸¿æ²Ÿ"é—®é¢˜ï¼š

| ç»´åº¦ | ç”¨æˆ·è¾“å…¥ | å‰§æƒ…æ•°æ®åº“ | é¸¿æ²Ÿ |
|------|----------|------------|------|
| é•¿åº¦ | æçŸ­åŠ¨ä½œæå†™ | é•¿æ–‡æœ¬å®Œæ•´å™äº‹ | æ–‡æœ¬å¯†åº¦ä¸åŒ¹é… |
| è¯­ä¹‰ | éšæ€§æ„å›¾ (å¦‚"æ‘¸æ‘¸è„–å­") | æ˜¾æ€§æè¿° | æ„å›¾æ— æ³•ç›´æ¥åŒ¹é… |
| è§†è§’ | ç¬¬ä¸€/äºŒäººç§° | ç¬¬ä¸‰äººç§°å…¨çŸ¥ | è¯­æ³•ç»“æ„ä¸åŒ¹é… |
| æ¨¡ç³Šæ€§ | é«˜åº¦ä¸Šä¸‹æ–‡ä¾èµ– | ç›¸å¯¹ç‹¬ç«‹ | ç¼ºä¹å‰ç½®æŒ‡ä»£ |

### 1.2 å¬å›æ¨¡å¼ç­‰çº§

æä¾›ä¸åŒå¤æ‚åº¦çš„å¬å›æ–¹æ¡ˆï¼Œç”¨æˆ·å¯æŒ‰éœ€é…ç½®ï¼š

| ç­‰çº§ | æ–¹æ¡ˆ | ç»„ä»¶ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| ğŸ’ **é¡¶é…** | é¢„å¤„ç† + Embedding + Rerank | LLM + å‘é‡æ¨¡å‹ + Rerank æ¨¡å‹ | é«˜è´¨é‡éœ€æ±‚ |
| âš¡ **æ ‡å‡†** | Embedding + Rerank | å‘é‡æ¨¡å‹ + Rerank æ¨¡å‹ | å¹³è¡¡æ€§èƒ½ |
| ğŸ”‹ **è½»é‡** | ä»… Embedding | å‘é‡æ¨¡å‹ | å¿«é€Ÿå¬å› |
| ğŸ§± **æš´åŠ›** | LLM ç›´æ¥å¬å› | ä»… LLM | æ— å‘é‡æ¨¡å‹ç”¨æˆ· |

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 å¬å› Pipeline

```
ç”¨æˆ·è¾“å…¥
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: Query é¢„å¤„ç† (å¯é€‰, V0.8 å·²å®ç°)                        â”‚
â”‚   â””â”€â”€ è¾“å…¥: userInput                                           â”‚
â”‚   â””â”€â”€ è¾“å‡º: unified_queries[] + å¢å¼ºåçš„è¾“å…¥                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 2: å‘é‡æ£€ç´¢ (Embedding + Cosine Similarity)                â”‚
â”‚   â”œâ”€â”€ queryEmbedding = embed(query)                             â”‚
â”‚   â”œâ”€â”€ candidates = topK(cosineSimilarity(queryEmbed, eventEmbed))â”‚
â”‚   â””â”€â”€ è¾“å‡º: topK å€™é€‰é›†                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 3: Rerank é‡æ’åº (å¯é€‰)                                    â”‚
â”‚   â”œâ”€â”€ rerankScores = rerank(query, candidates)                  â”‚
â”‚   â””â”€â”€ è¾“å‡º: reranked å€™é€‰é›†                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 4: æ··åˆæ‰“åˆ† + é»æ€§ç³»ç»Ÿ                                     â”‚
â”‚   â”œâ”€â”€ hybridScore = Î± * embeddingScore + (1-Î±) * rerankScore    â”‚
â”‚   â”œâ”€â”€ stickyDecay() - å·²å¬å›é¡¹æƒé‡è¡°å‡                           â”‚
â”‚   â””â”€â”€ è¾“å‡º: æœ€ç»ˆå¬å› IDs                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
MacroService.refreshCache(recalledIds)
    â†“
{{engramSummaries}} åŒ…å«å¬å›çš„è®°å¿†
```

### 2.2 æš´åŠ› LLM å¬å› (æ— å‘é‡æ¨¡å‹å…œåº•)

```
ç”¨æˆ·è¾“å…¥
    â†“
æ”¶é›†æ‰€æœ‰å½’æ¡£ summary (is_archived=true)
    â†“
æ„å»º prompt: "ä»ä»¥ä¸‹è®°å¿†ä¸­é€‰æ‹©æœ€ç›¸å…³çš„..."
    â†“
LLM è¿”å›: [selected_ids]
    â†“
MacroService.refreshCache(selected_ids)
```

---

## 3. æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 3.1 ç°æœ‰ä»£ç ç›˜ç‚¹

| ç»„ä»¶ | æ–‡ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| `EmbeddingService` | `services/rag/EmbeddingService.ts` | âœ… å·²å®ç° | å¤šæºå‘é‡åŒ– (557 è¡Œ) |
| `Retriever` | `services/rag/Retriever.ts` | ğŸ”¨ å¾…å®Œå–„ | å‘é‡æ£€ç´¢æ ¸å¿ƒ (88 è¡Œ) |
| `Injector` | `services/rag/Injector.ts` | âœ… å·²å®ç° | äº‹ä»¶æ³¨å…¥ |
| `RerankConfig` | `services/api/types.ts` | âœ… ç±»å‹å®šä¹‰ | é…ç½®ç»“æ„ |
| `RerankConfigForm` | `views/APIPresets/components/` | âœ… UI å·²æœ‰ | é…ç½®ç•Œé¢ |

### 3.2 éœ€è¦æ–°å¢/æ‰©å±•çš„ç»„ä»¶

```
src/services/rag/
â”œâ”€â”€ EmbeddingService.ts   # [ç°æœ‰] å‘é‡åŒ–
â”œâ”€â”€ Retriever.ts          # [æ‰©å±•] æ ¸å¿ƒå¬å›é€»è¾‘
â”œâ”€â”€ RerankService.ts      # [æ–°å¢] Rerank API è°ƒç”¨
â”œâ”€â”€ HybridScorer.ts       # [æ–°å¢] æ··åˆæ‰“åˆ†ç®—æ³•
â”œâ”€â”€ StickyCache.ts        # [æ–°å¢] é»æ€§ç³»ç»Ÿç¼“å­˜
â”œâ”€â”€ LLMRecaller.ts        # [æ–°å¢] æš´åŠ› LLM å¬å›
â””â”€â”€ Injector.ts           # [ç°æœ‰] äº‹ä»¶æ³¨å…¥
```

---

## 4. æ•°æ®ç»“æ„

### 4.1 å¬å›é…ç½® (æ‰©å±• RerankConfig)

```typescript
interface RecallConfig {
    // å¬å›æ¨¡å¼
    mode: 'full' | 'standard' | 'light' | 'llm_only';
    
    // Embedding è®¾ç½®
    embedding: {
        enabled: boolean;
        topK: number;               // åˆç­›æ•°é‡ (é»˜è®¤ 20)
        minScoreThreshold: number;  // æœ€ä½ç›¸ä¼¼åº¦ (é»˜è®¤ 0.3)
    };
    
    // Rerank è®¾ç½® (ç°æœ‰ RerankConfig æ‰©å±•)
    rerank: {
        enabled: boolean;
        url: string;
        apiKey: string;
        model: string;
        topN: number;              // Rerank åä¿ç•™æ•°é‡
        minScore: number;          // Rerank æœ€ä½åˆ†æ•°
    };
    
    // æ··åˆæ‰“åˆ†
    hybrid: {
        alpha: number;             // Embedding æƒé‡ (0-1)
        // alpha = 1: ä»… Embedding
        // alpha = 0: ä»… Rerank
        // alpha = 0.5: å¹³å‡
    };
    
    // é»æ€§ç³»ç»Ÿ
    sticky: {
        enabled: boolean;
        decayFactor: number;       // è¡°å‡ç³»æ•° (æ¯æ¡æ¶ˆæ¯)
        maxStickRounds: number;    // æœ€å¤§åœç•™è½®æ•°
    };
    
    // LLM æš´åŠ›å¬å›
    llmRecall: {
        enabled: boolean;          // ä½œä¸ºå…œåº•æˆ–ç‹¬ç«‹æ¨¡å¼
        maxSummaries: number;      // æœ€å¤šç»™ LLM çœ‹å¤šå°‘æ¡
    };
}
```

### 4.2 å¬å›ç»“æœ

```typescript
interface RecallResult {
    // åŸå§‹å€™é€‰é›†
    embeddingCandidates: ScoredEvent[];
    rerankCandidates: ScoredEvent[];
    
    // æœ€ç»ˆç»“æœ
    finalIds: string[];
    
    // è°ƒè¯•ä¿¡æ¯
    stats: {
        queryCount: number;        // Query æ•°é‡
        embeddingTime: number;     // Embedding è€—æ—¶
        rerankTime: number;        // Rerank è€—æ—¶
        totalCandidates: number;   // å€™é€‰æ•°é‡
        finalCount: number;        // æœ€ç»ˆå¬å›æ•°é‡
    };
}

interface ScoredEvent {
    id: string;
    summary: string;
    embeddingScore?: number;
    rerankScore?: number;
    hybridScore?: number;
    stickyPenalty?: number;        // é»æ€§æƒ©ç½š
    isSticky?: boolean;            // æ˜¯å¦å¤„äºé»æ€§æœŸ
}
```

---

## 5. æ··åˆæ‰“åˆ†ç®—æ³•

### 5.1 åŸºç¡€æ··åˆ

```typescript
function calculateHybridScore(
    embeddingScore: number | null,
    rerankScore: number | null,
    alpha: number
): number {
    // å¦‚æœåªæœ‰ä¸€ä¸ªåˆ†æ•°ï¼Œç›´æ¥è¿”å›
    if (embeddingScore == null) return rerankScore ?? 0;
    if (rerankScore == null) return embeddingScore;
    
    // åŠ æƒå¹³å‡
    return alpha * embeddingScore + (1 - alpha) * rerankScore;
}
```

### 5.2 é»æ€§ç³»ç»Ÿ

**è®¾è®¡ç†å¿µ**ï¼šè¿ç»­å‡ è½®å‰§æƒ…å¤§å¤šæ˜¯è¿è´¯çš„ï¼Œå¬å›ç»“æœåº”æœ‰ä¸€å®š"æƒ¯æ€§"ã€‚

```typescript
class StickyCache {
    // ç¼“å­˜: eventId -> { lastRecallRound, stickyCount }
    private cache: Map<string, { round: number; count: number }> = new Map();
    private currentRound: number = 0;
    
    /**
     * æ–°ä¸€è½®å¬å›
     */
    nextRound() {
        this.currentRound++;
    }
    
    /**
     * æ ‡è®°æŸäº‹ä»¶è¢«å¬å›
     */
    markRecalled(eventId: string) {
        const existing = this.cache.get(eventId);
        if (existing && existing.round === this.currentRound - 1) {
            // è¿ç»­å¬å›ï¼Œå¢åŠ é»æ€§è®¡æ•°
            this.cache.set(eventId, {
                round: this.currentRound,
                count: existing.count + 1
            });
        } else {
            this.cache.set(eventId, { round: this.currentRound, count: 1 });
        }
    }
    
    /**
     * è·å–é»æ€§æƒ©ç½š
     * å·²å¬å›å¤šæ¬¡çš„é¡¹åº”è¯¥é™ä½æƒé‡ï¼Œè®©æ–°å†…å®¹æœ‰æœºä¼šå‡ºç°
     */
    getStickyPenalty(eventId: string, config: StickyConfig): number {
        const entry = this.cache.get(eventId);
        if (!entry) return 0;
        
        // è®¡ç®—è·ç¦»ä¸Šæ¬¡å¬å›çš„è½®æ•°
        const roundGap = this.currentRound - entry.round;
        
        // å¦‚æœè¶…å‡ºæœ€å¤§é»æ€§è½®æ•°ï¼Œæ— æƒ©ç½š
        if (roundGap > config.maxStickRounds) return 0;
        
        // è¿ç»­å¬å›æ¬¡æ•°è¶Šå¤šï¼Œæƒ©ç½šè¶Šå¤§
        const penalty = Math.min(1, entry.count * config.decayFactor);
        return penalty;
    }
    
    /**
     * æ¸…ç†è¿‡æœŸç¼“å­˜
     */
    cleanup(maxAge: number = 10) {
        for (const [id, entry] of this.cache) {
            if (this.currentRound - entry.round > maxAge) {
                this.cache.delete(id);
            }
        }
    }
}
```

### 5.3 æœ€ç»ˆæ’åº

```typescript
function finalSort(
    candidates: ScoredEvent[],
    stickyCache: StickyCache,
    config: RecallConfig
): ScoredEvent[] {
    return candidates
        .map(event => {
            const stickyPenalty = config.sticky.enabled
                ? stickyCache.getStickyPenalty(event.id, config.sticky)
                : 0;
            
            // åº”ç”¨é»æ€§æƒ©ç½š (é™ä½å·²å¬å›å¤šæ¬¡çš„é¡¹)
            const adjustedScore = event.hybridScore! * (1 - stickyPenalty);
            
            return {
                ...event,
                stickyPenalty,
                adjustedScore,
                isSticky: stickyPenalty > 0
            };
        })
        .sort((a, b) => b.adjustedScore - a.adjustedScore);
}
```

---

## 6. å¤š Query æ£€ç´¢

### 6.1 ç»Ÿä¸€æŒ‡ä»¤åŒ– Query æ ¼å¼

ä»é¢„å¤„ç†é˜¶æ®µè·å–å¤šä¸ª unified_queries:

```typescript
{
    "unified_queries": [
        "æŸ¥æ‰¾åŠ¨ä½œç»†èŠ‚: è‰¾è‰ä¸æ›¾ç»å’¬ç ´ç©å®¶è„–å­å¸è¡€çš„åœºæ™¯æå†™",
        "æ£€ç´¢è®¾å®šèƒŒæ™¯: è‰¾è‰ä¸å¯¹è¡€æ¶²çš„æ¸´æœ›ä»¥åŠç•™ä¸‹çš„æ ‡è®°å«ä¹‰",
        "å›é¡¾æƒ…æ„Ÿäº’åŠ¨: è‰¾è‰ä¸è¡¨ç°ç—…å¨‡å æœ‰æ¬²çš„å¯¹è¯",
        "Query: è‰¾è‰ä¸ å’¬ç—• è„–å­ å¥‘çº¦"
    ]
}
```

### 6.2 Multi-Query ç­–ç•¥

```typescript
async function multiQuerySearch(
    queries: string[],
    embeddingService: EmbeddingService,
    db: EngramDB,
    config: RecallConfig
): Promise<ScoredEvent[]> {
    const allCandidates: Map<string, ScoredEvent> = new Map();
    
    for (const query of queries) {
        // åµŒå…¥ Query
        const queryVector = await embeddingService.embed(query);
        
        // ä» DB è·å–å·²åµŒå…¥çš„äº‹ä»¶
        const events = await db.events
            .filter(e => e.is_embedded && e.embedding)
            .toArray();
        
        // è®¡ç®—ç›¸ä¼¼åº¦
        for (const event of events) {
            const score = embeddingService.cosineSimilarity(
                queryVector,
                event.embedding!
            );
            
            if (score >= config.embedding.minScoreThreshold) {
                const existing = allCandidates.get(event.id);
                if (!existing || score > existing.embeddingScore!) {
                    allCandidates.set(event.id, {
                        id: event.id,
                        summary: event.summary,
                        embeddingScore: score
                    });
                }
            }
        }
    }
    
    // è¿”å› Top-K
    return Array.from(allCandidates.values())
        .sort((a, b) => b.embeddingScore! - a.embeddingScore!)
        .slice(0, config.embedding.topK);
}
```

---

## 7. Rerank æœåŠ¡

### 7.1 RerankService

```typescript
// services/rag/RerankService.ts
export class RerankService {
    private config: RerankConfig | null = null;
    
    setConfig(config: RerankConfig) {
        this.config = config;
    }
    
    /**
     * è°ƒç”¨ Rerank API
     */
    async rerank(
        query: string,
        documents: string[]
    ): Promise<{ index: number; relevance_score: number }[]> {
        if (!this.config?.enabled) {
            // æœªå¯ç”¨ï¼Œè¿”å›åŸå§‹é¡ºåº
            return documents.map((_, i) => ({ index: i, relevance_score: 0 }));
        }
        
        const endpoint = this.config.url.endsWith('/rerank')
            ? this.config.url
            : `${this.config.url.replace(/\/$/, '')}/rerank`;
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...(this.config.apiKey && {
                    'Authorization': `Bearer ${this.config.apiKey}`
                })
            },
            body: JSON.stringify({
                model: this.config.model,
                query,
                documents,
                top_n: this.config.topN
            })
        });
        
        if (!response.ok) {
            const error = await response.text();
            throw new Error(`Rerank API error: ${error}`);
        }
        
        const data = await response.json();
        return data.results || data.data || [];
    }
}

export const rerankService = new RerankService();
```

---

## 8. æš´åŠ› LLM å¬å›

### 8.1 è®¾è®¡æ€è·¯

ä¸ºæ²¡æœ‰å‘é‡æ¨¡å‹çš„ç”¨æˆ·æä¾›å…œåº•æ–¹æ¡ˆï¼š

1. æ”¶é›†æ‰€æœ‰å·²å½’æ¡£çš„ summary
2. æ„å»º prompt è¯· LLM é€‰æ‹©ç›¸å…³è®°å¿†
3. è§£æ LLM è¿”å›çš„ ID åˆ—è¡¨

### 8.2 LLMRecaller

```typescript
// services/rag/LLMRecaller.ts
export class LLMRecaller {
    /**
     * ä½¿ç”¨ LLM ç›´æ¥é€‰æ‹©ç›¸å…³è®°å¿†
     */
    async recall(
        userInput: string,
        events: EventNode[],
        maxToShow: number = 50
    ): Promise<string[]> {
        // é™åˆ¶æ•°é‡
        const candidates = events.slice(0, maxToShow);
        
        // æ„å»ºç´¢å¼•
        const indexed = candidates.map((e, i) => ({
            idx: i,
            id: e.id,
            summary: e.summary.substring(0, 200) // æˆªæ–­
        }));
        
        const prompt = `ä½ æ˜¯ä¸€ä¸ªè®°å¿†æ£€ç´¢åŠ©æ‰‹ã€‚ç”¨æˆ·å½“å‰è¾“å…¥å¦‚ä¸‹ï¼š
"${userInput}"

ä»¥ä¸‹æ˜¯è§’è‰²æ‰®æ¼”çš„å†å²è®°å¿†ç‰‡æ®µï¼Œæ¯æ¡æœ‰ä¸€ä¸ªç¼–å·ï¼š
${indexed.map(e => `[${e.idx}] ${e.summary}`).join('\n')}

è¯·é€‰æ‹©ä¸ç”¨æˆ·å½“å‰è¾“å…¥æœ€ç›¸å…³çš„è®°å¿†ï¼ˆæœ€å¤š5æ¡ï¼‰ï¼Œè¿”å›å®ƒä»¬çš„ç¼–å·åˆ—è¡¨ã€‚
åªè¿”å› JSON æ•°ç»„æ ¼å¼ï¼Œä¾‹å¦‚: [0, 3, 7]`;

        const response = await llmAdapter.generate({
            systemPrompt: 'ä½ æ˜¯è®°å¿†æ£€ç´¢åŠ©æ‰‹ï¼Œåªè¿”å› JSON æ•°ç»„ã€‚',
            userPrompt: prompt
        });
        
        // è§£æè¿”å›
        try {
            const indices = JSON.parse(response);
            if (Array.isArray(indices)) {
                return indices
                    .filter(i => typeof i === 'number' && i >= 0 && i < indexed.length)
                    .map(i => indexed[i].id);
            }
        } catch {
            // è§£æå¤±è´¥
        }
        
        return [];
    }
}

export const llmRecaller = new LLMRecaller();
```

---

## 9. æ‰©å±• Retriever

### 9.1 å®Œæ•´å®ç°

```typescript
// services/rag/Retriever.ts
export class Retriever {
    private stickyCache = new StickyCache();
    
    /**
     * ä¸»å…¥å£ï¼šæ ¹æ®é…ç½®æ‰§è¡Œå¬å›
     */
    async search(
        userInput: string,
        unifiedQueries?: string[],
        config?: RecallConfig
    ): Promise<RecallResult> {
        const startTime = Date.now();
        const result: RecallResult = {
            embeddingCandidates: [],
            rerankCandidates: [],
            finalIds: [],
            stats: { queryCount: 0, embeddingTime: 0, rerankTime: 0, totalCandidates: 0, finalCount: 0 }
        };
        
        // è·å–é…ç½®
        config = config || this.getDefaultConfig();
        
        // æ–°ä¸€è½®å¬å›
        this.stickyCache.nextRound();
        
        // æ¨¡å¼åˆ†å‘
        switch (config.mode) {
            case 'llm_only':
                return this.llmOnlyRecall(userInput);
            
            case 'light':
                return this.embeddingOnlyRecall(userInput, unifiedQueries, config);
            
            case 'standard':
            case 'full':
            default:
                return this.fullRecall(userInput, unifiedQueries, config);
        }
    }
    
    /**
     * å®Œæ•´å¬å›ï¼šEmbedding + Rerank + æ··åˆæ‰“åˆ†
     */
    private async fullRecall(
        userInput: string,
        queries: string[] | undefined,
        config: RecallConfig
    ): Promise<RecallResult> {
        // ... å®ç°
    }
    
    // ... å…¶ä»–æ–¹æ³•
}
```

---

## 10. ä¸å›¾æ£€ç´¢çš„å…¼å®¹é¢„ç•™

### 10.1 æœªæ¥æ‰©å±•æ¥å£

```typescript
interface GraphRecallResult {
    relatedEntityIds: string[];
    connectionScore: number;
}

interface RecallConfig {
    // ... ç°æœ‰é…ç½®
    
    // å›¾æ£€ç´¢ (æœªæ¥)
    graph?: {
        enabled: boolean;
        maxHops: number;           // æœ€å¤§è·³æ•°
        entityWeight: number;      // å®ä½“å…³ç³»æƒé‡
    };
}

// æ··åˆæ‰“åˆ†æ‰©å±•
function calculateHybridScore(
    embeddingScore: number | null,
    rerankScore: number | null,
    graphScore: number | null,  // æœªæ¥ï¼šå›¾å…³ç³»åˆ†æ•°
    config: HybridConfig
): number {
    // ä¸‰è·¯åŠ æƒ
}
```

---

## 11. å®ç°è®¡åˆ’

### Phase 1: æ ¸å¿ƒå¬å› (é«˜ä¼˜å…ˆçº§)
- [ ] æ‰©å±• `Retriever.ts` å®ç°å‘é‡æ£€ç´¢
- [ ] æ–°å¢ `RerankService.ts`
- [ ] æ–°å¢ `HybridScorer.ts`
- [ ] é›†æˆé¢„å¤„ç†çš„ `<query>` è¾“å‡º

### Phase 2: é«˜çº§ç‰¹æ€§
- [ ] æ–°å¢ `StickyCache.ts` å®ç°é»æ€§ç³»ç»Ÿ
- [ ] æ–°å¢ `LLMRecaller.ts` æš´åŠ›å¬å›
- [ ] æ‰©å±• `RecallConfig` é…ç½®ç±»å‹

### Phase 3: UI é›†æˆ
- [ ] æ‰©å±• `RerankConfigForm` ä¸ºå®Œæ•´å¬å›é…ç½®
- [ ] æ·»åŠ å¬å›æ¨¡å¼é€‰æ‹©å™¨
- [ ] è°ƒè¯•é¢æ¿ï¼šæ˜¾ç¤ºå¬å›åˆ†æ•°å’Œå€™é€‰

### Phase 4: æµ‹è¯•ä¸ä¼˜åŒ–
- [ ] åˆ©ç”¨ `ragtest_v5_standalone.html` éªŒè¯ç®—æ³•
- [ ] æ€§èƒ½æµ‹è¯•ï¼šå¤§é‡äº‹ä»¶ä¸‹çš„å¬å›æ•ˆç‡
- [ ] å‚æ•°è°ƒä¼˜æŒ‡å—

---

## 12. é…ç½® UI è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š RAG å¬å›é…ç½®                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ å¬å›æ¨¡å¼:                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ â”‚ ğŸ’ é¡¶é… â”‚ â”‚ âš¡ æ ‡å‡† â”‚ â”‚ ğŸ”‹ è½»é‡ â”‚ â”‚ ğŸ§± æš´åŠ› â”‚                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                 â”‚
â”‚ ğŸ“Š Embedding è®¾ç½®                                                â”‚
â”‚ â”œâ”€â”€ Top-K åˆç­›:     [  20  ]                                    â”‚
â”‚ â””â”€â”€ æœ€ä½é˜ˆå€¼:       [ 0.30 ]                                    â”‚
â”‚                                                                 â”‚
â”‚ ğŸ”„ Rerank è®¾ç½®                                 [å¯ç”¨ âœ“]          â”‚
â”‚ â”œâ”€â”€ API ç«¯ç‚¹:       [________________]                          â”‚
â”‚ â”œâ”€â”€ æ¨¡å‹:           [________________]                          â”‚
â”‚ â”œâ”€â”€ Top-N:          [  5   ]                                    â”‚
â”‚ â””â”€â”€ æœ€ä½åˆ†æ•°:       [ 0.10 ]                                    â”‚
â”‚                                                                 â”‚
â”‚ âš–ï¸ æ··åˆæ‰“åˆ†                                                      â”‚
â”‚ â””â”€â”€ Î± (Embedding/Rerank): [====â—====] 0.5                       â”‚
â”‚                                                                 â”‚
â”‚ ğŸ§² é»æ€§ç³»ç»Ÿ                                    [å¯ç”¨ â—‹]          â”‚
â”‚ â”œâ”€â”€ è¡°å‡ç³»æ•°:       [ 0.15 ]                                    â”‚
â”‚ â””â”€â”€ æœ€å¤§åœç•™è½®æ•°:   [  3   ]                                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 13. å‚è€ƒèµ„æ–™

- [EmbeddingService å®ç°](src/services/rag/EmbeddingService.ts)
- [RAG æµ‹è¯•å·¥å…·](test/ragtest_v5_standalone.html)
- [V0.8 é¢„å¤„ç†ç³»ç»Ÿ](docs/é¢„å¤„ç†ç³»ç»Ÿ.md)
- [RAG Embedding Pipeline è®¾è®¡æ–¹æ¡ˆ](docs/RAG_Embedding_Pipelineè®¾è®¡æ–¹æ¡ˆ.md)
