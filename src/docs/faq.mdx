import { HelpCircle, AlertTriangle, Bug, Cpu, Database, FileText, Search } from 'lucide-react';

# 常见问题与故障排查 (FAQ)

---

遇到问题时，请先深呼吸。Engram 内置了强大的**三大日志系统**来帮助你定位问题。绝大多数问题都可以通过检查这些日志找到原因。

## 🔍 第一步：自我诊断流程

在报告 Bug 之前，请先根据问题的类型，检查对应的日志面板（位于 Engram 侧边栏的 **开发日志** 标签页）。

### 1. 插件无法运行 / 界面无反应
> **症状**: 点击按钮没反应、界面白屏、数据不加载。

* **检查目标**: <Bug className="inline w-4 h-4 mb-1"/> **运行日志**
* **如何自查**:
    * 查看是否有红色的 `ERROR` 条目。
    * 这些错误通常是因为 IndexedDB 连接失败、SillyTavern 版本不兼容或网络环境导致的核心崩溃。
    * **应对**: 尝试刷新页面；如果是数据库错误，可能需要重置数据。

### 2. 自动总结没触发 / 总结内容奇怪
> **症状**: 聊了很久没有新记忆生成，或者生成的记忆全是乱码/重复内容。

* **检查目标**: <Cpu className="inline w-4 h-4 mb-1"/> **模型日志**
* **如何自查**:
    * **触发检查**: 如果这里一片空白，说明根本没有触发总结任务。请检查 **数据处理** → **记忆摘要** 中的楼层阈值设置。
    * **Prompt 检查**: 点击日志条目查看发送给 LLM 的 Prompt。
    * **Response 检查**: 查看 LLM 返回的内容。如果返回了 `404` 或 `Connection Refused`，说明 API 配置错误；如果返回了非 JSON 格式的胡言乱语，说明模型不够聪明，建议更换模型或调整 **提示词模板**。

### 3. 聊过的事情没记起来 (RAG 失效)
> **症状**: 我明明前两句刚提过这事，AI 还是不知道，或者召回了无关的内容。

* **检查目标**: <Database className="inline w-4 h-4 mb-1"/> **召回日志**
* **如何自查**:
    * **Query 检查**: 看系统把你的话转换成了什么搜索关键词。
    * **Score 检查**: 查看召回条目的相似度得分。如果得分很低（< 0.3），说明检索相关性不足。
    * **结果检查**: 如果日志里显示召回了正确的内容，但 AI 还是没反应，那可能是 LLM 的上下文窗口太小，或者 LLM 选择性忽略了注入的信息。

---

## 🛠️ 常见问题解决方案

### <AlertTriangle className="inline w-5 h-5 mb-1 text-yellow-500"/> 运行错误类

#### Q: 插件显示"连接失败"或 API 报错 (404/Connection Refused)？
* **原因**: Engram 无法连接到你配置的 LLM 后端。
* **解决**:
    1.  检查 **API Base URL** 是否填写正确（通常需要包含 `/v1`，例如 `http://127.0.0.1:11434/v1`）。
    2.  **CORS 问题**: 如果你在浏览器控制台（按 F12）看到 CORS 错误，请确保你的 API 服务端（如 Ollama, LM Studio）允许跨域请求（设置 `OLLAMA_ORIGINS="*"`）。
    3.  **API Key**: 某些服务商必须填写 Key 才能访问，即使是本地服务也可以随便填一个字符串（如 `sk-test`）以此骗过校验。

#### Q: 修改了记忆文本，但搜索不到？
* **原因**: 向量索引是基于修改前的文本生成的，修改文本后索引失效。
* **解决**: 在 **记忆编辑** 页面，找到修改过的条目，点击卡片上的 **<Search className="inline w-3 h-3"/> Re-embed** 按钮，重新生成向量数据。

### <FileText className="inline w-5 h-5 mb-1 text-blue-500"/> 功能逻辑类

#### Q: 自动总结没有触发？
* **原因**: 为了防止 LLM 刷屏，Engram 设有保护机制。
* **解决**:
    1.  **楼层间隔**: 检查新消息数量是否达到设定的阈值（默认 5-10 条，在 **仪表盘** 可调）。
    2.  **串行保护**: 检查右上角是否有加载动画？如果上一轮总结任务还在转圈（卡死），新任务不会开始。请尝试刷新页面重置任务队列。
    3.  **Token 限制**: 如果历史记录过长且未开启上下文截断，可能导致 Prompt 构建失败。

#### Q: 开启 RAG 后回复变慢？
* **原因**: 每次你发送消息时，Engram 都要先进行 Embedding（向量化）和 Rerank（重排序），这增加了网络请求环节。
* **解决**:
    * 使用本地 **Transformers.js** 嵌入模型（在 **API 预设** → **向量化** 中选择 `Transformers (本地)`），这会利用浏览器 WebGPU 加速，消除网络延迟。
    * 关闭 Rerank 步骤（虽然会降低精度，但能显著提升速度）。

#### Q: 数据备份和多端同步？
* **现状**: 目前 Engram 的数据完全存储在浏览器的 **IndexedDB** 中。
* **计划**: 我们正在开发基于本地文件备份和同步的同步功能。目前如果需要备份，可以在浏览器开发者工具中手动导出 IndexedDB 数据。

---

## 📝 如何汇报 Bug

如果以上方法都无法解决，请到 Github Issues 提交反馈。为了让我们能快速定位问题，**请务必使用以下格式**：

\`\`\`text
**问题描述**: (简要描述发生了什么)
**SillyTavern 版本**: (例如 1.12.0)
**Engram 版本**: (例如 0.9.6)
**浏览器**: (Chrome / Edge / Firefox)

**日志截图 (关键)**:
1. 请打开 Engram 侧边栏的 **开发日志**。
2. 截图相关的错误条目（红色 Error）。
3. 如果是总结问题，请截图 **模型日志** 中对应的 Request/Response。
\`\`\`
```
*/
