import { HelpCircle, AlertTriangle, Bug, Cpu, Database, FileText, Search, ShieldAlert, Clock } from 'lucide-react';

# 常见问题与故障排查 (FAQ)

---

遇到问题时，请先深呼吸。Engram 内置了强大的**三大日志系统**来帮助你定位问题。绝大多数问题都可以通过检查这些日志找到原因。

## 🔍 第一步：自我诊断流程

在报告 Bug 之前，请先根据问题的类型，检查对应的日志面板（位于 Engram 侧边栏的 **开发日志** 标签页）。

### 1. 插件无法运行 / 界面无反应
> **症状**: 点击按钮没反应、界面白屏、数据不加载。

* **检查目标**: <Bug className="inline w-4 h-4 mb-1"/> **运行日志**
* **如何自查**:
    * 查看是否有红色的 `ERROR` 条目。
    * 这些错误通常是因为 IndexedDB 连接失败、SillyTavern 版本不兼容或网络环境导致的核心崩溃。
    * **应对**: 尝试刷新页面；如果是数据库错误，可能需要重置数据。

### 2. 自动总结没触发 / 总结内容奇怪 / 总结没有被保存
> **症状**: 聊了很久没有新记忆生成，或者生成的记忆全是乱码/重复内容。

* **检查目标**: <Cpu className="inline w-4 h-4 mb-1"/> **模型日志**
* **如何自查**:
    * **触发检查**: 如果这里一片空白，说明根本没有触发总结任务。请检查 **数据处理** → **记忆摘要** 中的楼层阈值设置。
    * **Prompt 检查**: 点击日志条目查看发送给 LLM 的 Prompt。
    * **Response 检查**: 查看 LLM 返回的内容。如果返回了 `404` 或 `Connection Refused`，说明 API 配置错误；如果返回了非 JSON 格式的胡言乱语，说明模型不够聪明，建议更换模型或调整 **提示词模板**。

### 3. 聊过的事情没记起来 (RAG 失效)
> **症状**: 我明明前两句刚提过这事，AI 还是不知道，或者召回了无关的内容。

* **检查目标**: <Database className="inline w-4 h-4 mb-1"/> **召回日志**
* **如何自查**:
    * **Query 检查**: 看系统把你的话转换成了什么搜索关键词。
    * **Score 检查**: 查看召回条目的相似度得分。如果得分很低（< 0.3），说明检索相关性不足。
    * **结果检查**: 如果日志里显示召回了正确的内容，但 AI 还是没反应，那可能是 LLM 的上下文窗口太小，或者 LLM 选择性忽略了注入的信息。

---

## 🛠️ 常见问题解决方案

### <AlertTriangle className="inline w-5 h-5 mb-1 text-yellow-500"/> 运行错误类

#### Q: 插件显示"连接失败"或 API 报错 (404/Connection Refused)？
* **原因**: Engram 无法连接到你配置的 LLM 后端。
* **解决**:
    1.  检查 **API Base URL** 是否填写正确（通常需要包含 `/v1`，例如 `http://127.0.0.1:11434/v1`）。
    2.  **CORS 问题**: 如果你在浏览器控制台（按 F12）看到 CORS 错误，请确保你的 API 服务端（如 Ollama, LM Studio）允许跨域请求（设置 `OLLAMA_ORIGINS="*"`）。
    3.  **API Key**: 某些服务商必须填写 Key 才能访问，即使是本地服务也可以随便填一个字符串（如 `sk-test`）以此骗过校验。

#### Q: 修改了记忆文本，但搜索不到？
* **原因**: 向量索引是基于修改前的文本生成的，修改文本后索引失效。
* **解决**: 在 **记忆编辑** 页面，找到修改过的条目，点击卡片上的 **<Search className="inline w-3 h-3"/> Re-embed** 按钮，重新生成向量数据。

#### Q: <ShieldAlert className="inline w-4 h-4 mb-1"/> 更新时提示 "Forbidden" 或 "EACCES" 错误？
* **原因**: SillyTavern 也就是 Node.js 进程没有权限覆盖旧文件。
* **解决**:
    1.  手动前往 `SillyTavern/public/scripts/extensions` 目录删除 `Engram` 文件夹，然后重新下载安装。
    2.  或者赋予您的系统当前用户对 SillyTavern 文件夹的完全读写权限。

### <FileText className="inline w-5 h-5 mb-1 text-blue-500"/> 功能逻辑类

#### Q: <Clock className="inline w-4 h-4 mb-1"/> 为什么我刚发完消息，自动总结没有立刻开始？
* **原因**: 这是有意为之的。Engram 使用了 **缓冲层 (Buffer)** 机制（默认 10 层）。
* **解释**: 系统会等待最新的消息变成"旧闻"后才进行总结。这样做是为了给你留出修改、撤回、重新生成的时间。如果立刻总结，一旦你修改了聊天记录，生成的记忆就会和最新的聊天对不上，产生"幻觉"或冲突。

#### Q: 预处理 (Preprocessing) 到底是干嘛的？我需要开启吗？
* **解释**: 这是一个高级功能。它允许你在发送消息给角色 **之前**，先拦截你的输入，用另一个 AI 跑一遍自定义指令。
* **场景**:
    *   **润色**: 输入"帮我把这句话改得更委婉点：你是个白痴"，AI 润色后，再发送给角色。
    *   **旁白**: 输入"描述一下现在的环境"，AI 生成一段环境描写，自动封装成旁白发送。
    *   **情报分析**: 让 AI 分析当前对话局势，把分析结果作为 `System Note` 注入。
* **结论**: 如果你只是想单纯聊天的玩家，可以关闭它。如果你是硬核 Roleplayer 或写手，它会是神技。

#### Q: 自动总结没有触发？
* **原因**: 为了防止 LLM 刷屏，Engram 设有保护机制。
* **解决**:
    1.  **楼层间隔**: 检查新消息数量是否达到设定的阈值（默认 5-10 条，在 **仪表盘** 可调）。
    2.  **串行保护**: 检查右上角是否有加载动画？如果上一轮总结任务还在转圈（卡死），新任务不会开始。请尝试刷新页面重置任务队列。
    3.  **Token 限制**: 如果历史记录过长且未开启上下文截断，可能导致 Prompt 构建失败。

#### Q: 开启 RAG 后回复变慢？
* **原因**: 每次你发送消息时，Engram 都要先进行 Embedding（向量化）和 Rerank（重排序），这增加了网络请求环节。
* **解决**:
    * 使用本地 **Transformers.js** 嵌入模型（在 **API 预设** → **向量化** 中选择 `Transformers (本地)`），这会利用浏览器 WebGPU 加速，消除网络延迟。
    * 关闭 Rerank 步骤（虽然会降低精度，但能显著提升速度）。

#### Q: 数据备份和多端同步？
* **现状**: 目前 Engram 的数据完全存储在浏览器的 **IndexedDB** 中。
* **计划**: 我们正在开发基于本地文件备份和同步的同步功能。目前如果需要备份，可以在浏览器开发者工具中手动导出 IndexedDB 数据。

---
