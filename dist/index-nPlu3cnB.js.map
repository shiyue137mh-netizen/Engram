{"version":3,"file":"index-nPlu3cnB.js","sources":["../src/core/summarizer/TextProcessor.ts","../src/core/summarizer/LLMAdapter.ts","../src/core/summarizer/types.ts","../src/core/summarizer/SummarizerService.ts"],"sourcesContent":["/**\n * TextProcessor - æ–‡æœ¬å¤„ç†å·¥å…·\n * \n * æä¾› LLM è¾“å‡ºæ¸…æ´—ã€æ ¼å¼åŒ–ç­‰åŠŸèƒ½\n */\n\n/** æ­£åˆ™æ›¿æ¢è§„åˆ™ */\ninterface TrimRule {\n    pattern: RegExp;\n    replacement: string;\n    description: string;\n}\n\n/** é»˜è®¤æ¸…æ´—è§„åˆ™ */\nconst DEFAULT_TRIM_RULES: TrimRule[] = [\n    // ç§»é™¤å¤šä½™ç©ºè¡Œ\n    { pattern: /\\n{3,}/g, replacement: '\\n\\n', description: 'å¤šä½™ç©ºè¡Œ' },\n    // ç§»é™¤è¡Œé¦–è¡Œå°¾ç©ºç™½\n    { pattern: /^[ \\t]+|[ \\t]+$/gm, replacement: '', description: 'è¡Œé¦–å°¾ç©ºç™½' },\n    // ç§»é™¤ Markdown ä»£ç å—æ ‡è®°ï¼ˆä¿ç•™å†…å®¹ï¼‰\n    { pattern: /```\\w*\\n?/g, replacement: '', description: 'Markdownä»£ç å—' },\n    // ç»Ÿä¸€ä¸­æ–‡å¼•å·\n    { pattern: /[\"\"]/g, replacement: '\"', description: 'ä¸­æ–‡å¼•å·' },\n    { pattern: /['']/g, replacement: \"'\", description: 'ä¸­æ–‡å•å¼•å·' },\n    // ç§»é™¤å¸¸è§çš„ LLM å‰ç¼€\n    { pattern: /^(å¥½çš„|ä»¥ä¸‹æ˜¯|è¿™æ˜¯|æ ¹æ®å¯¹è¯).{0,20}[:ï¼š]\\s*/gm, replacement: '', description: 'LLMå‰ç¼€' },\n    // ç§»é™¤æœ«å°¾çš„è§£é‡Šæ€§æ–‡å­—\n    { pattern: /\\n*å¦‚æœ.{0,50}è¯·.{0,30}[ã€‚ï¼]?\\s*$/g, replacement: '', description: 'æœ«å°¾è§£é‡Š' },\n];\n\n/**\n * TextProcessor ç±»\n * æ–‡æœ¬å¤„ç†å·¥å…·é›†\n */\nexport class TextProcessor {\n    private rules: TrimRule[];\n\n    constructor(customRules?: TrimRule[]) {\n        this.rules = customRules || DEFAULT_TRIM_RULES;\n    }\n\n    /**\n     * æ¸…æ´— LLM è¾“å‡ºæ–‡æœ¬\n     * @param text åŸå§‹æ–‡æœ¬\n     * @returns æ¸…æ´—åçš„æ–‡æœ¬\n     */\n    clean(text: string): string {\n        let result = text;\n\n        for (const rule of this.rules) {\n            result = result.replace(rule.pattern, rule.replacement);\n        }\n\n        return result.trim();\n    }\n\n    /**\n     * æ ¼å¼åŒ–ä¸ºä¸–ç•Œä¹¦æ¡ç›®æ ¼å¼\n     * @param summary æ€»ç»“å†…å®¹\n     * @param metadata å…ƒæ•°æ®\n     */\n    formatAsWorldEntry(\n        summary: string,\n        metadata: {\n            floorRange: [number, number];\n            timestamp: number;\n            characterName?: string;\n        }\n    ): string {\n        const date = new Date(metadata.timestamp);\n        const dateStr = date.toLocaleDateString('zh-CN');\n        const floorStr = `${metadata.floorRange[0]}-${metadata.floorRange[1]}`;\n\n        // ä½¿ç”¨ç®€æ´æ ¼å¼ï¼Œé¿å…æµªè´¹ Token\n        let entry = `ğŸ“œ å‰§æƒ…æ‘˜è¦ [æ¥¼å±‚${floorStr}]\\n`;\n        entry += summary;\n\n        return entry;\n    }\n\n    /**\n     * æå–çº¯æ–‡æœ¬ï¼ˆç§»é™¤æ‰€æœ‰æ ¼å¼æ ‡è®°ï¼‰\n     * @param text åŸå§‹æ–‡æœ¬\n     */\n    extractPlainText(text: string): string {\n        return text\n            .replace(/```[\\s\\S]*?```/g, '') // ç§»é™¤ä»£ç å—\n            .replace(/\\[([^\\]]+)\\]\\([^)]+\\)/g, '$1') // ç§»é™¤é“¾æ¥\n            .replace(/[*_~`#]/g, '') // ç§»é™¤ Markdown æ ‡è®°\n            .replace(/\\n{2,}/g, '\\n')\n            .trim();\n    }\n\n    /**\n     * æˆªæ–­æ–‡æœ¬åˆ°æŒ‡å®šé•¿åº¦\n     * @param text æ–‡æœ¬\n     * @param maxLength æœ€å¤§é•¿åº¦\n     * @param suffix æˆªæ–­åç¼€\n     */\n    truncate(text: string, maxLength: number, suffix = '...'): string {\n        if (text.length <= maxLength) {\n            return text;\n        }\n        return text.slice(0, maxLength - suffix.length) + suffix;\n    }\n\n    /**\n     * æ·»åŠ è‡ªå®šä¹‰è§„åˆ™\n     */\n    addRule(rule: TrimRule): void {\n        this.rules.push(rule);\n    }\n\n    /**\n     * è·å–å½“å‰è§„åˆ™åˆ—è¡¨\n     */\n    getRules(): TrimRule[] {\n        return [...this.rules];\n    }\n}\n\n/** é»˜è®¤å®ä¾‹ */\nexport const textProcessor = new TextProcessor();\n\nexport default TextProcessor;\n","/**\n * LLMAdapter - LLM è°ƒç”¨é€‚é…å™¨\n * \n * å°è£…å¯¹ SillyTavern/TavernHelper LLM API çš„è°ƒç”¨\n */\n\nimport type { LLMRequest, LLMResponse } from './types';\n\n/**\n * è·å– TavernHelper API\n */\nfunction getTavernHelper(): {\n    generate?: (options: unknown) => Promise<string>;\n    generateRaw?: (options: unknown) => Promise<string>;\n} | null {\n    try {\n        // @ts-expect-error - TavernHelper å…¨å±€å¯¹è±¡\n        return window.TavernHelper || null;\n    } catch {\n        return null;\n    }\n}\n\n/**\n * LLMAdapter ç±»\n * å°è£… LLM è°ƒç”¨\n */\nexport class LLMAdapter {\n    /**\n     * è°ƒç”¨ LLM ç”Ÿæˆ\n     * @param request è¯·æ±‚å‚æ•°\n     */\n    async generate(request: LLMRequest): Promise<LLMResponse> {\n        const helper = getTavernHelper();\n\n        if (!helper?.generateRaw && !helper?.generate) {\n            return {\n                success: false,\n                content: '',\n                error: 'TavernHelper ä¸å¯ç”¨',\n            };\n        }\n\n        try {\n            let content: string;\n\n            if (helper.generateRaw) {\n                // ä½¿ç”¨ generateRaw è¿›è¡Œå®Œå…¨è‡ªå®šä¹‰\n                content = await helper.generateRaw({\n                    ordered_prompts: [\n                        { role: 'system', content: request.systemPrompt },\n                        { role: 'user', content: request.userPrompt },\n                    ],\n                    // å¦‚æœæŒ‡å®šäº†é¢„è®¾ IDï¼Œå¯ä»¥åœ¨è¿™é‡Œé…ç½®\n                    // custom_api: request.presetId ? await this.getPresetConfig(request.presetId) : undefined,\n                });\n            } else if (helper.generate) {\n                // fallback: ä½¿ç”¨ generate\n                content = await helper.generate({\n                    user_input: request.userPrompt,\n                    system_prompt: request.systemPrompt,\n                    should_stream: false,\n                    max_chat_history: 0,\n                });\n            } else {\n                throw new Error('æ— å¯ç”¨çš„ç”Ÿæˆ API');\n            }\n\n            return {\n                success: true,\n                content: content || '',\n            };\n        } catch (e) {\n            const errorMsg = e instanceof Error ? e.message : String(e);\n            console.error('[Engram] LLMAdapter è°ƒç”¨å¤±è´¥:', e);\n\n            return {\n                success: false,\n                content: '',\n                error: errorMsg,\n            };\n        }\n    }\n\n    /**\n     * æ£€æŸ¥ LLM API æ˜¯å¦å¯ç”¨\n     */\n    isAvailable(): boolean {\n        const helper = getTavernHelper();\n        return !!(helper?.generate || helper?.generateRaw);\n    }\n\n    /**\n     * ä¼°ç®—æ–‡æœ¬ Token æ•°ï¼ˆç®€å•ä¼°ç®—ï¼‰\n     * @param text æ–‡æœ¬\n     */\n    estimateTokens(text: string): number {\n        // ç®€å•ä¼°ç®—ï¼šä¸­æ–‡çº¦ 2 å­—ç¬¦/tokenï¼Œè‹±æ–‡çº¦ 4 å­—ç¬¦/token\n        // è¿™é‡Œå–å¹³å‡å€¼ 3\n        return Math.ceil(text.length / 3);\n    }\n}\n\n/** é»˜è®¤å®ä¾‹ */\nexport const llmAdapter = new LLMAdapter();\n\nexport default LLMAdapter;\n","/**\n * Summarizer æ¨¡å—ç±»å‹å®šä¹‰\n */\n\n/** è§¦å‘æ¨¡å¼ */\nexport type TriggerMode = 'auto' | 'manual';\n\n/** ä¸–ç•Œä¹¦ç»‘å®šæ¨¡å¼ */\nexport type WorldbookBindMode = 'chat' | 'character';\n\n/** Summarizer é…ç½® */\nexport interface SummarizerConfig {\n    /** æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ€»ç»“ */\n    enabled: boolean;\n    /** è§¦å‘æ¨¡å¼ï¼šè‡ªåŠ¨/æ‰‹åŠ¨ */\n    triggerMode: TriggerMode;\n    /** æ¥¼å±‚é—´éš”ï¼šæ¯ N æ¥¼è§¦å‘ä¸€æ¬¡ */\n    floorInterval: number;\n    /** ä¸–ç•Œä¹¦ç»‘å®šæ¨¡å¼ */\n    worldbookMode: WorldbookBindMode;\n    /** æ˜¯å¦å¯ç”¨é¢„è§ˆ */\n    previewEnabled: boolean;\n    /** ä½¿ç”¨çš„æç¤ºè¯æ¨¡æ¿ ID */\n    promptTemplateId: string | null;\n    /** ä½¿ç”¨çš„ LLM é¢„è®¾ IDï¼ˆnull è¡¨ç¤ºä½¿ç”¨é»˜è®¤ï¼‰ */\n    llmPresetId: string | null;\n}\n\n/** é»˜è®¤é…ç½® */\nexport const DEFAULT_SUMMARIZER_CONFIG: SummarizerConfig = {\n    enabled: true,\n    triggerMode: 'auto',\n    floorInterval: 10,\n    worldbookMode: 'chat',\n    previewEnabled: true,\n    promptTemplateId: null, // ä½¿ç”¨å†…ç½®é»˜è®¤æ¨¡æ¿\n    llmPresetId: null,      // ä½¿ç”¨é»˜è®¤é¢„è®¾\n};\n\n/** æ€»ç»“ç»“æœ */\nexport interface SummaryResult {\n    /** æ€»ç»“å†…å®¹ */\n    content: string;\n    /** Token æ•°é‡ */\n    tokenCount: number;\n    /** æ¥æºæ¥¼å±‚èŒƒå›´ [èµ·å§‹, ç»“æŸ] */\n    sourceFloors: [number, number];\n    /** ç”Ÿæˆæ—¶é—´æˆ³ */\n    timestamp: number;\n    /** æ˜¯å¦å·²å†™å…¥ä¸–ç•Œä¹¦ */\n    writtenToWorldbook: boolean;\n    /** ä¸–ç•Œä¹¦æ¡ç›® IDï¼ˆå¦‚æœå·²å†™å…¥ï¼‰ */\n    worldbookEntryId?: string;\n}\n\n/** Summarizer çŠ¶æ€ */\nexport interface SummarizerStatus {\n    /** æ˜¯å¦æ­£åœ¨è¿è¡Œ */\n    running: boolean;\n    /** å½“å‰æ¥¼å±‚è®¡æ•° */\n    currentFloor: number;\n    /** ä¸Šæ¬¡æ€»ç»“æ—¶çš„æ¥¼å±‚ */\n    lastSummarizedFloor: number;\n    /** å¾…å¤„ç†æ¥¼å±‚æ•° */\n    pendingFloors: number;\n    /** æ€»ç»“å†å²è®°å½•æ•° */\n    historyCount: number;\n    /** æ˜¯å¦æ­£åœ¨æ‰§è¡Œæ€»ç»“ */\n    isSummarizing: boolean;\n}\n\n/** æ€»ç»“è¯·æ±‚å‚æ•° */\nexport interface SummarizeRequest {\n    /** æ¶ˆæ¯å†…å®¹æ•°ç»„ */\n    messages: Array<{\n        role: 'user' | 'assistant' | 'system';\n        content: string;\n        name?: string;\n    }>;\n    /** æ¥¼å±‚èŒƒå›´ */\n    floorRange: [number, number];\n    /** ä½¿ç”¨çš„æ¨¡æ¿ ID */\n    templateId?: string;\n}\n\n/** LLM ç”Ÿæˆè¯·æ±‚ */\nexport interface LLMRequest {\n    /** ç³»ç»Ÿæç¤ºè¯ */\n    systemPrompt: string;\n    /** ç”¨æˆ·æç¤ºè¯ */\n    userPrompt: string;\n    /** é¢„è®¾ ID */\n    presetId?: string;\n}\n\n/** LLM ç”Ÿæˆå“åº” */\nexport interface LLMResponse {\n    /** ç”Ÿæˆå†…å®¹ */\n    content: string;\n    /** æ˜¯å¦æˆåŠŸ */\n    success: boolean;\n    /** é”™è¯¯ä¿¡æ¯ */\n    error?: string;\n    /** Token ä½¿ç”¨é‡ */\n    tokenUsage?: {\n        prompt: number;\n        completion: number;\n        total: number;\n    };\n}\n","/**\n * SummarizerService - å‰§æƒ…æ€»ç»“æ ¸å¿ƒæœåŠ¡\n * \n * æä¾›æ¥¼å±‚ç›‘å¬ã€æ€»ç»“è§¦å‘ã€ä¸–ç•Œä¹¦å†™å…¥ç­‰åŠŸèƒ½\n * \n * ä¿®å¤ï¼š\n * 1. ä½¿ç”¨ chat_metadata å­˜å‚¨ lastSummarizedFloorï¼ˆæ¯èŠå¤©ç‹¬ç«‹ï¼‰\n * 2. æ­£ç¡®è·å–å½“å‰æ¥¼å±‚æ•°ï¼ˆcontext.chat.lengthï¼‰\n * 3. ç›‘å¬èŠå¤©åˆ‡æ¢äº‹ä»¶ä»¥é‡ç½®çŠ¶æ€\n */\n\nimport { EventBus, TavernEventType, MessageService, WorldInfoService } from '../../infrastructure/tavern';\nimport { TextProcessor, textProcessor } from './TextProcessor';\nimport { LLMAdapter, llmAdapter } from './LLMAdapter';\nimport { RegexProcessor, regexProcessor } from './RegexProcessor';\nimport { ModelLogger } from '../../infrastructure/logger/ModelLogger';\nimport { SettingsManager } from '../../infrastructure/SettingsManager';\nimport type {\n    SummarizerConfig,\n    SummarizerStatus,\n    SummaryResult,\n    SummarizeRequest,\n} from './types';\nimport { DEFAULT_SUMMARIZER_CONFIG } from './types';\n\n/** å¤‡ç”¨æ€»ç»“æç¤ºè¯æ¨¡æ¿ï¼ˆAPIPresets æ— å¯ç”¨æ¨¡æ¿æ—¶ä½¿ç”¨ï¼‰ */\nconst FALLBACK_SUMMARY_PROMPT = {\n    system: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å‰§æƒ…æ€»ç»“åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†å¯¹è¯å†…å®¹æç‚¼ä¸ºç®€æ´çš„å‰§æƒ…æ‘˜è¦ã€‚\n\nè¦æ±‚ï¼š\n1. ä¿ç•™å…³é”®æƒ…èŠ‚å’Œè½¬æŠ˜ç‚¹\n2. æå–é‡è¦çš„è§’è‰²äº’åŠ¨å’Œæƒ…æ„Ÿå˜åŒ–\n3. ä½¿ç”¨ç¬¬ä¸‰äººç§°å™è¿°\n4. ä¿æŒç®€æ´ï¼Œé¿å…å†—ä½™\n5. ç›´æ¥è¾“å‡ºæ‘˜è¦å†…å®¹ï¼Œä¸è¦æ·»åŠ å‰ç¼€æˆ–è§£é‡Š`,\n\n    user: `{{worldbookContext}}è¯·å°†ä»¥ä¸‹å¯¹è¯å†…å®¹æ€»ç»“ä¸ºå‰§æƒ…æ‘˜è¦ï¼š\n\n{{chatHistory}}\n\n---\nè¯·è¾“å‡ºç®€æ´çš„å‰§æƒ…æ‘˜è¦ï¼š`,\n};\n\n/** å…ƒæ•°æ® key */\nconst METADATA_KEY = 'engram';\n\n/**\n * è·å– SillyTavern ä¸Šä¸‹æ–‡\n */\nfunction getSTContext(): {\n    chat: unknown[];\n    chatId: string;\n    characterId: number;\n} | null {\n    try {\n        // @ts-expect-error - SillyTavern å…¨å±€å¯¹è±¡\n        return window.SillyTavern?.getContext?.() || null;\n    } catch {\n        return null;\n    }\n}\n\n/**\n * è·å– chat_metadata\n */\nfunction getChatMetadata(): Record<string, unknown> | null {\n    try {\n        // ä¼˜å…ˆä» context è·å–\n        // @ts-expect-error - SillyTavern å…¨å±€å¯¹è±¡\n        const context = window.SillyTavern?.getContext?.();\n        if (context?.chat_metadata) {\n            return context.chat_metadata;\n        }\n        // å¤‡ç”¨ï¼šç›´æ¥è®¿é—®å…¨å±€å˜é‡\n        // @ts-expect-error - SillyTavern å…¨å±€å˜é‡\n        return window.chat_metadata || null;\n    } catch {\n        return null;\n    }\n}\n\n/**\n * ä¿å­˜èŠå¤©ï¼ˆé˜²æŠ–ï¼‰\n */\nfunction saveChatDebounced(): void {\n    try {\n        // @ts-expect-error - SillyTavern å…¨å±€å‡½æ•°\n        window.saveChatDebounced?.();\n    } catch {\n        console.warn('[Engram] saveChatDebounced ä¸å¯ç”¨');\n    }\n}\n\n/**\n * SummarizerService ç±»\n * æ ¸å¿ƒæ€»ç»“æœåŠ¡\n */\nexport class SummarizerService {\n    private config: SummarizerConfig;\n    private textProcessor: TextProcessor;\n    private llmAdapter: LLMAdapter;\n\n    private currentChatId: string | null = null;\n    private isRunning = false;\n    private isSummarizing = false;\n    private unsubscribeMessage: (() => void) | null = null;\n    private unsubscribeChat: (() => void) | null = null;\n    private summaryHistory: SummaryResult[] = [];\n\n    constructor(\n        config?: Partial<SummarizerConfig>,\n        processor?: TextProcessor,\n        adapter?: LLMAdapter\n    ) {\n        this.config = { ...DEFAULT_SUMMARIZER_CONFIG, ...config };\n        this.textProcessor = processor || textProcessor;\n        this.llmAdapter = adapter || llmAdapter;\n    }\n\n    // ==================== å…ƒæ•°æ®æ“ä½œ ====================\n\n    /**\n     * ä»å½“å‰èŠå¤©å…ƒæ•°æ®è·å–å€¼\n     */\n    private getFromChatMetadata(key: string): unknown {\n        const metadata = getChatMetadata();\n        if (!metadata) {\n            this.log('warn', 'chat_metadata ä¸å¯ç”¨');\n            return undefined;\n        }\n\n        // åˆå§‹åŒ–ç»“æ„\n        if (!metadata.extensions) {\n            metadata.extensions = {};\n        }\n        // @ts-expect-error - åŠ¨æ€è®¿é—®\n        if (!metadata.extensions[METADATA_KEY]) {\n            // @ts-expect-error - åŠ¨æ€è®¿é—®\n            metadata.extensions[METADATA_KEY] = {};\n        }\n\n        // @ts-expect-error - åŠ¨æ€è®¿é—®\n        return metadata.extensions[METADATA_KEY][key];\n    }\n\n    /**\n     * ä¿å­˜å€¼åˆ°å½“å‰èŠå¤©å…ƒæ•°æ®\n     */\n    private saveToChatMetadata(key: string, value: unknown): void {\n        const metadata = getChatMetadata();\n        if (!metadata) {\n            this.log('warn', 'chat_metadata ä¸å¯ç”¨ï¼Œæ— æ³•ä¿å­˜');\n            return;\n        }\n\n        // åˆå§‹åŒ–ç»“æ„\n        if (!metadata.extensions) {\n            metadata.extensions = {};\n        }\n        // @ts-expect-error - åŠ¨æ€è®¿é—®\n        if (!metadata.extensions[METADATA_KEY]) {\n            // @ts-expect-error - åŠ¨æ€è®¿é—®\n            metadata.extensions[METADATA_KEY] = {};\n        }\n\n        // @ts-expect-error - åŠ¨æ€è®¿é—®\n        metadata.extensions[METADATA_KEY][key] = value;\n\n        this.log('debug', `å·²ä¿å­˜åˆ° chat_metadata: ${key} = ${value}`);\n\n        // è§¦å‘ä¿å­˜\n        saveChatDebounced();\n    }\n\n    /**\n     * è·å–ä¸Šæ¬¡æ€»ç»“çš„æ¥¼å±‚ï¼ˆä»èŠå¤©å…ƒæ•°æ®ï¼‰\n     */\n    private getLastSummarizedFloor(): number {\n        const value = this.getFromChatMetadata('lastSummarizedFloor');\n        return typeof value === 'number' ? value : 0;\n    }\n\n    /**\n     * è®¾ç½®ä¸Šæ¬¡æ€»ç»“çš„æ¥¼å±‚ï¼ˆä¿å­˜åˆ°èŠå¤©å…ƒæ•°æ®ï¼‰\n     */\n    private setLastSummarizedFloor(floor: number): void {\n        this.saveToChatMetadata('lastSummarizedFloor', floor);\n    }\n\n    // ==================== æ¥¼å±‚è®¡ç®— ====================\n\n    /**\n     * è·å–å½“å‰çœŸå®æ¥¼å±‚æ•°\n     */\n    private getCurrentFloor(): number {\n        const context = getSTContext();\n        if (!context?.chat) {\n            return 0;\n        }\n        // æ¥¼å±‚ä»0å¼€å§‹è®¡æ•°ï¼Œæ‰€ä»¥ length - 1 æ˜¯æœ€åä¸€æ¥¼çš„ç´¢å¼•\n        return context.chat.length;\n    }\n\n    /**\n     * è·å–å½“å‰èŠå¤© ID\n     */\n    private getCurrentChatId(): string | null {\n        const context = getSTContext();\n        return context?.chatId || null;\n    }\n\n    // ==================== ç”Ÿå‘½å‘¨æœŸ ====================\n\n    /**\n     * å¯åŠ¨æœåŠ¡ï¼Œå¼€å§‹ç›‘å¬äº‹ä»¶\n     */\n    start(): void {\n        if (this.isRunning) {\n            this.log('warn', 'æœåŠ¡å·²åœ¨è¿è¡Œ');\n            return;\n        }\n\n        // åˆå§‹åŒ–å½“å‰èŠå¤©çŠ¶æ€\n        this.initializeForCurrentChat();\n\n        // ç›‘å¬æ¶ˆæ¯æ¥æ”¶äº‹ä»¶\n        if (this.config.triggerMode === 'auto') {\n            this.unsubscribeMessage = EventBus.on(\n                TavernEventType.MESSAGE_RECEIVED,\n                this.handleMessageReceived.bind(this)\n            );\n            this.log('debug', `å·²è®¢é˜…äº‹ä»¶: ${TavernEventType.MESSAGE_RECEIVED}`);\n        }\n\n        // ç›‘å¬èŠå¤©åˆ‡æ¢äº‹ä»¶\n        this.unsubscribeChat = EventBus.on(\n            TavernEventType.CHAT_CHANGED,\n            this.handleChatChanged.bind(this)\n        );\n        this.log('debug', `å·²è®¢é˜…äº‹ä»¶: ${TavernEventType.CHAT_CHANGED}`);\n\n        this.isRunning = true;\n\n        const status = this.getStatus();\n        this.log('info', 'æœåŠ¡å·²å¯åŠ¨', status);\n    }\n\n    /**\n     * åœæ­¢æœåŠ¡\n     */\n    stop(): void {\n        if (this.unsubscribeMessage) {\n            this.unsubscribeMessage();\n            this.unsubscribeMessage = null;\n        }\n        if (this.unsubscribeChat) {\n            this.unsubscribeChat();\n            this.unsubscribeChat = null;\n        }\n        this.isRunning = false;\n        this.log('info', 'æœåŠ¡å·²åœæ­¢');\n    }\n\n    /**\n     * ä¸ºå½“å‰èŠå¤©åˆå§‹åŒ–çŠ¶æ€\n     */\n    private initializeForCurrentChat(): void {\n        const chatId = this.getCurrentChatId();\n        const currentFloor = this.getCurrentFloor();\n        const lastSummarized = this.getLastSummarizedFloor();\n\n        this.currentChatId = chatId;\n\n        this.log('info', 'åˆå§‹åŒ–å½“å‰èŠå¤©çŠ¶æ€', {\n            chatId,\n            currentFloor,\n            lastSummarizedFloor: lastSummarized,\n            pendingFloors: currentFloor - lastSummarized,\n        });\n\n        // å¦‚æœä»æœªæ€»ç»“è¿‡ï¼ˆlastSummarized=0ï¼‰ï¼Œåˆå§‹åŒ–ä¸ºå½“å‰æ¥¼å±‚\n        if (lastSummarized === 0 && currentFloor > 0) {\n            this.log('info', 'é¦–æ¬¡åˆå§‹åŒ–ï¼Œè®¾ç½®åŸºå‡†ä¸ºå½“å‰æ¥¼å±‚', { currentFloor });\n            this.setLastSummarizedFloor(currentFloor);\n        }\n    }\n\n    // ==================== äº‹ä»¶å¤„ç† ====================\n\n    /**\n     * å¤„ç†æ¶ˆæ¯æ¥æ”¶äº‹ä»¶\n     */\n    private async handleMessageReceived(): Promise<void> {\n        const currentFloor = this.getCurrentFloor();\n        const lastSummarized = this.getLastSummarizedFloor();\n        const pendingFloors = currentFloor - lastSummarized;\n\n        this.log('debug', 'æ”¶åˆ°æ–°æ¶ˆæ¯', {\n            currentFloor,\n            lastSummarized,\n            pendingFloors,\n            triggerAt: this.config.floorInterval,\n        });\n\n        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°è§¦å‘æ¡ä»¶\n        if (pendingFloors >= this.config.floorInterval) {\n            this.log('info', 'è¾¾åˆ°è§¦å‘æ¡ä»¶ï¼Œå‡†å¤‡æ€»ç»“', {\n                pendingFloors,\n                interval: this.config.floorInterval,\n            });\n            await this.triggerSummary();\n        }\n    }\n\n    /**\n     * å¤„ç†èŠå¤©åˆ‡æ¢äº‹ä»¶\n     */\n    private handleChatChanged(): void {\n        const newChatId = this.getCurrentChatId();\n\n        this.log('info', 'èŠå¤©å·²åˆ‡æ¢', {\n            from: this.currentChatId,\n            to: newChatId,\n        });\n\n        // é‡æ–°åˆå§‹åŒ–\n        this.initializeForCurrentChat();\n    }\n\n    // ==================== æ€»ç»“é€»è¾‘ ====================\n\n    /**\n     * æ‰‹åŠ¨/è‡ªåŠ¨è§¦å‘æ€»ç»“\n     */\n    async triggerSummary(manual = false): Promise<SummaryResult | null> {\n        if (this.isSummarizing) {\n            this.log('warn', 'æ­£åœ¨æ‰§è¡Œæ€»ç»“ï¼Œè·³è¿‡æœ¬æ¬¡è§¦å‘');\n            return null;\n        }\n\n        if (!this.config.enabled && !manual) {\n            this.log('debug', 'è‡ªåŠ¨æ€»ç»“å·²ç¦ç”¨');\n            return null;\n        }\n\n        const currentFloor = this.getCurrentFloor();\n        const lastSummarized = this.getLastSummarizedFloor();\n\n        this.isSummarizing = true;\n        this.log('info', 'å¼€å§‹æ‰§è¡Œæ€»ç»“', {\n            floorRange: [lastSummarized + 1, currentFloor],\n            manual,\n        });\n\n        try {\n            // è·å–å¾…æ€»ç»“çš„æ¶ˆæ¯\n            const messages = MessageService.getMessages(lastSummarized, currentFloor);\n\n            if (messages.length === 0) {\n                this.log('warn', 'æ²¡æœ‰å¾…æ€»ç»“çš„æ¶ˆæ¯');\n                return null;\n            }\n\n            // æ„å»ºè¯·æ±‚\n            const request: SummarizeRequest = {\n                messages: messages.map(m => ({\n                    role: m.role,\n                    content: m.content,\n                    name: m.name,\n                })),\n                floorRange: [lastSummarized + 1, currentFloor],\n            };\n\n            // 1. è·å–èŠå¤©è®°å½•å¹¶åº”ç”¨æ­£åˆ™æ¸…æ´—\n            const rawChatHistory = MessageService.formatMessagesAsText(messages);\n            const cleanedChatHistory = regexProcessor.process(rawChatHistory);\n            this.log('debug', 'åº”ç”¨æ­£åˆ™æ¸…æ´—', {\n                originalLength: rawChatHistory.length,\n                cleanedLength: cleanedChatHistory.length,\n            });\n\n            // 2. è·å–ä¸–ç•Œä¹¦å†…å®¹ï¼ˆä½¿ç”¨æ–°æ–¹æ³•ï¼‰\n            let worldbookContext = '';\n            try {\n                const worldInfo = await WorldInfoService.getActivatedWorldInfo();\n                if (worldInfo) {\n                    worldbookContext = 'ã€èƒŒæ™¯è®¾å®šã€‘\\n' + worldInfo + '\\n\\n';\n                    this.log('debug', 'å·²åŠ è½½ä¸–ç•Œä¹¦å†…å®¹', { length: worldInfo.length });\n                }\n            } catch (e) {\n                this.log('warn', 'è·å–ä¸–ç•Œä¹¦å¤±è´¥', { error: String(e) });\n            }\n\n            // 3. è·å–æç¤ºè¯æ¨¡æ¿ï¼ˆä¼˜å…ˆä» APIPresets è·å–ï¼‰\n            const template = SettingsManager.getEnabledPromptTemplate('text_summary');\n            const systemPrompt = template?.systemPrompt || FALLBACK_SUMMARY_PROMPT.system;\n            const userPromptTemplate = template?.userPromptTemplate || FALLBACK_SUMMARY_PROMPT.user;\n\n            // æ„å»ºæœ€ç»ˆæç¤ºè¯\n            const userPrompt = userPromptTemplate\n                .replace('{{worldbookContext}}', worldbookContext)\n                .replace('{{chatHistory}}', cleanedChatHistory)\n                .replace('{{context}}', worldbookContext);  // å…¼å®¹ä¸¤ç§å˜é‡å\n\n            this.log('debug', 'ä½¿ç”¨æç¤ºè¯æ¨¡æ¿', {\n                source: template ? 'APIPresets' : 'fallback',\n                templateName: template?.name || 'default'\n            });\n\n            // 4. è®°å½•åˆ°æ¨¡å‹æ—¥å¿—å¹¶è°ƒç”¨ LLM\n            const logId = ModelLogger.logSend({\n                type: 'summarize',\n                systemPrompt,\n                userPrompt,\n                floorRange: request.floorRange,\n            });\n\n            const startTime = Date.now();\n            const response = await this.llmAdapter.generate({\n                systemPrompt,\n                userPrompt,\n            });\n\n            // è®°å½•å“åº”\n            ModelLogger.logReceive(logId, {\n                response: response.content,\n                status: response.success ? 'success' : 'error',\n                error: response.error,\n                duration: Date.now() - startTime,\n            });\n\n            if (!response.success) {\n                this.log('error', 'LLM è°ƒç”¨å¤±è´¥', { error: response.error });\n                this.showNotification('error', `æ€»ç»“å¤±è´¥: ${response.error}`);\n                return null;\n            }\n\n            // æ¸…æ´—è¾“å‡º\n            const cleanedContent = this.textProcessor.clean(response.content);\n\n            // è®¡ç®— Token\n            const tokenCount = await WorldInfoService.countTokens(cleanedContent);\n\n            // åˆ›å»ºç»“æœ\n            const result: SummaryResult = {\n                content: cleanedContent,\n                tokenCount,\n                sourceFloors: request.floorRange,\n                timestamp: Date.now(),\n                writtenToWorldbook: false,\n            };\n\n            // é¢„è§ˆæ¨¡å¼å¤„ç†ï¼ˆæš‚æ—¶è·³è¿‡ï¼Œåç»­å®ç°ï¼‰\n            if (this.config.previewEnabled) {\n                this.log('info', 'é¢„è§ˆæ¨¡å¼ï¼šç­‰å¾…ç”¨æˆ·ç¡®è®¤', { result });\n                // TODO: å¼¹å‡ºé¢„è§ˆé¢æ¿\n            }\n\n            // å†™å…¥ä¸–ç•Œä¹¦\n            const writeSuccess = await this.writeToWorldbook(result);\n            result.writtenToWorldbook = writeSuccess;\n\n            // æ›´æ–°çŠ¶æ€ - ä¿å­˜åˆ°èŠå¤©å…ƒæ•°æ®\n            this.setLastSummarizedFloor(currentFloor);\n            this.summaryHistory.push(result);\n\n            this.log('success', 'æ€»ç»“å®Œæˆ', {\n                tokens: tokenCount,\n                floorRange: result.sourceFloors,\n                newLastSummarized: currentFloor,\n            });\n\n            return result;\n        } catch (e) {\n            const errorMsg = e instanceof Error ? e.message : String(e);\n            this.log('error', 'æ€»ç»“æ‰§è¡Œå¼‚å¸¸', { error: errorMsg });\n            this.showNotification('error', `æ€»ç»“å¼‚å¸¸: ${errorMsg}`);\n            return null;\n        } finally {\n            this.isSummarizing = false;\n        }\n    }\n\n    /**\n     * å†™å…¥ä¸–ç•Œä¹¦\n     */\n    private async writeToWorldbook(result: SummaryResult): Promise<boolean> {\n        try {\n            const worldbookName = await WorldInfoService.getChatWorldbook();\n            if (!worldbookName) {\n                this.log('warn', 'æ— æ³•è·å–èŠå¤©ä¸–ç•Œä¹¦');\n                return false;\n            }\n\n            const formattedContent = this.textProcessor.formatAsWorldEntry(\n                result.content,\n                {\n                    floorRange: result.sourceFloors,\n                    timestamp: result.timestamp,\n                }\n            );\n\n            const success = await WorldInfoService.createEntry(worldbookName, {\n                name: `å‰§æƒ…æ‘˜è¦_${result.sourceFloors[0]}-${result.sourceFloors[1]}`,\n                content: formattedContent,\n                enabled: true,\n                constant: true,\n            });\n\n            if (success) {\n                this.log('success', 'å·²å†™å…¥ä¸–ç•Œä¹¦', { worldbook: worldbookName });\n            }\n\n            return success;\n        } catch (e) {\n            this.log('error', 'å†™å…¥ä¸–ç•Œä¹¦å¤±è´¥', { error: String(e) });\n            return false;\n        }\n    }\n\n    // ==================== çŠ¶æ€æŸ¥è¯¢ ====================\n\n    /**\n     * è·å–å½“å‰çŠ¶æ€\n     */\n    getStatus(): SummarizerStatus {\n        const currentFloor = this.getCurrentFloor();\n        const lastSummarized = this.getLastSummarizedFloor();\n\n        return {\n            running: this.isRunning,\n            currentFloor,\n            lastSummarizedFloor: lastSummarized,\n            pendingFloors: Math.max(0, currentFloor - lastSummarized),\n            historyCount: this.summaryHistory.length,\n            isSummarizing: this.isSummarizing,\n        };\n    }\n\n    /**\n     * åˆ·æ–°çŠ¶æ€ï¼ˆå¼ºåˆ¶é‡æ–°è¯»å–ï¼‰\n     */\n    refreshStatus(): SummarizerStatus {\n        this.initializeForCurrentChat();\n        return this.getStatus();\n    }\n\n    /**\n     * è·å–é…ç½®\n     */\n    getConfig(): SummarizerConfig {\n        return { ...this.config };\n    }\n\n    /**\n     * æ›´æ–°é…ç½®\n     */\n    updateConfig(config: Partial<SummarizerConfig>): void {\n        this.config = { ...this.config, ...config };\n        this.log('info', 'é…ç½®å·²æ›´æ–°', { config: this.config });\n    }\n\n    /**\n     * è·å–æ€»ç»“å†å²\n     */\n    getHistory(): SummaryResult[] {\n        return [...this.summaryHistory];\n    }\n\n    /**\n     * é‡ç½®åŸºå‡†æ¥¼å±‚ä¸ºå½“å‰æ¥¼å±‚\n     */\n    resetBaseFloor(): void {\n        const currentFloor = this.getCurrentFloor();\n        this.setLastSummarizedFloor(currentFloor);\n        this.log('info', 'å·²é‡ç½®åŸºå‡†æ¥¼å±‚', { currentFloor });\n    }\n\n    // ==================== å·¥å…·æ–¹æ³• ====================\n\n    /**\n     * è®°å½•æ—¥å¿—\n     */\n    private async log(\n        level: 'debug' | 'info' | 'success' | 'warn' | 'error',\n        message: string,\n        data?: unknown\n    ): Promise<void> {\n        try {\n            const { Logger } = await import('../../infrastructure/logger');\n            Logger[level]('Summarizer', message, data);\n        } catch {\n            console.log(`[Summarizer] ${level}: ${message}`, data);\n        }\n    }\n\n    /**\n     * æ˜¾ç¤ºé€šçŸ¥\n     */\n    private showNotification(type: 'success' | 'error' | 'warning' | 'info', message: string): void {\n        try {\n            // @ts-expect-error - toastr å…¨å±€å¯¹è±¡\n            const toastr = window.toastr;\n            if (toastr?.[type]) {\n                toastr[type](message, 'Engram');\n            }\n        } catch {\n            console.log(`[Engram Notification] ${type}: ${message}`);\n        }\n    }\n}\n\n/** é»˜è®¤å®ä¾‹ */\nexport const summarizerService = new SummarizerService();\n\nexport default SummarizerService;\n"],"names":["DEFAULT_TRIM_RULES","TextProcessor","customRules","__publicField","text","result","rule","summary","metadata","entry","maxLength","suffix","textProcessor","getTavernHelper","LLMAdapter","request","helper","content","e","errorMsg","llmAdapter","DEFAULT_SUMMARIZER_CONFIG","FALLBACK_SUMMARY_PROMPT","METADATA_KEY","getSTContext","_b","_a","getChatMetadata","context","saveChatDebounced","SummarizerService","config","processor","adapter","key","value","floor","EventBus","TavernEventType","status","chatId","currentFloor","lastSummarized","pendingFloors","newChatId","manual","messages","MessageService","m","rawChatHistory","cleanedChatHistory","regexProcessor","worldbookContext","worldInfo","WorldInfoService","template","SettingsManager","systemPrompt","userPrompt","logId","ModelLogger","startTime","response","cleanedContent","tokenCount","writeSuccess","worldbookName","formattedContent","success","level","message","data","Logger","n","type","toastr","summarizerService"],"mappings":"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"}