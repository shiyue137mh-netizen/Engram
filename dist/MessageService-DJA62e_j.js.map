{"version":3,"file":"MessageService-DJA62e_j.js","sources":["../src/infrastructure/tavern/EventBus.ts","../src/infrastructure/tavern/MessageService.ts"],"sourcesContent":["/**\n * EventBus - SillyTavern 事件总线封装\n * \n * 提供类型安全的事件订阅/取消订阅接口\n */\n\n// SillyTavern 事件类型 (从 events.js 提取的关键事件)\nexport const TavernEventType = {\n    // 消息事件\n    MESSAGE_SENT: 'message_sent',\n    MESSAGE_RECEIVED: 'message_received',\n    MESSAGE_EDITED: 'message_edited',\n    MESSAGE_DELETED: 'message_deleted',\n    MESSAGE_UPDATED: 'message_updated',\n    MESSAGE_SWIPED: 'message_swiped',\n    USER_MESSAGE_RENDERED: 'user_message_rendered',\n    CHARACTER_MESSAGE_RENDERED: 'character_message_rendered',\n\n    // 聊天事件\n    CHAT_CHANGED: 'chat_id_changed',\n    CHAT_CREATED: 'chat_created',\n    CHAT_DELETED: 'chat_deleted',\n\n    // 生成事件\n    GENERATION_STARTED: 'generation_started',\n    GENERATION_STOPPED: 'generation_stopped',\n    GENERATION_ENDED: 'generation_ended',\n    GENERATION_AFTER_COMMANDS: 'GENERATION_AFTER_COMMANDS',\n    STREAM_TOKEN_RECEIVED: 'stream_token_received',\n\n    // 世界书事件\n    WORLDINFO_UPDATED: 'worldinfo_updated',\n    WORLDINFO_SETTINGS_UPDATED: 'worldinfo_settings_updated',\n    WORLDINFO_ENTRIES_LOADED: 'worldinfo_entries_loaded',\n    WORLD_INFO_ACTIVATED: 'world_info_activated',\n\n    // 应用事件\n    APP_READY: 'app_ready',\n    SETTINGS_LOADED: 'settings_loaded',\n    SETTINGS_LOADED_AFTER: 'settings_loaded_after',\n    EXTENSION_SETTINGS_LOADED: 'extension_settings_loaded',\n\n    // 角色事件\n    CHARACTER_EDITED: 'character_edited',\n    CHARACTER_DELETED: 'characterDeleted',\n} as const;\n\nexport type TavernEventTypeKey = keyof typeof TavernEventType;\nexport type TavernEventTypeValue = typeof TavernEventType[TavernEventTypeKey];\n\n/** 事件回调函数类型 */\nexport type EventCallback = (...args: unknown[]) => void | Promise<void>;\n\n/** 取消订阅函数类型 */\nexport type Unsubscribe = () => void;\n\n/**\n * 获取 SillyTavern 的 eventSource\n * 注意：这个函数需要在运行时调用，因为 SillyTavern 的模块是动态加载的\n */\nfunction getEventSource(): {\n    on: (event: string, callback: EventCallback) => void;\n    once: (event: string, callback: EventCallback) => void;\n    emit: (event: string, ...args: unknown[]) => void;\n    removeListener: (event: string, callback: EventCallback) => void;\n} | null {\n    try {\n        // @ts-expect-error - SillyTavern 全局对象\n        const SillyTavern = window.SillyTavern;\n        if (SillyTavern?.getContext) {\n            const context = SillyTavern.getContext();\n            return context?.eventSource || null;\n        }\n        return null;\n    } catch {\n        console.warn('[Engram] EventBus: 无法获取 SillyTavern eventSource');\n        return null;\n    }\n}\n\n/**\n * EventBus 类\n * 封装 SillyTavern 事件系统，提供类型安全的 API\n */\nexport class EventBus {\n    private static listeners = new Map<string, Set<EventCallback>>();\n\n    /**\n     * 订阅事件\n     * @param event 事件名称\n     * @param callback 回调函数\n     * @returns 取消订阅函数\n     */\n    static on(event: TavernEventTypeValue | string, callback: EventCallback): Unsubscribe {\n        const eventSource = getEventSource();\n\n        if (eventSource) {\n            eventSource.on(event, callback);\n        }\n\n        // 本地存储以便清理\n        if (!this.listeners.has(event)) {\n            this.listeners.set(event, new Set());\n        }\n        this.listeners.get(event)!.add(callback);\n\n        // 返回取消订阅函数\n        return () => {\n            this.off(event, callback);\n        };\n    }\n\n    /**\n     * 一次性订阅事件（触发后自动取消）\n     * @param event 事件名称\n     * @param callback 回调函数\n     */\n    static once(event: TavernEventTypeValue | string, callback: EventCallback): void {\n        const eventSource = getEventSource();\n\n        if (eventSource) {\n            eventSource.once(event, callback);\n        } else {\n            // fallback: 自己实现 once\n            const wrappedCallback: EventCallback = (...args) => {\n                this.off(event, wrappedCallback);\n                callback(...args);\n            };\n            this.on(event, wrappedCallback);\n        }\n    }\n\n    /**\n     * 取消订阅事件\n     * @param event 事件名称\n     * @param callback 回调函数\n     */\n    static off(event: TavernEventTypeValue | string, callback: EventCallback): void {\n        const eventSource = getEventSource();\n\n        if (eventSource) {\n            eventSource.removeListener(event, callback);\n        }\n\n        // 从本地存储移除\n        this.listeners.get(event)?.delete(callback);\n    }\n\n    /**\n     * 清除所有已注册的监听器\n     * 在扩展卸载时调用\n     */\n    static clearAll(): void {\n        const eventSource = getEventSource();\n\n        for (const [event, callbacks] of this.listeners) {\n            for (const callback of callbacks) {\n                if (eventSource) {\n                    eventSource.removeListener(event, callback);\n                }\n            }\n        }\n\n        this.listeners.clear();\n    }\n\n    /**\n     * 检查 EventBus 是否可用\n     */\n    static isAvailable(): boolean {\n        return getEventSource() !== null;\n    }\n}\n\nexport default EventBus;\n","/**\n * MessageService - SillyTavern 消息服务封装\n * \n * 提供聊天消息获取、楼层计数等功能\n */\n\nimport { getSTContext, isSTAvailable } from '../STContext';\nimport type { STMessage } from '../STContext';\n\n/** 消息角色类型 */\nexport type MessageRole = 'user' | 'assistant' | 'system';\n\n/** 酒馆消息结构 */\nexport interface TavernMessage {\n    /** 消息 ID (楼层号) */\n    id: number;\n    /** 发送者角色 */\n    role: MessageRole;\n    /** 消息内容 */\n    content: string;\n    /** 发送者名称 */\n    name: string;\n    /** 是否隐藏 */\n    isHidden: boolean;\n    /** 原始消息对象引用 */\n    raw?: unknown;\n}\n\n/** 消息查询选项 */\nexport interface GetMessagesOptions {\n    /** 是否包含隐藏消息 */\n    includeHidden?: boolean;\n    /** 角色过滤 */\n    role?: MessageRole | MessageRole[];\n}\n\n/**\n * 将酒馆原始消息转换为统一格式\n */\nfunction convertMessage(msg: STMessage, index: number): TavernMessage {\n    let role: MessageRole = 'assistant';\n    if (msg.is_user) {\n        role = 'user';\n    } else if (msg.is_system) {\n        role = 'system';\n    }\n\n    return {\n        id: index,\n        role,\n        content: msg.mes || '',\n        name: msg.name || '',\n        isHidden: msg.is_hidden ?? false,\n        raw: msg,\n    };\n}\n\n/**\n * MessageService 类\n * 提供消息获取和楼层计数功能\n */\nexport class MessageService {\n    /**\n     * 获取当前聊天的所有消息\n     * @param options 查询选项\n     */\n    static getAllMessages(options: GetMessagesOptions = {}): TavernMessage[] {\n        const context = getSTContext();\n        if (!context?.chat) {\n            return [];\n        }\n\n        let messages = context.chat.map((msg, index) => convertMessage(msg, index));\n\n        // 过滤隐藏消息\n        if (!options.includeHidden) {\n            messages = messages.filter(m => !m.isHidden);\n        }\n\n        // 角色过滤\n        if (options.role) {\n            const roles = Array.isArray(options.role) ? options.role : [options.role];\n            messages = messages.filter(m => roles.includes(m.role));\n        }\n\n        return messages;\n    }\n\n    /**\n     * 获取最近 N 条消息\n     * @param count 消息数量\n     * @param options 查询选项\n     */\n    static getRecentMessages(count: number, options: GetMessagesOptions = {}): TavernMessage[] {\n        const messages = this.getAllMessages(options);\n        return messages.slice(-count);\n    }\n\n    /**\n     * 获取指定范围的消息\n     * @param start 起始索引（包含）\n     * @param end 结束索引（不包含）\n     * @param options 查询选项\n     */\n    static getMessages(start: number, end?: number, options: GetMessagesOptions = {}): TavernMessage[] {\n        const messages = this.getAllMessages(options);\n        return messages.slice(start, end);\n    }\n\n    /**\n     * 获取当前楼层数（消息总数）\n     * @param options 查询选项\n     */\n    static getFloorCount(options: GetMessagesOptions = {}): number {\n        return this.getAllMessages(options).length;\n    }\n\n    /**\n     * 获取最后一条消息\n     * @param options 查询选项\n     */\n    static getLastMessage(options: GetMessagesOptions = {}): TavernMessage | null {\n        const messages = this.getAllMessages(options);\n        return messages.length > 0 ? messages[messages.length - 1] : null;\n    }\n\n    /**\n     * 获取当前角色名称\n     */\n    static getCurrentCharacterName(): string | null {\n        const context = getSTContext();\n        if (!context?.characters || context.characterId < 0) {\n            return null;\n        }\n        return context.characters[context.characterId]?.name || null;\n    }\n\n    /**\n     * 格式化消息为纯文本（用于传给 LLM）\n     * @param messages 消息数组\n     * @param format 格式化模板\n     */\n    static formatMessagesAsText(\n        messages: TavernMessage[],\n        format: 'simple' | 'detailed' = 'simple'\n    ): string {\n        if (format === 'simple') {\n            return messages\n                .map(m => `${m.name}: ${m.content}`)\n                .join('\\n\\n');\n        }\n\n        return messages\n            .map(m => `[${m.role.toUpperCase()}] ${m.name}:\\n${m.content}`)\n            .join('\\n\\n---\\n\\n');\n    }\n\n    /**\n     * 检查 MessageService 是否可用\n     */\n    static isAvailable(): boolean {\n        return isSTAvailable();\n    }\n}\n\nexport default MessageService;\n"],"names":["TavernEventType","getEventSource","SillyTavern","context","EventBus","event","callback","eventSource","wrappedCallback","args","_a","callbacks","__publicField","convertMessage","msg","index","role","MessageService","options","getSTContext","messages","m","roles","count","start","end","format","isSTAvailable"],"mappings":"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"}