# Changelog


## [1.2.10] - 2026-02-10

### 🐛 Bug 修复 (Bug Fixes)
- **世界书过滤系统修复**:
  - **模板绑定修复**: 修复 `FetchContext` 变量名错误，导致绑定到 Prompt Template 的世界书无法被正确识别和加载的问题【CRITICAL】。
  - **强制加载逻辑**: 为绑定世界书添加 `forceInclude` 机制，确保即使全局禁用也能正确加载（同时仍遵循条目级黑名单）。
  - **过滤逻辑修正**: 修复 `crud.ts` 未填充 `world` 属性导致所有世界书过滤失效的问题。
  - **名称过滤优化**: 移除对 `---` 和 `格式` 开头世界书的硬编码过滤，避免误伤用户内容。
  - **常数检测增强**: 优化 "Constant" 条目检测逻辑，支持多种策略定义格式。
- **实体提取 UX 优化**:
  - **双重弹窗修复**: 修复配置面板 (`EntityConfigPanel`) 重复调用工作流导致出现两次预览弹窗和两次保存的问题。
  - **样式溢出修复**: 修复实体审查界面 (`EntityReview`) JSON 编辑器在内容过长时撑开页面的问题，添加横向滚动支持。
- **上下文范围优化**:
  - **提取范围调整**: 实体提取现在统一使用 `[上次总结楼层 + 1, 当前楼层]` (上限50层) 作为上下文范围，确保 LLM 获得更完整的对话语境。

## [1.2.9] - 2026-02-09

### 🐛 Bug 修复 (Bug Fixes)

- **`{{engramEntityStates}}` 宏注入修复**: 修复实体提取流程中 `{{engramEntityStates}}` 宏未被替换的问题
  - 在 `FetchContext.ts` 中添加实体状态数据获取
  - 在 `BuildPrompt.ts` 中添加宏映射，确保实体状态正确注入到提示词

### ✨ 改进 (Improvements)

- **事件摘要格式优化**: 调整 Burn 格式，更紧凑、语义化
  - 新格式: `标题(因果链 | 逻辑标签):\n(时间 | 地点 | 人物) 摘要内容`
  - 移除冗余的 `[逻辑: ...]` `[因果: ...]` 后缀标签，减少向量化噪音和 Token 消耗
- **因果链语义化**: `causality` 字段从固定枚举 `Start|Chain|End` 改为 AI 自由生成的语义化描述
  - 支持：开端、转折、高潮、收束、伏笔、承接、回响 等自然语言描述
  - 更利于嵌入式理解和 RAG 召回

## [1.2.8] - 2026-02-07

### 世界书系统优化
现在可以在提示词模板里面选择绑定在该模板上的世界书作为附加知识库。
比如你可以自己写一个角色服装预处理来给角色添加更多样，更详细的服装描写。
同时把一些衣物有关的知识库与它绑定。

## [1.2.7] - 2026-02-06

### 🐛 Bug 修复 (Bug Fixes)

- **SaveEntity 路径匹配修复**: 移除 `encodeURIComponent`，修复中文实体名 JSON Patch 路径不匹配导致的 `Patch failed` 问题
- **EventTrimmer 事件计数修复**: `canTrim()` 和 `getStatus()` 现在使用 `activeEventCount`（只统计活跃事件），修复了精简后"待合并条目不减少"的问题
- **entity_extraction.yaml 示例修正**: 将旧版截断示例替换为符合 RFC 6902 JSON Patch 规范的完整示例

### ✨ 新功能 (New Features)

- **自动精简联动触发**: 在 `Summarizer.triggerSummary()` 完成后自动检查精简阈值，如果精简已启用且达到条件则联动触发精简

### 🔧 改进 (Improvements)

- **UserReview 调试日志**: 添加 `previewEnabled` 调试日志，便于排查预览窗口不弹出的问题

